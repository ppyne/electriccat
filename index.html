<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="pinterest" content="nopin" />
<title>Electric Cat</title>
<link rel="icon" type="image/gif" href="images/icon_pomme.gif" />
<link rel="stylesheet" href="styles/fonts.css">
<link rel="stylesheet" href="styles/main.css">
<link rel="stylesheet" href="styles/menu.css">
<link rel="stylesheet" href="styles/bars.css">
<script src="scripts/jquery-3.1.0.min.js"></script>
<script src="imagick.js"></script>
<script src="im.js"></script>
<script src="scripts/grafi-despeckle.js"></script>
<script src="scripts/grafi.js"></script>
<script src="scripts/filters.js"></script>
<script src="scripts/glfx.js"></script>
<script src="scripts/imagefilters.js"></script>
<script src="scripts/phg1024filter.js"></script>
<script src="scripts/menu.js"></script>
<script src="scripts/barLevel.js"></script>
<script src="scripts/barSimple.js"></script>
<script src="scripts/barInput.js"></script>
<script src="scripts/dialog.js"></script>
<script src="scripts/messageBox.js"></script>
<script src="pako/dist/pako_deflate.min.js"></script>
<script src="scripts/png.js"></script>
<script src="FileSaver/FileSaver.min.js"></script>
<script src="scripts/palettes.js"></script>
<script src="scripts/rgbquant.js"></script>
<script src="scripts/core.js"></script>
<script src="scripts/selection.js"></script>
<script src="scripts/nub.js"></script>
<script src="d3/d3.min.js"></script>
<script src="scripts/curves.js"></script>
<script>

let working = async (cb) => {
    if (cb.constructor.name === 'AsyncFunction') {
        $('body').addClass('working');
        setTimeout(async () => {
            await cb();
            $('body').removeClass('working');
        }, 100);
    } else console.error('Working callback must be an async function.');
};

Error.stackTraceLimit=Infinity;

class CContext {
    constructor(depth, name, type, colors) {
        if (typeof depth !== 'undefined') this.Depth = depth;
        else this.Depth = 'RGB';
        if (typeof name !== 'undefined') this.Name = name;
        else this.Name = 'unknown';
        if (typeof type !== 'undefined') this.Type = type;
        else this.Type = 'image/png';
        if (typeof colors !== 'undefined') this.Colors = colors;
        else this.Colors = {grayscale: false, count: 0, palette: []};
    }
    changeDepth(depth) {
        this.Depth = depth;
        var self = this;
        $('.layer').show({duration:0, complete: function () {
            self.Colors = analyseColors();
            updateMenuMode();
            $('.layer').hide();
        }});
    }
    clone() {
        return new CContext(this.Depth, this.Name, this.Type, this.Colors);
    }
}

class CState {
    constructor() {
        this.MaxStates = 20;
        this.States = new Array();
    }
    save(caption) {
        var src = $('#src').attr('src');
        if (typeof src !== 'undefined' && src.length > 0) {
            if (typeof caption === 'undefined') caption = '';
            this.States.push({image: src, context: Context.clone(), caption: caption});
            if (this.States.length > this.MaxStates) this.States.shift();
            if (this.States.length == 1) $('#miundo').removeClass('disabled');
            $('#miundo').html('Undo '+caption);
        }
    }
    restore() {
        if (this.States.length > 0) {
            var state = this.States.pop()
            $('#src').attr('src', state.image);
            Context = state.context;
            enableMenusOnOpen();
            if (this.States.length == 0) {
                $('#miundo').addClass('disabled');
                $('#miundo').html('Undo');
            } else {
                $('#miundo').html('Undo '+this.States[this.States.length-1].caption);
            }
        }
    }
    reset() {
        this.States = new Array();
        $('#miundo').addClass('disabled');
        $('#miundo').html('Undo');
    }
}

var Context = new CContext();
var State = new CState();

const ZOOMS = [
        0.001, 0.002, 0.003, 0.004, 0.005, 0.0075,
        0.01, 0.015, 0.02, 0.03, 0.04, 0.05, 0.0625, 1.0 / 12.0 /* 0.08333... */,
        0.125, 1.0 / 6.0 /* 0.1666... */, 0.25, 1.0 / 3.0 /* 0.333... */, 0.5, 2.0 / 3.0 /* 0.666... */, 
        1.0, 1.5, 2.0, 3.0, 4.0, 5.0, 6.0, 8.0, 12.0, 16.0, 32.0, 64.0, 128.0
];

let saveCurrentZoom = () => {
    let $zoom = $('#zoom');
    $zoom.data('saved', $zoom.val());
};

let restoreSavedZoom = () => {
    let $zoom = $('#zoom');
    $zoom.val($zoom.data('saved'));
    setZoom($('#src'));
    setZoom($('#dst'));
};

let zoomFitsWorkArea = () => {
    let $viewport = $('#workingarea');
    let vw = $viewport.width();
    let vh = $viewport.height();
    let $container = $('#src');
    let cw = $container.width();
    let ch = $container.height();
    if (cw > vw || ch > vh) return false;
    else if (cw < 16 || ch < 16) return false;
    return true;
};

let zoomFitToWorkArea = () => {
    let $viewport = $('#workingarea');
    let vw = $viewport.width();
    let vh = $viewport.height();
    let $container = $('#src');
    let cw = $container.get(0).width;
    let ch = $container.get(0).height;
    let Z = 0;
    let exceeded = false;
    for (zoom of ZOOMS) {
        w = cw * zoom;
        h = ch * zoom;
        if (w > vw || h > vh) {
            exceeded = true;
            break;
        }
        Z++;
    }
    let r = 1.0;
    if (Z === 0 || (Z === ZOOMS.length - 1 && !exceeded)) r = ZOOMS[Z];
    else r = ZOOMS[Z-1];
    setZoom($('#src'), r);
    setZoom($('#dst'), r);
    $('#zoom').val(r);
};

let setZoom = ($selector, r) => {
    if (r === undefined) r = $('#zoom').val();
    if (r < 1.0) $selector.css('image-rendering', 'auto');
    else $selector.css('image-rendering', 'pixelated');
    $selector.css('transform', 'scale('+r+')');
};

let resetZoom = () => {
    $zoom = $('#zoom');
    $zoom.val($('option.nozoom', $zoom).val());
    setZoom($('#src'));
    setZoom($('#dst'));
};

let coordToImage = (coord) => {

    let r = parseFloat($('#zoom').val());
    return Math.round(coord / r);
};

let imageToCoord = (coord) => {

let r = parseFloat($('#zoom').val());
return Math.round(coord * r);
};

let removeTrailingZeros = (str) => {
    return str.replace(/0+$/, '').replace(/\.$/, '');
};

let disableRidiculousZoomLevels = () => {
    let w = $('#src').get(0).width;
    let h = $('#src').get(0).height;
    const min = 16;
    options = $('#zoom option');
    for (let i = 0; i < ZOOMS.length; i++) {
        if (ZOOMS[i] < 1) {
            let zw = Math.round(w * ZOOMS[i]);
            let zh = Math.round(h * ZOOMS[i]);
            if (zw < min || zh < min) $(options[i]).prop('disabled', true);
            else $(options[i]).prop('disabled', false);
        } else break;
    }
}

$(() => {
    for (let zoom of ZOOMS) {
        let $option = $('<option />');
        $option.val(zoom);
        $option.text(removeTrailingZeros((zoom*100.0).toFixed(3))+'%');
        if (zoom === 1.0) {
            $option.prop('selected', true);
            $option.addClass('nozoom');
        }
        $('#zoom').append($option);
    }
    $('#zoom').on('change', () => {
        let r = $('#zoom').val();
        setZoom($('#src'));
        setZoom($('#dst'));
    });
    $('#zoom100Button').on('click', resetZoom);
    $('#fitButton').on('click', zoomFitToWorkArea);
});

function b64toBlob(b64Data, contentType, sliceSize) {
  contentType = contentType || '';
  sliceSize = sliceSize || 512;

  var byteCharacters = atob(b64Data);
  var byteArrays = [];

  for (var offset = 0; offset < byteCharacters.length; offset += sliceSize) {
    var slice = byteCharacters.slice(offset, offset + sliceSize);

    var byteNumbers = new Array(slice.length);
    for (var i = 0; i < slice.length; i++) {
      byteNumbers[i] = slice.charCodeAt(i);
    }

    var byteArray = new Uint8Array(byteNumbers);

    byteArrays.push(byteArray);
  }

  var blob = new Blob(byteArrays, {type: contentType});
  return blob;
}

function urlToB64(src) {
    var b64 = src.replace(/^data:image\/[a-z]+;base64,/, "");
    var res = src.match(/^data:(image\/[a-z]+);base64,/);
    var mime = res[1];
    return {Mime: mime, Base64: b64};
}

function analyseColors() {
    var info = {};
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) {
        console.log('image not ready to be analyzed...');
        return null;
    }
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    info.grayscale = true;
    info.bitmap = false;
    info.alpha = false;
    var uniqcols = {};
    for (var cp = 0; cp < imageData.data.length; cp+=4) {
        var i = (imageData.data[cp] << 16) + (imageData.data[cp+1] << 8) + imageData.data[cp+2];
        uniqcols[i] = 1 + (uniqcols[i] || 0);
        if (info.grayscale && !(imageData.data[cp] == imageData.data[cp+1] && imageData.data[cp] == imageData.data[cp+2])) info.grayscale = false;
        if (!info.alpha && imageData.data[cp+3] < 255) info.alpha = true;
    }
    info.count = Object.keys(uniqcols).length;
    if (info.count == 2 && info.grayscale == true) {
        if ((uniqcols[0] == 0 || uniqcols[0] == 16777215) && (uniqcols[1] == 0 || uniqcols[1] == 16777215) && uniqcols[0] != uniqcols[1]) {
            info.bitmap = true;
            info.grayscale = false;
        }
    }
    //console.log(info);
    return info;
}

//https://github.com/imaya/zlib.js/blob/master/README.en.md
// https://github.com/IjzerenHein/pnglib-es6/blob/master/src/pnglib-es6.js
function toBitmapPNG() {
    var bitmap = [];
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    var row = [];
    var wi = 0;
    for (var cp = 0; cp < imageData.data.length; cp+=4) {
        if (imageData.data[cp] == 0) row.push(0);
        else row.push(1);
        wi++;
        if (wi >= canvas.width) {
            wi=0;
            bitmap.push(row);
            row = [];
        }
    }
    var png = new CPNGImage();
    png.header(canvas.width, canvas.height, 1, 0);
    //png.palette([[0,0,0], [255,255,255]]);
    png.data(bitmap)
    return png.blob();
}

function toGrayscalePNG() {
    var grayscale = [];
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    var depth = 8;
    /*var rdepth = 1.0;
    if (Context.Colors.count <= 2) {
        depth = 1;
        rdepth = 0.003921568627451;
    } else if (Context.Colors.count <= 4) {
        depth = 2;
        rdepth = 0.011764705882353;
    } else if (Context.Colors.count <= 16) {
        depth = 4;
        rdepth = 0.058823529411765;
    }*/
    var row = [];
    var wi = 0;
    for (var cp = 0; cp < imageData.data.length; cp+=4) {
        row.push(imageData.data[cp]);
        wi++;
        if (wi >= canvas.width) {
            wi=0;
            grayscale.push(row);
            row = [];
        }
    }
    var png = new CPNGImage();
    png.header(canvas.width, canvas.height, depth, 0);
    png.data(grayscale)
    return png.blob();
}

function toIndexedPNG() {
    var indexed = [];
    var palette = [];
    var finalpal = [];
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    var row = [];
    var wi = 0;
    for (var cp = 0; cp < imageData.data.length; cp+=4) {
        var i = (imageData.data[cp] << 16) + (imageData.data[cp+1] << 8) + imageData.data[cp+2];
        if (palette.indexOf(i) == -1) {
            palette.push(i);
            finalpal.push([imageData.data[cp], imageData.data[cp+1], imageData.data[cp+2]]);
        }
        row.push(palette.indexOf(i));
        wi++;
        if (wi >= canvas.width) {
            wi=0;
            indexed.push(row);
            row = [];
        }
    }
    var depth = 8;
    if (finalpal.length <= 2) depth = 1;
    else if (finalpal.length <= 4) depth = 2;
    else if (finalpal.length <= 16) depth = 4;
    var png = new CPNGImage();
    png.header(canvas.width, canvas.height, depth, 3);
    png.palette(finalpal);
    png.data(indexed)
    return png.blob();
}

function handleFileSelect(evt) {
    evt.stopPropagation();
    evt.preventDefault();
    var files = evt.dataTransfer.files;
    for (var i = 0, f; f = files[i]; i++) {
        if (f.type.match(/^image\/(jpg|jpeg|png|webp|gif)/)) {
            var reader = new FileReader();
            reader.onload = (function(theFile) {
                return function(e) {
                    makeOpen(e.target.result, theFile.name, theFile.type);
                };
            })(f);
            reader.readAsDataURL(f);
        } else {
            //alert('Only PNG, JPEG, WEBP and GIF are handled.');
            $('#mb_unsupported').messageBox('open');
        }
    }
}

function handleDragOver(evt) {
    evt.stopPropagation();
    evt.preventDefault();
    evt.dataTransfer.dropEffect = 'copy';
}

function makeGrayscale(img) {
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    ctx.putImageData(grayScale(imageData), 0, 0);
    State.save("Grayscale");
    $('#src').attr('src', canvas.toDataURL('image/png'));
    Context.changeDepth('Grayscale');
}

function makeRGB() {
    State.save("RGB");
    Context.changeDepth('RGB');
}

function makeInvert() {
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    ctx.putImageData(invert(imageData), 0, 0);
    State.save("Invert");
    $('#src').attr('src', canvas.toDataURL('image/png'));
}

function makeSobel() {
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    ctx.putImageData(Filters.sobel(imageData), 0, 0);
    State.save("Find Edge");
    $('#src').attr('src', canvas.toDataURL('image/png'));
}

function makeSobelIM() {
    IMSobel($('#src'), $('#dst'));
    makeOk('Find Edge IM');
}

function makeLaplace() {
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    ctx.putImageData(Filters.laplace(imageData), 0, 0);
    State.save("Trace Contour");
    $('#src').attr('src', canvas.toDataURL('image/png'));
}

function makeStretch() {
    State.save("Auto Levels");
    IMAutoLevel($('#src'), $('#src'));
}

function makeAutoGamma() {
    State.save("Auto Gamma");
    IMCmdAutoGamma($('#src'), $('#src'));
}

function makeEqualize() {
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    ctx.putImageData(equalize(imageData), 0, 0);
    State.save("Equalize");
    $('#src').attr('src', canvas.toDataURL('image/png'));
}

function makeAutoContrast() {
    State.save("Auto Contrast");
    IMContrast($('#src'), $('#src'));
}

function makeNormalize() {
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    ctx.putImageData(normalize(imageData), 0, 0);
    State.save("Normalize");
    $('#src').attr('src', canvas.toDataURL('image/png'));
}

function makeBlurMore() {
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    ctx.putImageData(blurMore(imageData), 0, 0);
    State.save("Blur More");
    $('#src').attr('src', canvas.toDataURL('image/png'));
}

function makeBlur() {
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    ctx.putImageData(blur(imageData), 0, 0);
    State.save("Blur");
    $('#src').attr('src', canvas.toDataURL('image/png'));
}

function makeEmbossMediumGray() {
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    ctx.putImageData(embossMediumGray(imageData), 0, 0);
    State.save("Emboss Medium Gray");
    $('#src').attr('src', canvas.toDataURL('image/png'));
}

function makeEmboss() {
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    ctx.putImageData(emboss(imageData), 0, 0);
    State.save("Emboss");
    $('#src').attr('src', canvas.toDataURL('image/png'));
}

function makeSharpen() {
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    ctx.putImageData(grafi.sharpen(imageData, {level: 0.25}), 0, 0);
    State.save("Sharpen");
    $('#src').attr('src', canvas.toDataURL('image/png'));
}

function makeSharpenMore() {
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    ctx.putImageData(sharpen(imageData), 0, 0);
    State.save("Sharpen More");
    $('#src').attr('src', canvas.toDataURL('image/png'));
}

function makeSolarize() {
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    ctx.putImageData(grafi.solarize(imageData), 0, 0);
    State.save("Solarize");
    $('#src').attr('src', canvas.toDataURL('image/png'));
}

function makePseudocolor() {
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    ctx.putImageData(grafi.pseudocolor(imageData), 0, 0);
    State.save("Pseudocolor");
    $('#src').attr('src', canvas.toDataURL('image/png'));
}

let makeDespeckle = async () => {
    await working(async () => {
        var img = $('#src').get(0);
        if (img.width == 0 || img.height == 0) return null;
        var canvas = document.createElement("canvas");
        canvas.width = img.width;
        canvas.height = img.height;
        var ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);
        var imageData = ctx.getImageData(0,0,img.width, img.height);
        ctx.putImageData(despeckle(imageData), 0, 0);
        State.save("Despeckle");
        $('#src').attr('src', canvas.toDataURL('image/png'));
        $('body').removeClass('working');
    });
};

function makeFlipHorizontal() {
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.translate(canvas.width/2,canvas.height/2);
    ctx.scale(-1, 1);
    ctx.drawImage(img, -img.width/2,-img.height/2);
    State.save("Flip Horizontal");
    $('#src').attr('src', canvas.toDataURL('image/png'));
}

function makeFlipVertical() {
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.translate(canvas.width/2,canvas.height/2);
    ctx.scale(1, -1);
    ctx.drawImage(img, -img.width/2,-img.height/2);
    State.save("Flip Vertical");
    $('#src').attr('src', canvas.toDataURL('image/png'));
}

function makeRotate180() {
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.translate(canvas.width/2,canvas.height/2);
    ctx.rotate(180 * Math.PI / 180);
    ctx.drawImage(img, -img.width/2,-img.height/2);
    State.save("Rotate 180°");
    $('#src').attr('src', canvas.toDataURL('image/png'));
}

function makeRotate90CW() {
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.height;
    canvas.height = img.width;
    var ctx = canvas.getContext("2d");
    ctx.translate(canvas.width/2,canvas.height/2);
    ctx.rotate(90 * Math.PI / 180);
    ctx.drawImage(img, -img.width/2,-img.height/2);
    State.save("Rotate 90° CW");
    $('#src').attr('src', canvas.toDataURL('image/png'));
    updateStatusBarDimensions();
}

function makeRotate90CCW() {
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.height;
    canvas.height = img.width;
    var ctx = canvas.getContext("2d");
    ctx.translate(canvas.width/2,canvas.height/2);
    ctx.rotate(-90 * Math.PI / 180);
    ctx.drawImage(img, -img.width/2,-img.height/2);
    State.save("Rotate 90° CCW");
    $('#src').attr('src', canvas.toDataURL('image/png'));
    updateStatusBarDimensions();
}

function makeRotate(deg) {
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var destdims = findBoundarySizeOfRotatedRect(img.width, img.height, deg);
    var canvas = document.createElement("canvas");
    canvas.width = destdims.width;
    canvas.height = destdims.height;
    var ctx = canvas.getContext("2d");
    ctx.translate(canvas.width/2,canvas.height/2);
    ctx.rotate(deg * Math.PI / 180);
    ctx.drawImage(img, -img.width/2,-img.height/2);
    return canvas.toDataURL('image/png');
}

function makeCancel() {
    $('#dst').remove();
    $dst = $('<img id="dst" />');
    $('#containment').append($dst);
    setZoom($dst);
}

function updateMenuMode(closing) {
    if (typeof closing === 'undefined') closing = false;
    $('#menumode .subitem').addClass('disabled');
    //console.log($('#menumode .subitem'));
    $('#menumode .subitem').removeClass('checked');
    if (closing === false) {
      if (Context.Depth === 'RGB') {
          $('#mirgb').addClass('checked');
          $('#mirgb').removeClass('disabled');
          $('#migrayscale').removeClass('disabled');
          $('#miindexed').removeClass('disabled');
          $('#mibitmap').removeClass('disabled');
      } else if (Context.Depth === 'Grayscale') {
          $('#mirgb').removeClass('disabled');
          $('#migrayscale').removeClass('disabled');
          $('#migrayscale').addClass('checked');
          $('#miindexed').removeClass('disabled');
          $('#mibitmap').removeClass('disabled');
      } else if (Context.Depth === 'Indexed') {
          $('#mirgb').removeClass('disabled');
          $('#migrayscale').removeClass('disabled');
          $('#miindexed').removeClass('disabled');
          $('#miindexed').addClass('checked');
          $('#mibitmap').addClass('disabled');
      } else if (Context.Depth === 'Bitmap') {
          $('#mirgb').addClass('disabled');
          $('#migrayscale').removeClass('disabled');
          $('#miindexed').addClass('disabled');
          $('#mibitmap').removeClass('disabled');
          $('#mibitmap').addClass('checked');
      }
    } else $('#mirgb').addClass('checked');
}

function enableMenusOnOpen() {
    $('#miclose').removeClass('disabled');
    $('#misave').removeClass('disabled');
    $('#milevels').removeClass('disabled');
    $('#miinvert').removeClass('disabled');
    $('#mifliphorizontal').removeClass('disabled');
    $('#miflipvertical').removeClass('disabled');
    $('#mirotate180').removeClass('disabled');
    $('#mirotate90CW').removeClass('disabled');
    $('#mirotate90CCW').removeClass('disabled');
    $('#mihuesaturation').removeClass('disabled');
    $('#mibrightnesscontrast').removeClass('disabled');
    $('#misigmoidalcontrast').removeClass('disabled');
    $('#michannelmixer').removeClass('disabled');
    $('#miposterize').removeClass('disabled');
    $('#mithreshold').removeClass('disabled');
    $('#midesaturate').removeClass('disabled');
    $('#miblur').removeClass('disabled');
    $('#miblurmore').removeClass('disabled');
    $('#misharpen').removeClass('disabled');
    $('#misharpenmore').removeClass('disabled');
    $('#misolarize').removeClass('disabled');
    $('#mipseudocolor').removeClass('disabled');
    $('#miarbitraryrotation').removeClass('disabled');
    $('#miresize').removeClass('disabled');
    $('#microp').removeClass('disabled');
    $('#miequalize').removeClass('disabled');
    $('#minormalize').removeClass('disabled');
    $('#mistretch').removeClass('disabled');
    $('#miautogamma').removeClass('disabled');
    $('#mihistogram').removeClass('disabled');
    $('#mipixelate').removeClass('disabled');
    $('#mimedian').removeClass('disabled');
    $('#migaussian').removeClass('disabled');
    $('#misobel').removeClass('disabled');
    $('#milaplace').removeClass('disabled');
    $('#midistorsine').removeClass('disabled');
    $('#minoise').removeClass('disabled');
    $('#midespeckle').removeClass('disabled');
    $('#miboxblur').removeClass('disabled');
    $('#miemboss').removeClass('disabled');
    $('#miembossmediumgray').removeClass('disabled');
    $('#miunsharpmask').removeClass('disabled');
    $('#midiffgauss').removeClass('disabled');
    $('#miautocontrast').removeClass('disabled');
    $('#micolorbalance').removeClass('disabled');
    $('#mipinch').removeClass('disabled');
    $('#mizoom').removeClass('disabled');
    $('#mitwirl').removeClass('disabled');
    $('#mihalftone').removeClass('disabled');
    $('#milensblur').removeClass('disabled');
    $('#mitriangleblur').removeClass('disabled');
    $('#mivibrance').removeClass('disabled');
    $('#misepia').removeClass('disabled');
    $('#micharcoal').removeClass('disabled');
    $('#misketch').removeClass('disabled');
    $('#miink').removeClass('disabled');
    $('#miedgework').removeClass('disabled');
    $('#midenoise').removeClass('disabled');
    $('#mihexagonalpixelate').removeClass('disabled');
    $('#mivignette').removeClass('disabled');
    $('#mitiltshift').removeClass('disabled');
    $('#mioil').removeClass('disabled');
    $('#mimorphology').removeClass('disabled');
    $('#mimotionblur').removeClass('disabled');
    $('#mibilateral').removeClass('disabled');
    $('#mibilateral2').removeClass('disabled');
    $('#mierosion').removeClass('disabled');
    $('#midialation').removeClass('disabled');
    $('#micurves').removeClass('disabled');
    $('#miphotofilter').removeClass('disabled');
    $('#miexposure').removeClass('disabled');
    $('#miglow').removeClass('disabled');
    $('#misobelim').removeClass('disabled');
    $('#miwatercolor').removeClass('disabled');
    $('#midisperse').removeClass('disabled');
    $('#micrystallize').removeClass('disabled');
    $('#misoftlight').removeClass('disabled');
    $('#midavehilleffect').removeClass('disabled');
    $('#mifrosted').removeClass('disabled');
    $('#milucisarteffect').removeClass('disabled');
    $('#mishadowhighlight').removeClass('disabled');
    $('#micopy').removeClass('disabled');
    $('#miexporttopng').removeClass('disabled');
    $('#miexporttojpeg').removeClass('disabled');
    $('#miexporttowebp').removeClass('disabled');
    updateMenuMode();
}

function disableMenusOnClose() {
    $('#miclose').addClass('disabled');
    $('#misave').addClass('disabled');
    $('#milevels').addClass('disabled');
    $('#miinvert').addClass('disabled');
    $('#mifliphorizontal').addClass('disabled');
    $('#miflipvertical').addClass('disabled');
    $('#mirotate180').addClass('disabled');
    $('#mirotate90CW').addClass('disabled');
    $('#mirotate90CCW').addClass('disabled');
    $('#mihuesaturation').addClass('disabled');
    $('#mibrightnesscontrast').addClass('disabled');
    $('#misigmoidalcontrast').addClass('disabled');
    $('#michannelmixer').addClass('disabled');
    $('#miposterize').addClass('disabled');
    $('#mithreshold').addClass('disabled');
    $('#midesaturate').addClass('disabled');
    $('#miblur').addClass('disabled');
    $('#miblurmore').addClass('disabled');
    $('#misharpen').addClass('disabled');
    $('#misharpenmore').addClass('disabled');
    $('#misolarize').addClass('disabled');
    $('#mipseudocolor').addClass('disabled');
    $('#miarbitraryrotation').addClass('disabled');
    $('#miresize').addClass('disabled');
    $('#microp').addClass('disabled');
    $('#miequalize').addClass('disabled');
    $('#minormalize').addClass('disabled');
    $('#mistretch').addClass('disabled');
    $('#miautogamma').addClass('disabled');
    $('#mihistogram').addClass('disabled');
    $('#mipixelate').addClass('disabled');
    $('#mimedian').addClass('disabled');
    $('#migaussian').addClass('disabled');
    $('#misobel').addClass('disabled');
    $('#milaplace').addClass('disabled');
    $('#midistorsine').addClass('disabled');
    $('#minoise').addClass('disabled');
    $('#midespeckle').addClass('disabled');
    $('#miboxblur').addClass('disabled');
    $('#miemboss').addClass('disabled');
    $('#miembossmediumgray').addClass('disabled');
    $('#miunsharpmask').addClass('disabled');
    $('#midiffgauss').addClass('disabled');
    $('#miautocontrast').addClass('disabled');
    $('#micolorbalance').addClass('disabled');
    $('#mipinch').addClass('disabled');
    $('#mizoom').addClass('disabled');
    $('#mitwirl').addClass('disabled');
    $('#mihalftone').addClass('disabled');
    $('#milensblur').addClass('disabled');
    $('#mitriangleblur').addClass('disabled');
    $('#mivibrance').addClass('disabled');
    $('#misepia').addClass('disabled');
    $('#micharcoal').addClass('disabled');
    $('#misketch').addClass('disabled');
    $('#miink').addClass('disabled');
    $('#miedgework').addClass('disabled');
    $('#midenoise').addClass('disabled');
    $('#mihexagonalpixelate').addClass('disabled');
    $('#mivignette').addClass('disabled');
    $('#mitiltshift').addClass('disabled');
    $('#mioil').addClass('disabled');
    $('#mimorphology').addClass('disabled');
    $('#mimotionblur').addClass('disabled');
    $('#mibilateral').addClass('disabled');
    $('#mibilateral2').addClass('disabled');
    $('#mierosion').addClass('disabled');
    $('#midialation').addClass('disabled');
    $('#micurves').addClass('disabled');
    $('#miphotofilter').addClass('disabled');
    $('#miexposure').addClass('disabled');
    $('#miglow').addClass('disabled');
    $('#misobelim').addClass('disabled');
    $('#miwatercolor').addClass('disabled');
    $('#midisperse').addClass('disabled');
    $('#micrystallize').addClass('disabled');
    $('#misoftlight').addClass('disabled');
    $('#midavehilleffect').addClass('disabled');
    $('#mifrosted').addClass('disabled');
    $('#milucisarteffect').addClass('disabled');
    $('#mishadowhighlight').addClass('disabled');
    $('#micopy').addClass('disabled');
    $('#miexporttopng').addClass('disabled');
    $('#miexporttojpeg').addClass('disabled');
    $('#miexporttowebp').addClass('disabled');
    updateMenuMode(true);
}

function makeOpenFile() {
  var file = document.querySelector('#fileinput').files[0];
  if (typeof file != 'undefined') {
      if (file.type.match(/^image\/(jpg|jpeg|webp|png|gif)/)) {
            var reader = new FileReader();
            reader.addEventListener("load", function () {
                makeOpen(reader.result, file.name, file.type);
            }, false);
            reader.readAsDataURL(file);
      } else {
            //alert('Only PNG, JPEG, WEBP and GIF are handled.');
            $('#mb_unsupported').messageBox('open');
      }
  }
}

let exportToJpeg = async () => {
    toUrlType($('#src').attr('src'), 'image/jpeg', parseFloat($('#ExportToJpeg_quality input').val()) / 100.0).then((url) => {
        let data = urlToB64(url);
        let blob = b64toBlob(data.Base64, data.Mime);
        let name = $('#ExportToJpeg_name').val().trim();
        if (name === '') name = 'exported';
        name += '.jpg';
        saveAs(blob, name);
    });
}

let exportToWebp = async () => {
    toUrlType($('#src').attr('src'), 'image/webp', parseFloat($('#ExportToWebp_quality input').val()) / 100.0).then((url) => {
        let data = urlToB64(url);
        let blob = b64toBlob(data.Base64, data.Mime);
        let name = $('#ExportToWebp_name').val().trim();
        if (name === '') name = 'exported';
        name += '.webp';
        saveAs(blob, name);
    });
}

let exportToPng = async () => {
    toUrlType($('#src').attr('src'), 'image/png').then((url) => {
        let data = urlToB64(url);
        let blob = b64toBlob(data.Base64, data.Mime);
        let name = $('#ExportToPng_name').val().trim();
        if (name === '') name = 'exported';
        name += '.png';
        saveAs(blob, name);
    });
}

let toUrlType = async (src, type, encoderOptions) => {
    return new Promise((resolve, reject) => {
        let img = new Image();
        img.onload = () => {
            let canvas = document.createElement("canvas");
            canvas.width = img.width;
            canvas.height = img.height;
            let ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0);
            resolve(canvas.toDataURL(type, encoderOptions));
        };
        img.onerror = () => {
            reject('Error while converting to ' + type + ' URL');
        };
        img.src = src;
    });
}

let toPng = async (src) => {
    return new Promise((resolve, reject) => {
        let img = new Image();
        img.onload = () => {
            let canvas = document.createElement("canvas");
            canvas.width = img.width;
            canvas.height = img.height;
            let ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0);
            resolve(canvas.toDataURL('image/png'));
        };
        img.onerror = () => {
            reject('Error while converting to PNG URL');
        };
        img.src = src;
    });
};

let makeOpen = async (src, name, type) => {
    if (src.length > 0) {
        // Ensure we always have a PNG
        if (type !== 'image/png') src = await toPng(src);
        resetZoom();
        State.save("Open");
        $('#src').off('load');
        $('#src').removeAttr('src');
        $('#src').on('load', () => {
            var dep = 'RGB';
            var info = analyseColors();
            if (info.grayscale) dep = 'Grayscale';
            else if (info.count <= 256) {
                if (info.bitmap) {
                    dep = 'Bitmap';
                } else {
                    dep = 'Indexed';
                }
            }
            Context = new CContext(dep, name, type, info);
            enableMenusOnOpen();
            disableRidiculousZoomLevels();
            $('#statusbar .zoomtools').show();
            updateStatusBarDimensions();
            $('#statusbar .dimensions').show();
            $('#src').off('load');
            $('#src').on('load', updateStatusBarDimensions);
        });
        $('#src').attr('src', src);
    }
}

let makePaste = async (event) => {
    if (navigator.clipboard) {
        let items = await navigator.clipboard.read();
        for (const item of items) {
            if (item.types.includes('image/png')) {
                const blob = await item.getType('image/png');
                // Blob to png type URL
                var image = new Image();
                $(image).on('load', () => {
                    let canvas = document.createElement("canvas");
                    canvas.width = image.width;
                    canvas.height = image.height;
                    let ctx = canvas.getContext("2d");
                    ctx.drawImage(image, 0, 0);
                    makeOpen(canvas.toDataURL('image/png'), 'Pasted', 'image/png');
                });
                image.src = URL.createObjectURL(blob);
                break;
            }
        }
    }
    if (typeof event !== 'undefined') event.preventDefault();
};

let makeCopy = (event) => {
    if (navigator.clipboard) {
        let url = $('#src').attr('src');
        if (url !== undefined) {
            let data = urlToB64(url);
            let blob = b64toBlob(data.Base64, data.Mime);
            const items = [new ClipboardItem({ [data.Mime]: blob })];
            navigator.clipboard.write(items);
        }
    }
    if (typeof event !== 'undefined') event.preventDefault();
};

$(() => {
    $(document).on('paste', makePaste);
    $(document).on('copy', makeCopy);
});

function updateStatusBarDimensions() {
    $('.dimensions').text('Dimensions: '+$('#src').get(0).width+'px × '+$('#src').get(0).height+'px');
}

function makeClose() {
    $('#src').remove();
    $('#containment').append('<img id="src">');
    disableMenusOnClose();
    State.reset();
    $('#statusbar .zoomtools').hide();
    $('#statusbar .dimensions').hide();
}

function makeSave() {
    const urlSearchParams = new URLSearchParams(window.location.search);
    const params = Object.fromEntries(urlSearchParams.entries());
    if (params?.path !== undefined && params?.mimetype !== undefined && params?.id !== undefined) {
        if (['image/png', 'image/jpeg'].includes(params.mimetype)) {
            var img = $('#src').get(0);
            var canvas = document.createElement("canvas");
            canvas.width = img.width;
            canvas.height = img.height;
            var ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0);
            let urlData;
            if (params.mimetype === 'image/jpeg') urlData = canvas.toDataURL('image/jpeg', 0.8);
            else urlData = canvas.toDataURL('image/png');
            let data = urlToB64(urlData);
            let blob = b64toBlob(data.Base64, data.Mime);
            console.log('blob.size', blob.size);

            var fd = new FormData();
            fd.append('id', params.id);
            fd.append('width', img.width);
            fd.append('height', img.height);
            fd.append('data', blob);
            $.ajax({
                type: 'POST',
                url: params.path,
                data: fd,
                processData: false,
                contentType: false
            }).done(function(data) {
                console.log('broadcasting', data);
                window.broadcastChannel.postMessage(data);
            }).fail((data) => {
                console.log('save fail', data);
            });
        } else {
            $('#mb_saveUnsupportedFormat').messageBox('open');
        }
    } else {
        var url = '';
        var data = {
            Mime: 'image/png',
            Base64: ''
        };
        var blob = null;
        if (Context.Depth == 'Bitmap') {
            blob = toBitmapPNG();
        } else if (Context.Depth == 'Indexed') {
            blob = toIndexedPNG();
        } else if (Context.Depth == 'Grayscale') {
            blob = toGrayscalePNG();
        } else {
            url = $('#src').attr('src');
            data = urlToB64(url);
            blob = b64toBlob(data.Base64, data.Mime);
        }
        
        var name = Context.Name.match(/^(.*)\./);
        var finalname = Context.Name;
        if (name !== null) {
            finalname = finalname = name[1];
        }
        if (data.Mime == 'image/png') finalname += '.png';
        else if (data.Mime == 'image/webp') finalname += '.webp';
        else if (data.Mime == 'image/jpg' | data.Mime == 'image/jpeg') finalname += '.jpg';
        else if (data.Mime == 'image/gif') finalname += '.gif';
        saveAs(blob, finalname);
    }
}

function makeOk(caption) {
    State.save(caption);
    $('#src').attr('src', $('#dst').attr('src'));
    makeCancel();
}

$(() => {
    $('#menu').Menu();
    var dropZone = $('#workingarea').get(0);
    dropZone.addEventListener('dragover', handleDragOver, false);
    dropZone.addEventListener('drop', handleFileSelect, false);
    
    $('#fileinput').change(makeOpenFile);

/*    $('#dialog_generic').Dialog({
        onInit: function() {

        },
        onClose: function() {

        },
        onOk: function() {
            $('#dst').attr('src', function () {});
            makeOk("Function");
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            $('#dst').attr('src',function () {});
        },
        onReset: function () {

        }
    });*/

    $('#dialog_levels .btn_apply').trigger('click');
    $('#dialog_monochrome .btn_apply').trigger('click');
    $('#mb_saveUnsupportedFormat').messageBox({text:'Only mime types image/jpeg and image/png are currently handled.'});
    window.broadcastChannel = new BroadcastChannel('electriccat');
});

</script>
</head>
<body class="ElectricCat">
<div id="emptylayer" class="layer"></div>
<div style="position:absolute; width:0; height:0; left:-100px; top:-100px;"><input type="file" id="fileinput"><audio id="beep"><source src="beep.mp3" type="audio/mpeg" /></audio></div>
<div id="menu"></div>
<div id="workingarea">
    <div id="mb_saveUnsupportedFormat" class="messageBox error"></div>
<script>
function makeValueHistogram(img, dst) {
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    return histogram(imageData, dst);
}
function updateHistograms() {
    var img = $('#src').get(0);
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    var hist = histogram_array(imageData, [0,1,2]);
    rgb_histogram(hist, ['#level_R_histogram', '#level_G_histogram', '#level_B_histogram'], ['#FF0000', '#00FF00', '#0000FF'], '#level_RGB_histogram', $('#level_logarithmic').is(':checked'));
}
function makeLevels(img) {
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    var configRGB = {
        Input: {
            Low: parseInt($('#level_RGB_ilow_input').val(), 10),
            High: parseInt($('#level_RGB_ihigh_input').val(), 10),
            Gamma: parseFloat($('#level_RGB_gamma_input').val())
        },
        Output: {
            Low: parseInt($('#level_RGB_olow_input').val(), 10),
            High: parseInt($('#level_RGB_ohigh_input').val(), 10)
        }
    };
    var configR = {
        Input: {
            Low: parseInt($('#level_R_ilow_input').val(), 10),
            High: parseInt($('#level_R_ihigh_input').val(), 10),
            Gamma: parseFloat($('#level_R_gamma_input').val())
        },
        Output: {
            Low: parseInt($('#level_R_olow_input').val(), 10),
            High: parseInt($('#level_R_ohigh_input').val(), 10)
        }
    };
    var configG = {
        Input: {
            Low: parseInt($('#level_G_ilow_input').val(), 10),
            High: parseInt($('#level_G_ihigh_input').val(), 10),
            Gamma: parseFloat($('#level_G_gamma_input').val())
        },
        Output: {
            Low: parseInt($('#level_G_olow_input').val(), 10),
            High: parseInt($('#level_G_ohigh_input').val(), 10)
        }
    };
    var configB = {
        Input: {
            Low: parseInt($('#level_B_ilow_input').val(), 10),
            High: parseInt($('#level_B_ihigh_input').val(), 10),
            Gamma: parseFloat($('#level_B_gamma_input').val())
        },
        Output: {
            Low: parseInt($('#level_B_olow_input').val(), 10),
            High: parseInt($('#level_B_ohigh_input').val(), 10)
        }
    };
    if (Context.Depth == 'RGB') {
        ctx.putImageData(levels_multi_channels(imageData, [configR, configG, configB]), 0, 0);
        ctx.putImageData(levels_multi_channels(imageData, [configRGB, configRGB, configRGB]), 0, 0);
    } else if (Context.Depth == 'Grayscale') ctx.putImageData(levels_multi_channels(imageData, [config]), 0, 0);
    return canvas.toDataURL('image/png');
}
$(function() {
    $('#dialog_levels').Dialog({
        onInit: function() {
            $('#level_RGB_input_bar').barLevel({InputBar: true, onDrag: function (values) {
                $('#level_RGB_ilow_input').val(values.Low);
                $('#level_RGB_gamma_input').val(values.Gamma);
                $('#level_RGB_ihigh_input').val(values.High);
            }});
            $('#level_RGB_output_bar').barLevel({onDrag: function (values) {
                $('#level_RGB_olow_input').val(values.Low);
                $('#level_RGB_ohigh_input').val(values.High);
            }});
            $('#level_RGB_ilow_input').change(function (e) {
                $('#level_RGB_input_bar').barLevel('update', {Low: $('#level_RGB_ilow_input').val()});
            });
            $('#level_RGB_ihigh_input').change(function (e) {
                $('#level_RGB_input_bar').barLevel('update', {High: $('#level_RGB_ihigh_input').val()});
            });
            $('#level_RGB_gamma_input').change(function (e) {
                $('#level_RGB_input_bar').barLevel('update', {Gamma: $('#level_RGB_gamma_input').val()});
            });
            $('#level_RGB_olow_input').change(function (e) {
                $('#level_RGB_output_bar').barLevel('update', {Low: $('#level_RGB_olow_input').val()});
            });
            $('#level_RGB_ohigh_input').change(function (e) {
                $('#level_RGB_output_bar').barLevel('update', {High: $('#level_RGB_ohigh_input').val()});
            });

            $('#level_R_input_bar').barLevel({InputBar: true, onDrag: function (values) {
                $('#level_R_ilow_input').val(values.Low);
                $('#level_R_gamma_input').val(values.Gamma);
                $('#level_R_ihigh_input').val(values.High);
            }});
            $('#level_R_output_bar').barLevel({onDrag: function (values) {
                $('#level_R_olow_input').val(values.Low);
                $('#level_R_ohigh_input').val(values.High);
            }});
            $('#level_R_ilow_input').change(function (e) {
                $('#level_R_input_bar').barLevel('update', {Low: $('#level_R_ilow_input').val()});
            });
            $('#level_R_ihigh_input').change(function (e) {
                $('#level_R_input_bar').barLevel('update', {High: $('#level_R_ihigh_input').val()});
            });
            $('#level_R_gamma_input').change(function (e) {
                $('#level_R_input_bar').barLevel('update', {Gamma: $('#level_R_gamma_input').val()});
            });
            $('#level_R_olow_input').change(function (e) {
                $('#level_R_output_bar').barLevel('update', {Low: $('#level_R_olow_input').val()});
            });
            $('#level_R_ohigh_input').change(function (e) {
                $('#level_R_output_bar').barLevel('update', {High: $('#level_R_ohigh_input').val()});
            });

            $('#level_G_input_bar').barLevel({InputBar: true, onDrag: function (values) {
                $('#level_G_ilow_input').val(values.Low);
                $('#level_G_gamma_input').val(values.Gamma);
                $('#level_G_ihigh_input').val(values.High);
            }});
            $('#level_G_output_bar').barLevel({onDrag: function (values) {
                $('#level_G_olow_input').val(values.Low);
                $('#level_G_ohigh_input').val(values.High);
            }});
            $('#level_G_ilow_input').change(function (e) {
                $('#level_G_input_bar').barLevel('update', {Low: $('#level_G_ilow_input').val()});
            });
            $('#level_G_ihigh_input').change(function (e) {
                $('#level_G_input_bar').barLevel('update', {High: $('#level_G_ihigh_input').val()});
            });
            $('#level_G_gamma_input').change(function (e) {
                $('#level_G_input_bar').barLevel('update', {Gamma: $('#level_G_gamma_input').val()});
            });
            $('#level_G_olow_input').change(function (e) {
                $('#level_G_output_bar').barLevel('update', {Low: $('#level_G_olow_input').val()});
            });
            $('#level_G_ohigh_input').change(function (e) {
                $('#level_G_output_bar').barLevel('update', {High: $('#level_G_ohigh_input').val()});
            });

            $('#level_B_input_bar').barLevel({InputBar: true, onDrag: function (values) {
                $('#level_B_ilow_input').val(values.Low);
                $('#level_B_gamma_input').val(values.Gamma);
                $('#level_B_ihigh_input').val(values.High);
            }});
            $('#level_B_output_bar').barLevel({onDrag: function (values) {
                $('#level_B_olow_input').val(values.Low);
                $('#level_B_ohigh_input').val(values.High);
            }});
            $('#level_B_ilow_input').change(function (e) {
                $('#level_B_input_bar').barLevel('update', {Low: $('#level_B_ilow_input').val()});
            });
            $('#level_B_ihigh_input').change(function (e) {
                $('#level_B_input_bar').barLevel('update', {High: $('#level_B_ihigh_input').val()});
            });
            $('#level_B_gamma_input').change(function (e) {
                $('#level_B_input_bar').barLevel('update', {Gamma: $('#level_B_gamma_input').val()});
            });
            $('#level_B_olow_input').change(function (e) {
                $('#level_B_output_bar').barLevel('update', {Low: $('#level_B_olow_input').val()});
            });
            $('#level_B_ohigh_input').change(function (e) {
                $('#level_B_output_bar').barLevel('update', {High: $('#level_B_ohigh_input').val()});
            });
            
            $('#level_channel').change(function (e) {
                $('#dialog_levels .levels_channel').removeClass('top');
                $('#levels_'+$(e.target).val()).addClass('top');
            });
            $('#level_logarithmic').click(function () {
                updateHistograms();
            });
        },
        onOpen: function() {
            if (Context.Depth == 'Grayscale') {
                $('#level_channel').hide();
                $('#level_label_black').show();
                $('#level_label_black').css('display:inline-block;');
            } else {
                $('#level_channel').show();
                $('#level_label_black').hide();
                $('#level_channel').css('display:inline-block;');
            }
            updateHistograms();
        },
        onClose: function() {
            $('#level_RGB_input_bar').barLevel('reset');
            $('#level_RGB_output_bar').barLevel('reset');
            $('#level_R_input_bar').barLevel('reset');
            $('#level_R_output_bar').barLevel('reset');
            $('#level_G_input_bar').barLevel('reset');
            $('#level_G_output_bar').barLevel('reset');
            $('#level_B_input_bar').barLevel('reset');
            $('#level_B_output_bar').barLevel('reset');
            $('#level_logarithmic').prop('checked', true);
            $('#dialog_levels .levels_channel').removeClass('top');
            $('#levels_RGB').addClass('top');
            $('#level_channel').val('RGB');
        },
        onOk: function() {
            $('#dst').attr('src', makeLevels($('#src').get(0)));
            makeOk("Levels");
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            $('#dst').attr('src', makeLevels($('#src').get(0)));
        },
        onReset: function () {
            $('#level_RGB_input_bar').barLevel('reset');
            $('#level_RGB_output_bar').barLevel('reset');
            $('#level_R_input_bar').barLevel('reset');
            $('#level_R_output_bar').barLevel('reset');
            $('#level_G_input_bar').barLevel('reset');
            $('#level_G_output_bar').barLevel('reset');
            $('#level_B_input_bar').barLevel('reset');
            $('#level_B_output_bar').barLevel('reset');
            $('#level_logarithmic').prop('checked', true);
            $('#dialog_levels .levels_channel').removeClass('top');
            $('#levels_RGB').addClass('top');
            $('#level_channel').val('RGB');
        }
    });
});
</script>    
    <div class="dialog" id="dialog_levels">
        <div class="bar"><div class="caption">Levels</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset>
                    <legend><label style="display:inline-block;">Channel:&nbsp;<span id="level_label_black" style="display:none;">Gray</span></label><select id="level_channel"><option value="RGB">RGB</option><option value="red">Red</option><option value="green">Green</option><option value="blue">Blue</option></select></legend>
                    <div class="levels_channels">
                        <div id="levels_RGB" class="levels_channel top">
                            <div>
                                <label>Input levels</label>
                                <div style="width:258px;height:102px;"><canvas id="level_RGB_histogram" width="256" height="100" style="float:left;border: 1px solid black;margin-right:20px;background-color:white;"></canvas></div>
                                <div id="level_RGB_input_bar"></div>
                                <div style="display:table;width:100%;">
                                    <div style="display:table-row;">
                                        <div style="display:table-cell; text-align:left;">
                                            <input id="level_RGB_ilow_input" type="text" value="0" maxlength="3" size="4" style="text-align:right;">
                                        </div>
                                        <div style="display:table-cell; text-align:center;">
                                            <input id="level_RGB_gamma_input" type="text" value="1" maxlength="4" size="4" style="text-align:right;">
                                        </div>
                                        <div style="display:table-cell; text-align:right;">
                                            <input id="level_RGB_ihigh_input" type="text" value="255" maxlength="3" size="4" style="text-align:right;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div style="margin-top:10px;">
                                <label>Output levels</label>
                                <div style="border:1px solid black;position:relative;width:256px;height:9px;background-image:url(images/degrad.gif);"></div>
                                <div id="level_RGB_output_bar"></div>
                                <div style="display:table;width:100%;">
                                    <div style="display:table-row;">
                                        <div style="display:table-cell; text-align:left;">
                                            <input id="level_RGB_olow_input" type="text" value="0" maxlength="3" size="4" style="text-align:right;">
                                        </div>
                                        <div style="display:table-cell; text-align:right;">
                                            <input id="level_RGB_ohigh_input" type="text" value="255" maxlength="3" size="4" style="text-align:right;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="levels_red" class="levels_channel">
                            <div>
                                <label>Input levels</label>
                                <div style="width:258px;height:102px;"><canvas id="level_R_histogram" width="256" height="100" style="float:left;border: 1px solid black;margin-right:20px;background-color:white;"></canvas></div>
                                <div id="level_R_input_bar"></div>
                                <div style="display:table;width:100%;">
                                    <div style="display:table-row;">
                                        <div style="display:table-cell; text-align:left;">
                                            <input id="level_R_ilow_input" type="text" value="0" maxlength="3" size="4" style="text-align:right;">
                                        </div>
                                        <div style="display:table-cell; text-align:center;">
                                            <input id="level_R_gamma_input" type="text" value="1" maxlength="4" size="4" style="text-align:right;">
                                        </div>
                                        <div style="display:table-cell; text-align:right;">
                                            <input id="level_R_ihigh_input" type="text" value="255" maxlength="3" size="4" style="text-align:right;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div style="margin-top:10px;">
                                <label>Output levels</label>
                                <div style="border:1px solid black;position:relative;width:256px;height:9px;background-image:url(images/degrad.gif);"></div>
                                <div id="level_R_output_bar"></div>
                                <div style="display:table;width:100%;">
                                    <div style="display:table-row;">
                                        <div style="display:table-cell; text-align:left;">
                                            <input id="level_R_olow_input" type="text" value="0" maxlength="3" size="4" style="text-align:right;">
                                        </div>
                                        <div style="display:table-cell; text-align:right;">
                                            <input id="level_R_ohigh_input" type="text" value="255" maxlength="3" size="4" style="text-align:right;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="levels_green" class="levels_channel">
                            <div>
                                <label>Input levels</label>
                                <div style="width:258px;height:102px;"><canvas id="level_G_histogram" width="256" height="100" style="float:left;border: 1px solid black;margin-right:20px;background-color:white;"></canvas></div>
                                <div id="level_G_input_bar"></div>
                                <div style="display:table;width:100%;">
                                    <div style="display:table-row;">
                                        <div style="display:table-cell; text-align:left;">
                                            <input id="level_G_ilow_input" type="text" value="0" maxlength="3" size="4" style="text-align:right;">
                                        </div>
                                        <div style="display:table-cell; text-align:center;">
                                            <input id="level_G_gamma_input" type="text" value="1" maxlength="4" size="4" style="text-align:right;">
                                        </div>
                                        <div style="display:table-cell; text-align:right;">
                                            <input id="level_G_ihigh_input" type="text" value="255" maxlength="3" size="4" style="text-align:right;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div style="margin-top:10px;">
                                <label>Output levels</label>
                                <div style="border:1px solid black;position:relative;width:256px;height:9px;background-image:url(images/degrad.gif);"></div>
                                <div id="level_G_output_bar"></div>
                                <div style="display:table;width:100%;">
                                    <div style="display:table-row;">
                                        <div style="display:table-cell; text-align:left;">
                                            <input id="level_G_olow_input" type="text" value="0" maxlength="3" size="4" style="text-align:right;">
                                        </div>
                                        <div style="display:table-cell; text-align:right;">
                                            <input id="level_G_ohigh_input" type="text" value="255" maxlength="3" size="4" style="text-align:right;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        

                        <div id="levels_blue" class="levels_channel">
                            <div>
                                <label>Input levels</label>
                                <div style="width:258px;height:102px;"><canvas id="level_B_histogram" width="256" height="100" style="float:left;border: 1px solid black;margin-right:20px;background-color:white;"></canvas></div>
                                <div id="level_B_input_bar"></div>
                                <div style="display:table;width:100%;">
                                    <div style="display:table-row;">
                                        <div style="display:table-cell; text-align:left;">
                                            <input id="level_B_ilow_input" type="text" value="0" maxlength="3" size="4" style="text-align:right;">
                                        </div>
                                        <div style="display:table-cell; text-align:center;">
                                            <input id="level_B_gamma_input" type="text" value="1" maxlength="4" size="4" style="text-align:right;">
                                        </div>
                                        <div style="display:table-cell; text-align:right;">
                                            <input id="level_B_ihigh_input" type="text" value="255" maxlength="3" size="4" style="text-align:right;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div style="margin-top:10px;">
                                <label>Output levels</label>
                                <div style="border:1px solid black;position:relative;width:256px;height:9px;background-image:url(images/degrad.gif);"></div>
                                <div id="level_B_output_bar"></div>
                                <div style="display:table;width:100%;">
                                    <div style="display:table-row;">
                                        <div style="display:table-cell; text-align:left;">
                                            <input id="level_B_olow_input" type="text" value="0" maxlength="3" size="4" style="text-align:right;">
                                        </div>
                                        <div style="display:table-cell; text-align:right;">
                                            <input id="level_B_ohigh_input" type="text" value="255" maxlength="3" size="4" style="text-align:right;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>


                        
                    </div>
                </fieldset>
                <div style="margin:0 0 12px 12px;"><input id="level_logarithmic" type="checkbox" checked><label for="level_logarithmic" style="display:inline;">Logarithmic histogram</label></div>
            </div>
            <div class="buttons">
                <button id="levels_ok" class="btn_ok main" type="button">Ok</button>
                <button id="levels_cancel" class="btn_cancel" type="button">Cancel</button>
                <button id="levels_reset" class="btn_reset" type="button">Reset</button>
                <button id="levels_apply" class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>
    
<script>
function makeMonochrome(img, threshold, type) {
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    ctx.putImageData(monochrome(imageData, threshold, type), 0, 0);
    return canvas.toDataURL('image/png');
}

$(function() {
    $('#dialog_monochrome').Dialog({
        onInit: function() {
            $('#monochrome_threshold_bar').barInput({Min:0, Max:255, Default:128, Label:'Threshold Level', HalfScale: true});
        },
        onClose: function() {
            $('#monochrome_threshold_bar').barInput('reset');
            $('#monochrome_threshold_type').val('atkinson');
        },
        onOk: function() {
            $('#dst').attr('src', makeMonochrome($('#src').get(0), $('#monochrome_threshold_bar input').val(), $('#monochrome_threshold_type').val()));
            makeOk("Bitmap");
            Context.changeDepth('Bitmap');
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            $('#dst').attr('src', makeMonochrome($('#src').get(0), $('#monochrome_threshold_bar input').val(), $('#monochrome_threshold_type').val()));
        },
        onReset: function () {
            $('#monochrome_threshold_bar').barInput('reset');
            $('#monochrome_threshold_type').val('atkinson');
        }
    });
});
</script>

    <div class="dialog" id="dialog_monochrome">
        <div class="bar"><div class="caption">Bitmap</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div><label for="monochrome_threshold_type" style="margin-left:6px;">Dither</label>
                    <select id="monochrome_threshold_type" style="width:200px;">
                        <option value="atkinson" selected>Atkinson</option>
                        <option value="bayer">Bayer 4</option>
                        <option value="bayer8">Bayer 8</option>
                        <option value="burkes">Burkes</option>
                        <option value="falsefloydsteinberg">False Floyd/Steinberg</option>
                        <option value="floydsteinberg">Floyd/Steinberg</option>
                        <option value="jarvisjudiceninke">Jarvis/Judice/Ninke</option>
                        <option value="none">None</option>
                        <option value="sierra">Sierra</option>
                        <option value="sierra2row">Sierra Two-Row</option>
                        <option value="sierralite">Sierra Lite</option>
                        <option value="stucki">Stucki</option>
                    </select></div>
                    <div id="monochrome_threshold_bar"></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>

<script>
function makeHSL(img, h, s, l, colorize) {
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    ctx.putImageData(hueSaturation(imageData, h, s, l, colorize), 0, 0);
    return canvas.toDataURL('image/png');
}

$(function() {
    $('#dialog_hsl').Dialog({
        onInit: function() {
            $('#hsl_hue_bar').barInput({Min:-180,Max:180,Default:0,Label:'Hue',HalfScale:true,onDrag: function (values) {
                if (!$('#hsl_colorize').is(':checked')) {
                    $('#hsl_hue_spectre1').css('background-position', (values.Pos-100)+'px center');
                }
            }});
            $('#hsl_sat_bar').barInput({Min:-100,Max:100,Default:0,Label:'Saturation',HalfScale:true});
            $('#hsl_light_bar').barInput({Min:-100,Max:100,Default:0,Label:'Lightness',HalfScale:true});
            $('#hsl_colorize').change(function (e) {
                if ($('#hsl_colorize').is(':checked')) {
                    $('#hsl_hue_bar').barInput('reset');
                    $('#hsl_sat_bar').barInput('reset');
                    $('#hsl_light_bar').barInput('reset');
                    $('#hsl_hue_spectre1').css('background-position', '0 center');
                } else {
                    $('#hsl_hue_bar').barInput('reset');
                    $('#hsl_sat_bar').barInput('reset');
                    $('#hsl_light_bar').barInput('reset');
                    $('#hsl_hue_spectre1').css('background-position', '0 center');
                }
            });
        },
        onClose: function() {
            $('#hsl_colorize').prop('checked', false);
            $('#hsl_hue_bar').barInput('reset');
            $('#hsl_sat_bar').barInput('reset');
            $('#hsl_light_bar').barInput('reset');
            $('#hsl_hue_spectre1').css('background-position', '0 center');
        },
        onOk: function() {
            $('#dst').attr('src', makeHSL($('#src').get(0), $('#hsl_hue_bar input').val(), $('#hsl_sat_bar input').val(), $('#hsl_light_bar input').val(), $('#hsl_colorize').prop('checked')));
            makeOk("Hue/Saturation");
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            $('#dst').attr('src', makeHSL($('#src').get(0), $('#hsl_hue_bar input').val(), $('#hsl_sat_bar input').val(), $('#hsl_light_bar input').val(), $('#hsl_colorize').prop('checked')));
        },
        onReset: function () {
            $('#hsl_colorize').prop('checked', false);
            $('#hsl_hue_bar').barInput('reset');
            $('#hsl_sat_bar').barInput('reset');
            $('#hsl_light_bar').barInput('reset');
            $('#hsl_hue_spectre1').css('background-position', '0 center');
        }
    });
});
</script>

    <div class="dialog" id="dialog_hsl">
        <div class="bar"><div class="caption">Hue/Saturation</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div id="hsl_hue_bar"></div>
                    <div id="hsl_hue_spectre1" style="width:200px;height:5px;background-image:url(images/spectre.png);margin-left:1px;"></div>
                    <div id="hsl_hue_spectre2" style="width:200px;height:5px;background-image:url(images/spectre.png);margin-left:1px;"></div>
                    <div id="hsl_sat_bar"></div>
                    <div id="hsl_light_bar"></div>
                    <div style="margin-top:5px;"><input id="hsl_colorize" type="checkbox"><label for="hsl_colorize" style="display:inline;"> Colorize</label></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>

<script>
function makeBriCon(img, bri, con) {
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    ctx.putImageData(brightnessContrast(imageData, bri*0.005, (con*0.0075)+1), 0, 0);
    return canvas.toDataURL('image/png');
}

$(function() {
    $('#dialog_bricon').Dialog({
        onInit: function() {
            $('#bricon_bri_bar').barInput({Min:-100,Max:100,Default:0,Label:'Brightness',HalfScale:true});
            $('#bricon_con_bar').barInput({Min:-100,Max:100,Default:0,Label:'Contrast',HalfScale:true});
        },
        onClose: function() {
            $('#bricon_bri_bar').barInput('reset');
            $('#bricon_con_bar').barInput('reset');
        },
        onOk: function() {
            $('#dst').attr('src', makeBriCon($('#src').get(0), $('#bricon_bri_bar input').val(), $('#bricon_con_bar input').val()));
            makeOk("Brightness/Contrast");
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            $('#dst').attr('src', makeBriCon($('#src').get(0), $('#bricon_bri_bar input').val(), $('#bricon_con_bar input').val()));
        },
        onReset: function () {
            $('#bricon_bri_bar').barInput('reset');
            $('#bricon_con_bar').barInput('reset');
        }
    });
});
</script>

    
    <div class="dialog" id="dialog_bricon">
        <div class="bar"><div class="caption">Brightness/Contrast</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div id="bricon_bri_bar"></div>
                    <div id="bricon_con_bar"></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>


    <script>
        
        $(function() {
            $('#dialog_sigcon').Dialog({
                onInit: function() {
                    $('#sigcon_con_bar').barInput({Min:0,Max:25,Default:3,Label:'Contrast',HalfScale:false});
                    $('#sigcon_mid_bar').barInput({Min:0,Max:100,Default:50,Label:'Mid-point',HalfScale:true});
                },
                onClose: function() {
                    $('#sigcon_con_bar').barInput('reset');
                    $('#sigcon_mid_bar').barInput('reset');
                },
                onOk: function() {
                    IMSigmoidalContrast($('#src'), $('input[name=sigmoidalContrastRadio]:checked').val()==1?0:1, $('#sigcon_con_bar input').val(), $('#sigcon_mid_bar input').val(), $('#dst'));
                    makeOk("Sigmoidal Contrast");
                },
                onCancel: function() {
                    makeCancel();
                },
                onApply: function () {
                    IMSigmoidalContrast($('#src'), $('input[name=sigmoidalContrastRadio]:checked').val()==1?0:1, $('#sigcon_con_bar input').val(), $('#sigcon_mid_bar input').val(), $('#dst'));
                },
                onReset: function () {
                    $('#sigcon_con_bar').barInput('reset');
                    $('#sigcon_mid_bar').barInput('reset');
                }
            });
        });
        </script>
        
            
            <div class="dialog" id="dialog_sigcon">
                <div class="bar"><div class="caption">Sigmoidal Contrast</div></div>
                <div class="border">
                <div class="zone">
                    <div class="main">
                        <fieldset class="white">
                            <div class="radios"><input type="radio" id="sigmoidalContrastIncrease" name="sigmoidalContrastRadio" value="1" checked /><label for="sigmoidalContrastIncrease">Increase</label> <input type="radio" id="sigmoidalContrastDecrease" name="sigmoidalContrastRadio" value="0" /><label for="sigmoidalContrastDecrease">Decrease</label></div>
                            <div id="sigcon_con_bar"></div>
                            <div id="sigcon_mid_bar"></div>
                        </fieldset>
                    </div>
                    <div class="buttons">
                        <button class="btn_ok main" type="button">Ok</button>
                        <button class="btn_cancel" type="button">Cancel</button>
                        <button class="btn_reset" type="button">Reset</button>
                        <button class="btn_apply" type="button">Preview</button>
                        <a href="https://imagemagick.org/" target="_blank"><div class="IM" title="Powered by Image Magick"></div></a>
                    </div>
                </div>
                </div>
            </div>

<script>
function chanmix_reset() {
    $('#chanmix_red_red_bar').barInput('reset');
    $('#chanmix_red_green_bar').barInput('reset');
    $('#chanmix_red_blue_bar').barInput('reset');
    $('#chanmix_green_red_bar').barInput('reset');
    $('#chanmix_green_green_bar').barInput('reset');
    $('#chanmix_green_blue_bar').barInput('reset');
    $('#chanmix_blue_red_bar').barInput('reset');
    $('#chanmix_blue_green_bar').barInput('reset');
    $('#chanmix_blue_blue_bar').barInput('reset');
    $('#chanmix_black_red_bar').barInput('reset');
    $('#chanmix_black_green_bar').barInput('reset');
    $('#chanmix_black_blue_bar').barInput('reset');
    $('#dialog_chanmix .chanmix_source').removeClass('top');
    $('#chanmix_red_tab').addClass('top');
    $('#chanmix_channel').val('red');
    $('#chanmix_channel').attr('disabled', false);
    $('#chanmix_monochrome').prop('checked', false);
    $('#chanmix_preserve').prop('checked', false);
}
function chanmix_collect() {
    var params = {red:{},green:{},blue:{},black:{},monochrome:false,preserve_luminosity:false};
    params.red.red_gain = parseInt($('#chanmix_red_red_bar input').val(), 10) / 100;
    params.red.green_gain = parseInt($('#chanmix_red_green_bar input').val(), 10) / 100;
    params.red.blue_gain = parseInt($('#chanmix_red_blue_bar input').val(), 10) / 100;
    params.green.red_gain = parseInt($('#chanmix_green_red_bar input').val(), 10) / 100;
    params.green.green_gain = parseInt($('#chanmix_green_green_bar input').val(), 10) / 100;
    params.green.blue_gain = parseInt($('#chanmix_green_blue_bar input').val(), 10) / 100;
    params.blue.red_gain = parseInt($('#chanmix_blue_red_bar input').val(), 10) / 100;
    params.blue.green_gain = parseInt($('#chanmix_blue_green_bar input').val(), 10) / 100;
    params.blue.blue_gain = parseInt($('#chanmix_blue_blue_bar input').val(), 10) / 100;
    params.black.red_gain = parseInt($('#chanmix_black_red_bar input').val(), 10) / 100;
    params.black.green_gain = parseInt($('#chanmix_black_green_bar input').val(), 10) / 100;
    params.black.blue_gain = parseInt($('#chanmix_black_blue_bar input').val(), 10) / 100;
    if ($('#chanmix_monochrome').is(':checked')) params.monochrome = true;
    if ($('#chanmix_preserve').is(':checked')) params.preserve_luminosity = true;
    return params;
}

function makeChanMix() {
    var params = chanmix_collect();
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    ctx.putImageData(channelMixer(imageData, params), 0, 0);
    return canvas.toDataURL('image/png')
}

$(function() {
    $('#dialog_chanmix').Dialog({
        onInit: function() {
            $('#chanmix_red_red_bar').barInput({Min:-200,Max:200,Default:100,HalfScale:true,Label:'<div style="background-color:red;" class="minipal"></div> Red'});
            $('#chanmix_red_green_bar').barInput({Min:-200,Max:200,Default:0,HalfScale:true,Label:'<div style="background-color:green;" class="minipal"></div> Green'});
            $('#chanmix_red_blue_bar').barInput({Min:-200,Max:200,Default:0,HalfScale:true,Label:'<div style="background-color:blue;" class="minipal"></div> Blue'});
            $('#chanmix_green_red_bar').barInput({Min:-200,Max:200,Default:0,HalfScale:true,Label:'<div style="background-color:red;" class="minipal"></div> Red'});
            $('#chanmix_green_green_bar').barInput({Min:-200,Max:200,Default:100,HalfScale:true,Label:'<div style="background-color:green;" class="minipal"></div> Green'});
            $('#chanmix_green_blue_bar').barInput({Min:-200,Max:200,Default:0,HalfScale:true,Label:'<div style="background-color:blue;" class="minipal"></div> Blue'});
            $('#chanmix_blue_red_bar').barInput({Min:-200,Max:200,Default:0,HalfScale:true,Label:'<div style="background-color:red;" class="minipal"></div> Red'});
            $('#chanmix_blue_green_bar').barInput({Min:-200,Max:200,Default:0,HalfScale:true,Label:'<div style="background-color:green;" class="minipal"></div> Green'});
            $('#chanmix_blue_blue_bar').barInput({Min:-200,Max:200,Default:100,HalfScale:true,Label:'<div style="background-color:blue;" class="minipal"></div> Blue'});
            $('#chanmix_black_red_bar').barInput({Min:-200,Max:200,Default:21,HalfScale:true,Label:'<div style="background-color:red;" class="minipal"></div> Red'});
            $('#chanmix_black_green_bar').barInput({Min:-200,Max:200,Default:72,HalfScale:true,Label:'<div style="background-color:green;" class="minipal"></div> Green'});
            $('#chanmix_black_blue_bar').barInput({Min:-200,Max:200,Default:7,HalfScale:true,Label:'<div style="background-color:blue;" class="minipal"></div> Blue'});
            
            $('#chanmix_channel').change(function (e) {
                $('#dialog_chanmix .chanmix_source').removeClass('top');
                $('#chanmix_'+$(e.target).val()+'_tab').addClass('top');
            });
            $('#chanmix_monochrome').change(function (e) {
                if ($(e.target).is(':checked')) {
                    $('#dialog_chanmix .chanmix_source').removeClass('top');
                    $('#chanmix_black_tab').addClass('top');
                    $('#chanmix_channel').attr('disabled', true);
                } else {
                    $('#dialog_chanmix .chanmix_source').removeClass('top');
                    $('#chanmix_red_tab').addClass('top');
                    $('#chanmix_channel').val('red');
                    $('#chanmix_channel').attr('disabled', false);
                }
            });
        },
        onClose: function() {
            chanmix_reset();
        },
        onOk: function() {
            $('#dst').attr('src', makeChanMix());
            makeOk("Channel Mixer");
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            $('#dst').attr('src', makeChanMix());
        },
        onReset: function () {
            chanmix_reset();
        }
    });

});
</script>
    
    <div class="dialog" id="dialog_chanmix">
        <div class="bar"><div class="caption">Channel Mixer</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div style="margin-top:3px;"><label style="display:inline-block;">Output Channel:&nbsp;</label><select id="chanmix_channel"><option value="red">Red</option><option value="green">Green</option><option value="blue">Blue</option></select></div>
                    <div class="chanmix_sources">
                        <fieldset id="chanmix_red_tab" class="subfieldset chanmix_source top">
                        <legend>Source Channels</legend>
                            <div id="chanmix_red_red_bar"></div>
                            <div id="chanmix_red_green_bar"></div>
                            <div id="chanmix_red_blue_bar"></div>
                        </fieldset>
                        
                        <fieldset id="chanmix_green_tab" class="subfieldset chanmix_source">
                        <legend>Source Channels</legend>
                            <div id="chanmix_green_red_bar"></div>
                            <div id="chanmix_green_green_bar"></div>
                            <div id="chanmix_green_blue_bar"></div>
                        </fieldset>
                        
                        
                        <fieldset id="chanmix_blue_tab" class="subfieldset chanmix_source">
                        <legend>Source Channels</legend>
                            <div id="chanmix_blue_red_bar"></div>
                            <div id="chanmix_blue_green_bar"></div>
                            <div id="chanmix_blue_blue_bar"></div>
                        </fieldset>
                        
                        <fieldset id="chanmix_black_tab" class="subfieldset chanmix_source">
                        <legend>Source Channels</legend>
                            <div id="chanmix_black_red_bar"></div>
                            <div id="chanmix_black_green_bar"></div>
                            <div id="chanmix_black_blue_bar"></div>
                        </fieldset>
                    </div>
                    <div style="margin-top:10px;"><input id="chanmix_monochrome" type="checkbox"><label for="chanmix_monochrome" style="display:inline;"> Monochrome</label></div>
                    <div><input id="chanmix_preserve" type="checkbox"><label for="chanmix_preserve" style="display:inline;"> Preserve luminosity</label></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>

<script>
function makeDesaturate() {
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    ctx.putImageData(desaturate(imageData, $('.desat_class:checked').val()), 0, 0);
    return canvas.toDataURL('image/png');
}

$(function() {
    $('#dialog_desat').Dialog({
        onInit: function() {
        },
        onClose: function() {
            $('#desat_light').prop('checked', true);
        },
        onOk: function() {
            $('#dst').attr('src', makeDesaturate());
            makeOk("Desaturate");
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            $('#dst').attr('src', makeDesaturate());
        },
        onReset: function () {
            $('#desat_light').prop('checked', true);
        }
    });
});
</script>

    <div class="dialog" id="dialog_desat">
        <div class="bar"><div class="caption">Desaturate</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div style="margin-bottom:5px;">Shade of gray based on:</div>
                    <input id="desat_light" class="desat_class" value="lightness" name="desat_option" type="radio" checked><label for="desat_light" style="display:inline;"> Lightness</label><br>
                    <input id="desat_lumin" class="desat_class" value="luminosity" name="desat_option" type="radio"><label for="desat_lumin" style="display:inline;"> Luminosity</label><br>
                    <input id="desat_avera" class="desat_class" value="average" name="desat_option" type="radio"><label for="desat_avera" style="display:inline;"> Average</label>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>

<script>
function makePosterize() {
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    ctx.putImageData(posterize(imageData, parseInt($('#poster_bar input').val())), 0, 0);
    return canvas.toDataURL('image/png');
}

$(function() {
    $('#dialog_posterize').Dialog({
        onInit: function() {
            $('#poster_bar').barInput({Min:2,Max:256,Default:4,Label:'Level'});
        },
        onClose: function() {
            $('#poster_bar').barInput('reset');
        },
        onOk: function() {
            $('#dst').attr('src', makePosterize());
            makeOk("Posterize");
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            $('#dst').attr('src', makePosterize());
        },
        onReset: function () {
            $('#poster_bar').barInput('reset');
        }
    });
    

});
</script>

    <div class="dialog" id="dialog_posterize">
        <div class="bar"><div class="caption">Posterize</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div id="poster_bar"></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>

<script>
function makeThreshold() {
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    ctx.putImageData(monochrome(imageData, parseInt($('#threshold_bar input').val()), 'none'), 0, 0);
    return canvas.toDataURL('image/png');
}

$(function() {
    $('#dialog_threshold').Dialog({
        onInit: function() {
            $('#threshold_bar').barInput({Min:1,Max:255,Default:128,HalfScale:true,Label:'Threshold Level'});
        },
        onClose: function() {
            $('#threshold_bar').barInput('reset');
        },
        onOk: function() {
            $('#dst').attr('src', makeThreshold());
            makeOk("Threshold");
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            $('#dst').attr('src', makeThreshold());
        },
        onReset: function () {
            $('#threshold_bar').barInput('reset');
        }
    });
});
</script>

    <div class="dialog" id="dialog_threshold">
        <div class="bar"><div class="caption">Threshold</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div id="threshold_bar"></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>

<script>
var rgbquant = null;
function colorquant_buildPalette() {
    $('#palette .square').remove();
    var val = $('#colorquant_palette').val();
    var cols = 0;
    var palsel = 'none';
    if (val == 'uni') {
        cols = $('#colorquant_colors_input_uni').val();
        palsel = val+cols;
    } else if (val == 'win') {
        cols = $('#colorquant_colors_input_win').val();
        palsel = val+cols;
    } else {
        cols = $('#colorquant_colors_input').val();
        palsel = val;
        if (val == 'ada' || val == 'ima' || val == 'exa') palsel = 'none'; 
    }
    var opts = {
        colors: parseInt(cols),
        method: 2,
        boxSize: [40,40],
        boxPxls: 3,
        dithKern: $('#colorquant_dither').val(),
        palette: palettes[palsel],
        reIndex: false
    };
    if (val === 'ima') opts.palette = IMQuantizeAndListUniqueColors($('#src'), cols);
    if (opts.dithKern === "") opts.dithKern = null;
    rgbquant = new RgbQuant(opts);
    rgbquant.sample($('#src').get(0));
    var pal = rgbquant.palette(true);
    $.each(pal, function(i, v) {
        if (v !== null) {
            var p = $('<div class="square">');
            var v = 'rgb('+parseInt(v[0])+','+parseInt(v[1])+','+parseInt(v[2])+')';
            p.css('background-color', v);
            p.attr('title', v);
            $('#palette').append(p);
        }
    });
}
function colorquant_apply() {
    var img = $('#src').get(0);
    var out = rgbquant.reduce(img);
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    for (var i = 0; i < imageData.data.length; i+=4) {
        imageData.data[i] = out[i];
        imageData.data[i+1] = out[i+1];
        imageData.data[i+2] = out[i+2];
    }
    ctx.putImageData(imageData, 0, 0);
    $('#dst').attr('src', canvas.toDataURL('image/png'));
}
$(function() {
    $('#colorquant_colors_input_uni').change(function (e) {
        colorquant_buildPalette();
    });
    $('#colorquant_colors_input_win').change(function (e) {
        colorquant_buildPalette();
    });
    $('#colorquant_colors_input').change(function (e) {
        var val = parseInt($(e.target).val());
        if (val < 2) $(e.target).val(2);
        else if (val > 256) $(e.target).val(256);
        colorquant_buildPalette();
    });
    $('#colorquant_palette').change(function (e) {
        var val = $(e.target).val();
        if (val == 'ada') {
            $('#colorquant_col_in').show();
            $('#colorquant_colors_input').val(16);
            $('#colorquant_colors_input').attr('disabled', false);
            $('#colorquant_col_uni').hide();
            $('#colorquant_col_win').hide();
        } else if (val == 'exa') {
            $('#colorquant_col_in').show();
            $('#colorquant_colors_input').val(Context.Colors.count || 256);
            $('#colorquant_colors_input').attr('disabled', true);
            $('#colorquant_col_uni').hide();
            $('#colorquant_col_win').hide();
        } else if (val == 'uni') {
            $('#colorquant_col_in').hide();
            $('#colorquant_col_uni').show();
            $('#colorquant_colors_input_uni').val('8');
            $('#colorquant_col_win').hide();
        } else if (val == 'mac') {
            $('#colorquant_col_in').show();
            $('#colorquant_colors_input').val('256');
            $('#colorquant_colors_input').attr('disabled', true);
            $('#colorquant_col_uni').hide();
            $('#colorquant_col_win').hide();
        } else if (val == 'win') {
            $('#colorquant_col_in').hide();
            $('#colorquant_col_uni').hide();
            $('#colorquant_col_win').show();
            $('#colorquant_colors_input_win').val('16');
        } else if (val == 'web') {
            $('#colorquant_col_in').show();
            $('#colorquant_colors_input').val('216');
            $('#colorquant_colors_input').attr('disabled', true);
            $('#colorquant_col_uni').hide();
            $('#colorquant_col_win').hide();
        }
        colorquant_buildPalette();
    });

    $('#dialog_colorquant').Dialog({
        onInit: function() {
        },
        onOpen: function() {
            if (Context.Colors.count <= 256) {
                $('#colorquant_palette option[value=exa]').attr('disabled', false);
                $('#colorquant_palette').val('exa');
            } else {
                $('#colorquant_palette option[value=exa]').attr('disabled', true);
            }
            $('#colorquant_palette').change();
        },
        onClose: function() {
            $('#palette .square').remove();
        },
        onOk: function() {
            colorquant_buildPalette();
            colorquant_apply();
            makeOk("Indexed Color");
            Context.changeDepth('Indexed');
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            colorquant_buildPalette();
            colorquant_apply();
        },
        onReset: function () {
            $('#palette .square').remove();
        }
    });
});
</script>

    <div class="dialog" id="dialog_colorquant">
        <div class="bar"><div class="caption">Indexed color</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div><div style="margin-top:3px;text-align:right;"><label for="colorquant_palette" style="display:inline-block;float:left;">Palette</label><select id="colorquant_palette">
                    <option selected value="ada">Adaptive</option>
                    <option value="ima">Image magick</option>
                    <option value="exa">Exact</option>
                    <option value="uni">Uniform</option>
                    <option value="mac">System (Mac OS)</option>
                    <option value="win">System (Windows)</option>
                    <option value="web">Web Safe</option>
                    <option disabled value="cus">Custom...</option>
                    </select></div></div>
                    <div id="colorquant_col_in"><div style="margin-top:3px;text-align:right;"><label style="display:inline-block;float:left;" for="colorquant_colors_input">Colors</label><input id="colorquant_colors_input" type="text" value="16" maxlength="3" size="3" style="text-align:right;"></div></div>
                    <div id="colorquant_col_uni" style="display:none;"><div style="margin-top:3px;text-align:right;"><label for="colorquant_colors_select_uni" style="display:inline-block;float:left;">Colors</label><select id="colorquant_colors_input_uni"><option selected value="8">8</option><option value="27">27</option><option value="64">64</option><option value="125">125</option><option value="216">216</option></select></div></div>
                    <div id="colorquant_col_win" style="display:none;"><div style="margin-top:3px;text-align:right;"><label for="colorquant_colors_input_win" style="display:inline-block;float:left;">Colors</label><select id="colorquant_colors_input_win"><option selected value="16">16</option><option value="256">256</option></select></div></div>
                    <div><div style="margin-top:3px;text-align:right;"><label for="colorquant_dither" style="display:inline-block;float:left;">Dither</label><select id="colorquant_dither">
                    <option value="Atkinson">Atkinson</option>
                    <option value="Ordered2">Bayer 2</option>
                    <option value="Ordered3">Bayer 3</option>
                    <option value="Ordered4">Bayer 4</option>
                    <option value="Ordered8">Bayer 8</option>
                    <option value="Burkes">Burkes</option>
                    <option value="FalseFloydSteinberg">False Floyd/Steinberg</option>
                    <option value="FloydSteinberg" selected>Floyd/Steinberg</option>
                    <option value="Jarvis">Jarvis/Judice/Ninke</option>
                    <option value="">None</option>
                    <option value="Sierra">Sierra</option>
                    <option value="TwoSierra">Sierra Two-Row</option>
                    <option value="SierraLite">Sierra Lite</option>
                    <option value="Stucki">Stucki</option>
                    </select></div></div>
                    <div id="palette"></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>
    
    
<script>
let makeResize = async () => {
    let w = parseInt($('#resize_width').val());
    let h = parseInt($('#resize_height').val());
    if (isNaN(w)) {
        w = 1;
        $('#resize_width').val(w);
        $('#resize_width').get(0).select();
    }
    if (isNaN(h)) {
        h = 1;
        $('#resize_height').val(h);
        $('#resize_height').get(0).select();
    }
    if (w < 1) {
        w = 1;
        $('#resize_width').val(w);
        $('#resize_width').get(0).select();
    }
    if (h < 1) {
        h = 1;
        $('#resize_height').val(h);
        $('#resize_height').get(0).select();
    }
    $('body').addClass('working');
    IMCmdResize($('#src'), w, h, $('#resample_filter').val(), $('#dst'));
    $('body').removeClass('working');
}

var resize_width_ratio = 0;
var resize_height_ratio = 0;
$(function() {
    $('#resample_filter').on('change', (event) => {
        let $target = $(event.delegateTarget);
        let val = $target.val();
        if (val === 'Gaussian') {
            //$('#resize_gaussian_options').show();
        } else {
            $('#resize_gaussian_options').hide();
        }
    });
    $('#dialog_resize').Dialog({
        onInit: function() {
            $('#resize_width').keyup(function () {
                var width = parseFloat($('#resize_width').val());
                if (isNaN(width)) {
                    width = 1;
                    $('#resize_width').val(width);
                    $('#resize_width').get(0).select();
                }
                if (width < 1) {
                    width = 1;
                    $('#resize_width').val(width);
                    $('#resize_width').get(0).select();
                }
                if ($('#resize_prop').is(':checked')) {
                    var h = Math.round(width*resize_height_ratio);
                    h = Math.max(h, 1);
                    $('#resize_height').val(h);
                }
            });
            $('#resize_height').keyup(function () {
                var height = parseFloat($('#resize_height').val());
                if (isNaN(height)) {
                    height = 1;
                    $('#resize_height').val(height);
                    $('#resize_height').get(0).select();
                }
                if (height < 1) {
                    height = 1;
                    $('#resize_height').val(height);
                    $('#resize_height').get(0).select();
                }
                if ($('#resize_prop').is(':checked')) {
                    var w = Math.round(height*resize_width_ratio);
                    w = Math.max(w, 1);
                    $('#resize_width').val(w);
                }
            });
        },
        onOpen: function() {
            $('#resize_width').val($('#src').get(0).width);
            $('#resize_height').val($('#src').get(0).height);
            resize_width_ratio = parseFloat($('#src').get(0).width) / parseFloat($('#src').get(0).height);
            resize_height_ratio = parseFloat($('#src').get(0).height) / parseFloat($('#src').get(0).width);
            $('#dst').attr('src', $('#src').attr('src'));
            $('#src').hide();
        },
        onClose: function() {
            console.log('closing');
            $('#resample_filter').val('');
            $('#resize_gaussian_options').hide();
            $('#gaussian_sigma').val('0.5');
            $('#resize_prop').prop('checked', true);
        },
        onOk: async () => {
            await makeResize();
            $('#src').show();
            makeOk("Resize");
            updateStatusBarDimensions();
        },
        onCancel: function() {
            $('#src').show();
            makeCancel();
        },
        onApply: async () => {
            await makeResize();
        },
        onReset: function () {
            $('#resize_width').val($('#src').get(0).width);
            $('#resize_height').val($('#src').get(0).height);
            $('#resample_filter').val('');
            $('#resize_gaussian_options').hide();
            $('#gaussian_sigma').val('0.5');
            $('#resize_prop').prop('checked', true);
            $('#dst').attr('src', $('#src').attr('src'));
        }
    });
});



</script>

    <div class="dialog" id="dialog_resize">
        <div class="bar"><div class="caption">Resize</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div style="margin-top:3px;"><label for="resize_width" style="display:inline-block;width:70px;">Width: </label><input id="resize_width" type="text" value="0" maxlength="4" size="4" style="text-align:right;"> px</div>
                    <div style="margin-top:6px;"><label for="resize_height" style="display:inline-block;width:70px;">Height: </label><input id="resize_height" type="text" value="0" maxlength="4" size="4" style="text-align:right;"> px</div>
                    <div style="margin-top:10px;"><input type="checkbox" id="resize_prop" checked><label for="resize_prop" style="display:inline-block;"> Constrain Proportions</label></div>
                    <div style="margin-top:10px;"><label for="resample_filter" style="display:inline-block;width:70px;">Filter: </label><select id="resample_filter" style="text-align:left;">
                        <option value="" selected>Automatic (default)</option>
                        <option value="Bartlett">Bartlett</option>
                        <option value="Blackman">Blackman</option>
                        <option value="Bohman">Bohman</option>
                        <option value="Box">Box</option>
                        <option value="Catrom">Catrom</option>
                        <option value="Cosine">Cosine</option>
                        <option value="Cubic">Cubic</option>
                        <option value="Gaussian">Gaussian</option>
                        <option value="Hamming">Hamming</option>
                        <option value="Hanning">Hanning</option>
                        <option value="Hermite">Hermite</option>
                        <option value="Jinc">Jinc</option>
                        <option value="Kaiser">Kaiser</option>
                        <option value="Lagrange">Lagrange</option>
                        <option value="Lanczos">Lanczos</option>
                        <option value="Lanczos2">Lanczos2</option>
                        <option value="Lanczos2Sharp">Lanczos2Sharp</option>
                        <option value="LanczosRadius">LanczosRadius</option>
                        <option value="LanczosSharp">LanczosSharp</option>
                        <option value="Mitchell">Mitchell</option>
                        <option value="Parzen">Parzen</option>
                        <option value="Point">Point</option>
                        <option value="Quadratic">Quadratic</option>
                        <option value="Robidoux">Robidoux</option>
                        <option value="RobidouxSharp">RobidouxSharp</option>
                        <option value="Sinc">Sinc</option>
                        <option value="SincFast">SincFast</option>
                        <option value="Spline">Spline</option>
                        <option value="Triangle">Triangle</option>
                        <option value="Welsh">Welsh</option>
                    </select></div>
                    <div id="resize_gaussian_options" style="display:none;">
                        <div style="margin-top:3px;"><label for="gaussian_sigma" style="display:inline-block;width:70px;">Sigma: </label><input id="gaussian_sigma" type="text" value="0.5" maxlength="4" size="4" style="text-align:right;"></div>
                    </div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
                <a href="https://imagemagick.org/" target="_blank"><div class="IM" title="Powered by Image Magick"></div></a>
            </div>
        </div>
        </div>
    </div>
    
<script>
$(function() {
    $('#dialog_arbi_rot').Dialog({
        onInit: function() {
        },
        onOpen: function() {
            saveCurrentZoom();
            if (!zoomFitsWorkArea()) zoomFitToWorkArea();
            $('#dst').on('load', () => {
                $('#grid').css('width', $('#dst').get(0).width);
                $('#grid').css('height', $('#dst').get(0).height);
            });
            $('#dst').attr('src', $('#src').attr('src'));
            $('#src').hide();
            $('#grid').removeClass('disabled');
        },
        onClose: function() {
            $('#arbi_rot_cw').prop('checked', true);
            $('#arbi_rot_angle').val(0);
            $('#grid').addClass('disabled');
            $('#dst').off('load');
            restoreSavedZoom();
        },
        onOk: function() {
            var deg = parseFloat($('#arbi_rot_angle').val());
            if (deg > 360) deg = 360;
            if (deg < -360) deg = -360;
            if ($('#arbi_rot_ccw').is(':checked')) deg = -deg;
            $('#dst').attr('src', makeRotate(deg));
            makeOk("Arbitrary Rotation");
            $('#src').show();
            updateStatusBarDimensions();
        },
        onCancel: function() {
            $('#src').show();
            makeCancel();
        },
        onApply: function () {
            var deg = parseFloat($('#arbi_rot_angle').val());
            if (deg > 360) deg = 360;
            if (deg < -360) deg = -360;
            $('#arbi_rot_angle').val(deg);
            if ($('#arbi_rot_ccw').is(':checked')) deg = -deg;
            $('#dst').attr('src', makeRotate(deg));
            $('#grid').css('width', $('#dst').get(0).width);
            $('#grid').css('height', $('#dst').get(0).height);
        },
        onReset: function () {
            $('#arbi_rot_cw').prop('checked', true);
            $('#arbi_rot_angle').val(0);
            $('#dst').attr('src', $('#src').attr('src'));
        }
    });
});
</script>

    <div class="dialog" id="dialog_arbi_rot">
        <div class="bar"><div class="caption">Arbitrary Rotation</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div style="margin-top:3px;"><label for="arbi_rot_angle" style="display:inline-block;width:60px;">Angle: </label><input id="arbi_rot_angle" type="text" value="0" maxlength="5" size="5" style="text-align:right;"> °</div>
                    <div style="margin-top:10px;"><input type="radio" id="arbi_rot_cw" checked name="arbi_rot"><label for="arbi_rot_cw" style="display:inline-block;"> Clockwise</label></div>
                    <div style="margin-top:0px;"><input type="radio" id="arbi_rot_ccw" name="arbi_rot"><label for="arbi_rot_ccw" style="display:inline-block;"> Counterclockwise</label></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>

<script>
function changeSelectionAspRat() {
    var str = $('#crop_asprat').val();
    if ($('#crop_orient').val() == 'port') {
        var m = null;
        if ((m = str.match(/([0-9]+)\/([0-9]+)/)) !== null) str = m[2]+'/'+m[1];
    }
    $('#selection').Selection('update', eval(str));
}

function updateMask() {
    var params = $('#mask').data('params');
    $('#mask').attr('viewBox', '0 0 '+window.innerWidth+' '+window.innerHeight);
    var path = 'M0,20V'+window.innerHeight+'H'+window.innerWidth+'V20ZM'+(params.offsetLeft + params.width)+','+(params.offsetTop + params.height)+'H'+params.offsetLeft+'V'+params.offsetTop+'H'+(params.offsetLeft + params.width)+'Z';
    $('#maskpath').attr('d', path);
}

function showSelection() {
    var width = $('#src').width();
    var height = $('#src').height();
    $('#containment').append('<div id="crop_containment"></div>');
    $('#crop_containment').append('<div id="selection"></div>');
    $('#crop_containment').width(width);
    $('#crop_containment').height(height);
    $('#emptylayer').append('<svg id="mask" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1 1"><path id="maskpath" d="M0,0v1h1V0H0z"/></svg>');
    $(window).on('resize', updateMask);
    let r = $('#zoom').val();
    $('#selection').Selection({
        onChange: function(x, y, width, height, $this) {
            $('#mask').data('params', {x:x, y:y, width:width, height:height, offsetLeft:$this.offset().left, offsetTop:$this.offset().top});
            updateMask();
            $('#crop_x').val(Math.round(x/r));
            $('#crop_y').val(Math.round(y/r));
            $('#crop_w').val(Math.round(width/r));
            $('#crop_h').val(Math.round(height/r));
        }
    });
    $('#crop_asprat').on('change', changeSelectionAspRat);
    $('#crop_orient').on('change', changeSelectionAspRat);
}

function hideSelection() {
    $('#crop_containment').remove();
    $('#mask').remove();
    $('#crop_x').val(0);
    $('#crop_y').val(0);
    $('#crop_w').val(0);
    $('#crop_h').val(0);
    $('#crop_asprat').off('change');
    $('#crop_orient').off('change');
    $('#crop_asprat').val('false');
    $('#crop_orient').val('land');
    $(window).off('resize', updateMask);
}

function makeCrop() {
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData2 = ctx.getImageData($('#crop_x').val(),$('#crop_y').val(),$('#crop_w').val(), $('#crop_h').val());
    var canvas2 = document.createElement("canvas");
    canvas2.width = $('#crop_w').val();
    canvas2.height = $('#crop_h').val();
    var ctx2 = canvas2.getContext("2d");
    ctx2.putImageData(imageData2, 0, 0);
    State.save("Crop");
    $('#src').attr('src', canvas2.toDataURL('image/png'));
}

$(function() {
    $('#dialog_crop').Dialog({
        onInit: function() {
        },
        onOpen: function() {
            saveCurrentZoom();
            if (!zoomFitsWorkArea()) zoomFitToWorkArea();
            showSelection();
        },
        onClose: function() {
            restoreSavedZoom();
        },
        onOk: function() {
            makeCrop();
            hideSelection();
            updateStatusBarDimensions();
        },
        onCancel: function() {
            hideSelection();
        },
        onReset: function () {
            hideSelection();
            showSelection();
        }
    });
});
</script>

    <div class="dialog" id="dialog_crop">
        <div class="bar"><div class="caption">Crop</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div style="margin-top:3px;"><label for="crop_x" style="display:inline-block;width:100px;">X: </label><input readonly id="crop_x" type="text" value="0" maxlength="4" size="4" style="text-align:right;"></div>
                    <div style="margin-top:3px;"><label for="crop_y" style="display:inline-block;width:100px;">Y: </label><input readonly id="crop_y" type="text" value="0" maxlength="4" size="4" style="text-align:right;"></div>
                    <div style="margin-top:10px;"><label for="crop_w" style="display:inline-block;width:100px;">Width: </label><input readonly id="crop_w" type="text" value="0" maxlength="4" size="4" style="text-align:right;"></div>
                    <div style="margin-top:3px;"><label for="crop_h" style="display:inline-block;width:100px;">Height: </label><input readonly id="crop_h" type="text" value="0" maxlength="4" size="4" style="text-align:right;"></div>
                    <div style="margin-top:10px;"><label for="crop_asprat" style="display:inline-block;width:100px;">Aspect Ratio: </label><select id="crop_asprat" style="width:95px;">
                    <option value="false" selected>Free</option>
                    <option value="1">1:1 Square</option>
                    <option value="5/4">4:5 (8:10)</option>
                    <option value="4/3">4:3</option>
                    <option value="7/5">5:7</option>
                    <option value="3/2">2:3 (4:6)</option>
                    <option value="16/9">16:9</option>
                    </select></div>
                    <div style="margin-top:3px;"><label for="crop_orient" style="display:inline-block;width:100px;">Orientation: </label><select id="crop_orient" style="width:95px;">
                    <option value="land" selected>Landscape</option>
                    <option value="port">Portrait</option>
                    </select></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
            </div>
        </div>
        </div>
    </div>

<script>
$(function() {
    $('#dialog_histogram').Dialog({
        onInit: function() {
            $('#histogram_channel').change(function (e) {
                $('#dialog_histogram .histogram_channel').removeClass('top');
                $('#histogram_'+$(e.target).val()).addClass('top');
            });
            $('#histogram_logarithmic').click(function () {
                histogramUpdateHistogram();
            });
            $('#histogram_RGB_select_bar').barLevel({onDrag: function (values) {
                var hist = null;
                if (Context.Depth == 'Grayscale') {
                    hist = $('#dialog_histogram').data('hist')[0];
                } else {
                    hist = cumulateRGBHistograms($('#dialog_histogram').data('hist'));
                }
                var stats = histoStats(hist, values.Low, values.High);
                $('#histogram_RGB_level').html(stats.level);
                $('#histogram_RGB_count').html(stats.count);
                $('#histogram_RGB_mean').html(stats.mean);
                $('#histogram_RGB_median').html(stats.median);
                $('#histogram_RGB_stddev').html(stats.sigma);
                $('#histogram_RGB_percentil').html(stats.percentil);
                if (stats.begin == 0 && stats.end == 255) $('#histogram_RGB svg rect').css('fill-opacity', 0);
                else $('#histogram_RGB svg rect').css('fill-opacity', 0.75);
                $('#histogram_RGB svg rect').attr('x', 1+stats.begin);
                $('#histogram_RGB svg rect').attr('width', stats.end-stats.begin+1);
            }, Dragger: { Images: { High: 'url(images/cur_low.gif)' }}});
            $('#histogram_R_select_bar').barLevel({onDrag: function (values) {
                var hist = $('#dialog_histogram').data('hist')[0];
                var stats = histoStats(hist, values.Low, values.High);
                $('#histogram_R_level').html(stats.level);
                $('#histogram_R_count').html(stats.count);
                $('#histogram_R_mean').html(stats.mean);
                $('#histogram_R_median').html(stats.median);
                $('#histogram_R_stddev').html(stats.sigma);
                $('#histogram_R_percentil').html(stats.percentil);
                if (stats.begin == 0 && stats.end == 255) $('#histogram_R svg rect').css('fill-opacity', 0);
                else $('#histogram_R svg rect').css('fill-opacity', 0.75);
                $('#histogram_R svg rect').attr('x', 1+stats.begin);
                $('#histogram_R svg rect').attr('width', stats.end-stats.begin+1);
            }, Dragger: { Images: { High: 'url(images/cur_low.gif)' }}});
            $('#histogram_G_select_bar').barLevel({onDrag: function (values) {
                var hist = $('#dialog_histogram').data('hist')[1];
                var stats = histoStats(hist, values.Low, values.High);
                $('#histogram_G_level').html(stats.level);
                $('#histogram_G_count').html(stats.count);
                $('#histogram_G_mean').html(stats.mean);
                $('#histogram_G_median').html(stats.median);
                $('#histogram_G_stddev').html(stats.sigma);
                $('#histogram_G_percentil').html(stats.percentil);
                if (stats.begin == 0 && stats.end == 255) $('#histogram_G svg rect').css('fill-opacity', 0);
                else $('#histogram_G svg rect').css('fill-opacity', 0.75);
                $('#histogram_G svg rect').attr('x', 1+stats.begin);
                $('#histogram_G svg rect').attr('width', stats.end-stats.begin+1);
            }, Dragger: { Images: { High: 'url(images/cur_low.gif)' }}});
            $('#histogram_B_select_bar').barLevel({onDrag: function (values) {
                var hist = $('#dialog_histogram').data('hist')[2];
                var stats = histoStats(hist, values.Low, values.High);
                $('#histogram_B_level').html(stats.level);
                $('#histogram_B_count').html(stats.count);
                $('#histogram_B_mean').html(stats.mean);
                $('#histogram_B_median').html(stats.median);
                $('#histogram_B_stddev').html(stats.sigma);
                $('#histogram_B_percentil').html(stats.percentil);
                if (stats.begin == 0 && stats.end == 255) $('#histogram_B svg rect').css('fill-opacity', 0);
                else $('#histogram_B svg rect').css('fill-opacity', 0.75);
                $('#histogram_B svg rect').attr('x', 1+stats.begin);
                $('#histogram_B svg rect').attr('width', stats.end-stats.begin+1);
            }, Dragger: { Images: { High: 'url(images/cur_low.gif)' }}});
        },
        onOpen: function() {
            var info = analyseColors();
            $('#histogram_logarithmic').prop('checked', true);
            histogramUpdateHistogram();
            $('#histogram_RGB_select_bar').barLevel('reset');
            $('#histogram_R_select_bar').barLevel('reset');
            $('#histogram_G_select_bar').barLevel('reset');
            $('#histogram_B_select_bar').barLevel('reset');
            $('#histogram_channel').val('RGB');
            $('#histogram_channel').change();
            if (Context.Depth == 'Grayscale') {
                $('#histogram_channel').hide();
                $('#histogram_label_black').show();
                $('#histogram_label_black').css('display:inline-block;');
            } else {
                $('#histogram_channel').show();
                $('#histogram_label_black').hide();
                $('#histogram_channel').css('display:inline-block;');
            }
            $('#histogram_dims').html($('#src').width()+' × '+$('#src').height());
            $('#histogram_pixels').html($('#src').width()*$('#src').height());
            $('#histogram_colors').html(info.count);
            $('#histogram_gc').html('false');
            var chans = 'RGB';
            var chanscnt = 3;
            if (info.bitmap) {
                chans = 'Bitmap';
                chanscnt = 1;
            } else if (info.grayscale) {
                chans = 'Grayscale';
                chanscnt = 1;
            }
            if (info.alpha) {
                chans += ' + Alpha';
                chanscnt++;
            }
            $('#histogram_chans').html(chanscnt+' ('+chans+')');
            
        },
        onClose: function() {

        },
        onOk: function() {

        },
        onCancel: function() {

        },
        onApply: function () {

        },
        onReset: function () {

        }
    });
});

function histogramUpdateHistogram() {
    var img = $('#src').get(0);
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    var hist = histogram_array(imageData, [0,1,2]);
    $('#dialog_histogram').data('hist', hist);
    rgb_histogram(hist, ['#histogram_R_histogram', '#histogram_G_histogram', '#histogram_B_histogram'], ['#FF0000', '#00FF00', '#0000FF'], '#histogram_RGB_histogram', $('#histogram_logarithmic').is(':checked'));
}
</script>

    <div class="dialog" id="dialog_histogram">
        <div class="bar"><div class="caption">Histogram</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div style="margin-top:3px;">
                        <div style="margin-bottom:6px;"><label style="display:inline-block;" for="histogram_channel">Channel:&nbsp;<span id="histogram_label_black" style="display:none;">Gray</span></label><select tabindex="-1" id="histogram_channel"><option value="RGB">RGB</option><option value="R">Red</option><option value="G">Green</option><option value="B">Blue</option></select></div>
                        <div class="histogram_channels">
                            <div id="histogram_RGB" class="histogram_channel top">
                            <div>
                                    <div style="width:258px;height:102px;position:relative;"><canvas id="histogram_RGB_histogram" width="256" height="100" style="z-index:3010;border: 1px solid black;background-color:white;position:absolute;top:0;left:0;"></canvas><svg style="z-index:3020;mix-blend-mode:multiply;position:absolute;top:0;left:0;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 258 102"><rect x="1" y="1" width="256" height="100" style="stroke-width:0;fill:gray;fill-opacity:0;" /></svg></div>
                                    <div style="width:256px;height:8px;background-image:url(images/degrad.gif); background-repeat:repeat-y; border:1px solid black;border-top:none;"></div>
                                    <div id="histogram_RGB_select_bar"></div>
                                    <div style="display:table;margin-top:8px;"><div style="display:table-row;"><div style="display:table-cell;width:150px;">Level: <span id="histogram_RGB_level"></span></div><div style="display:table-cell;">Mean: <span id="histogram_RGB_mean"></span></div></div></div>
                                    <div style="display:table;margin-top:3px;"><div style="display:table-row;"><div style="display:table-cell;width:150px;">Percentil: <span id="histogram_RGB_percentil"></span></div><div style="display:table-cell;">Median: <span id="histogram_RGB_median"></span></div></div></div>
                                    <div style="display:table;margin-top:3px;margin-bottom:8px;"><div style="display:table-row;"><div style="display:table-cell;width:150px;">Count: <span id="histogram_RGB_count"></span></div><div style="display:table-cell;">Std dev: <span id="histogram_RGB_stddev"></span></div></div></div>
                            </div>
                            </div>
                            <div id="histogram_R" class="histogram_channel">
                                    <div style="width:258px;height:102px;position:relative;"><canvas id="histogram_R_histogram" width="256" height="100" style="z-index:3010;border: 1px solid black;background-color:white;position:absolute;top:0;left:0;"></canvas><svg style="z-index:3020;mix-blend-mode:multiply;position:absolute;top:0;left:0;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 258 102"><rect x="1" y="1" width="256" height="100" style="stroke-width:0;fill:gray;fill-opacity:0;" /></svg></div>
                                    <div style="width:256px;height:8px;background-image:url(images/degrad.gif); background-repeat:repeat-y; border:1px solid black;border-top:none;"></div>
                                    <div id="histogram_R_select_bar"></div>
                                    <div style="display:table;margin-top:8px;"><div style="display:table-row;"><div style="display:table-cell;width:150px;">Level: <span id="histogram_R_level"></span></div><div style="display:table-cell;">Mean: <span id="histogram_R_mean"></span></div></div></div>
                                    <div style="display:table;margin-top:3px;"><div style="display:table-row;"><div style="display:table-cell;width:150px;">Percentil: <span id="histogram_R_percentil"></span></div><div style="display:table-cell;">Median: <span id="histogram_R_median"></span></div></div></div>
                                    <div style="display:table;margin-top:3px;margin-bottom:8px;"><div style="display:table-row;"><div style="display:table-cell;width:150px;">Count: <span id="histogram_R_count"></span></div><div style="display:table-cell;">Std dev: <span id="histogram_R_stddev"></span></div></div></div>
                            </div>
                            <div id="histogram_G" class="histogram_channel">
                                    <div style="width:258px;height:102px;position:relative;"><canvas id="histogram_G_histogram" width="256" height="100" style="z-index:3010;border: 1px solid black;background-color:white;position:absolute;top:0;left:0;"></canvas><svg style="z-index:3020;mix-blend-mode:multiply;position:absolute;top:0;left:0;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 258 102"><rect x="1" y="1" width="256" height="100" style="stroke-width:0;fill:gray;fill-opacity:0;" /></svg></div>
                                    <div style="width:256px;height:8px;background-image:url(images/degrad.gif); background-repeat:repeat-y; border:1px solid black;border-top:none;"></div>
                                    <div id="histogram_G_select_bar"></div>
                                    <div style="display:table;margin-top:8px;"><div style="display:table-row;"><div style="display:table-cell;width:150px;">Level: <span id="histogram_G_level"></span></div><div style="display:table-cell;">Mean: <span id="histogram_G_mean"></span></div></div></div>
                                    <div style="display:table;margin-top:3px;"><div style="display:table-row;"><div style="display:table-cell;width:150px;">Percentil: <span id="histogram_G_percentil"></span></div><div style="display:table-cell;">Median: <span id="histogram_G_median"></span></div></div></div>
                                    <div style="display:table;margin-top:3px;margin-bottom:8px;"><div style="display:table-row;"><div style="display:table-cell;width:150px;">Count: <span id="histogram_G_count"></span></div><div style="display:table-cell;">Std dev: <span id="histogram_G_stddev"></span></div></div></div>
                            </div>
                            <div id="histogram_B" class="histogram_channel">
                                    <div style="width:258px;height:102px;position:relative;"><canvas id="histogram_B_histogram" width="256" height="100" style="z-index:3010;border: 1px solid black;background-color:white;position:absolute;top:0;left:0;"></canvas><svg style="z-index:3020;mix-blend-mode:multiply;position:absolute;top:0;left:0;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 258 102"><rect x="1" y="1" width="256" height="100" style="stroke-width:0;fill:gray;fill-opacity:0;" /></svg></div>
                                    <div style="width:256px;height:8px;background-image:url(images/degrad.gif); background-repeat:repeat-y; border:1px solid black;border-top:none;"></div>
                                    <div id="histogram_B_select_bar"></div>
                                    <div style="display:table;margin-top:8px;"><div style="display:table-row;"><div style="display:table-cell;width:150px;">Level: <span id="histogram_B_level"></span></div><div style="display:table-cell;">Mean: <span id="histogram_B_mean"></span></div></div></div>
                                    <div style="display:table;margin-top:3px;"><div style="display:table-row;"><div style="display:table-cell;width:150px;">Percentil: <span id="histogram_B_percentil"></span></div><div style="display:table-cell;">Median: <span id="histogram_B_median"></span></div></div></div>
                                    <div style="display:table;margin-top:3px;margin-bottom:8px;"><div style="display:table-row;"><div style="display:table-cell;width:150px;">Count: <span id="histogram_B_count"></span></div><div style="display:table-cell;">Std dev: <span id="histogram_B_stddev"></span></div></div></div>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top:3px;"><input id="histogram_logarithmic" type="checkbox" checked><label for="histogram_logarithmic" style="display:inline;">Logarithmic histogram</label></div>
                    <div style="margin-top:12px;">Dimensions: <span id="histogram_dims">0</span></div>
                    <div style="margin-top:3px;">Pixels: <span id="histogram_pixels">0</span></div>
                    <div style="margin-top:3px;">Distinct colors: <span id="histogram_colors">0</span></div>
                    <div style="margin-top:3px;">Channels: <span id="histogram_chans"></span></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button" style="width:72px;">Ok</button>
            </div>
        </div>
        </div>
    </div>

<script>
function makePixelate() {
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    ctx.putImageData(pixelate(imageData, parseInt($('#pixelate_bar input').val())), 0, 0);
    return canvas.toDataURL('image/png');
}

$(function() {
    $('#dialog_pixelate').Dialog({
        onInit: function() {
            $('#pixelate_bar').barInput({Min:2, Max:128, Default:16, Label:'Cell Size'});
        },
        onClose: function() {
            $('#pixelate_bar').barInput('reset');
        },
        onOk: function() {
            $('#dst').attr('src', makePixelate());
            makeOk("Pixelate");
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            $('#dst').attr('src', makePixelate());
        },
        onReset: function () {
            $('#pixelate_bar').barInput('reset');
        }

    });
});
</script>

    <div class="dialog" id="dialog_pixelate">
        <div class="bar"><div class="caption">Pixelate</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div id="pixelate_bar"></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>
    
<script>
function makeMedian() {
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    var val = parseInt($('#median_bar input').val());
    ctx.putImageData(median(imageData, Math.round(val)), 0, 0);
    return canvas.toDataURL('image/png');
}

$(function() {
    $('#dialog_median').Dialog({
        onInit: function() {
            $('#median_bar').barInput({Min:1,Max:250,Default:4,Label:'Radius'});
        },
        onClose: function() {
            $('#median_bar').barInput('reset');
        },
        onOk: function() {
            $('#dst').attr('src', makeMedian());
            makeOk("Median");
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            $('#dst').attr('src', makeMedian());
        },
        onReset: function () {
            $('#median_bar').barInput('reset');
        }

    });
});
</script>

    <div class="dialog" id="dialog_median">
        <div class="bar"><div class="caption">Median</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div id="median_bar"></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>
    
<script>
function makeGaussian() {
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    var val = parseFloat($('#gaussian_bar input').val());
    
    ctx.putImageData(Filters.gaussianBlur(imageData, val), 0, 0);
    //ctx.putImageData(gaussianBlur(imageData, val), 0, 0);
    //ctx.putImageData(gaussianBlurGimp(imageData, val), 0, 0);
    return canvas.toDataURL('image/png');
}

$(function() {
    $('#dialog_gaussian').Dialog({
        onInit: function() {
            $('#gaussian_bar').barInput({Min:0.1, Max:250, Default:5, Label:'Radius', Float:true});
        },
        onClose: function() {
            $('#gaussian_bar').barInput('reset');
        },
        onOk: function() {
            $('#dst').attr('src', makeGaussian());
            makeOk("Gaussian Blur");
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            $('#dst').attr('src', makeGaussian());
        },
        onReset: function () {
            $('#gaussian_bar').barInput('reset');
        }

    });
});
</script>

    <div class="dialog" id="dialog_gaussian">
        <div class="bar"><div class="caption">Gaussian Blur</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div id="gaussian_bar"></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>
    

<script>
function makeDistorSine() {
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    var val = parseInt($('#distorsine_bar input').val());
    val *= -1;
    val = val * 0.005;
    if (val == 0) ctx.putImageData(imageData, 0, 0);
    else ctx.putImageData(Filters.distortSine(imageData, val, val), 0, 0);
    return canvas.toDataURL('image/png');
}

$(function() {
    $('#dialog_distorsine').Dialog({
        onInit: function() {
            $('#distorsine_bar').barInput({Min:-100, Max:100, Default:50, HalfScale:true, Label:'Amount'});
        },
        onClose: function() {
            $('#distorsine_bar').barInput('reset');
        },
        onOk: function() {
            $('#dst').attr('src', makeDistorSine());
            makeOk("Sine Distortion");
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            $('#dst').attr('src', makeDistorSine());
        },
        onReset: function () {
            $('#distorsine_bar').barInput('reset');
        }

    });
});
</script>

    <div class="dialog" id="dialog_distorsine">
        <div class="bar"><div class="caption">Sine Distortion</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div id="distorsine_bar"></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>
    
    <script>
function makeNoise() {
    if ($('#noise_monochrome').is(':checked')) {
        try {
            var glfxcanvas = fx.canvas();
            var img = $('#src').get(0);
            var texture = glfxcanvas.texture(img);
            glfxcanvas.draw(texture).noise(
                parseInt($('#noise_bar input').val(), 10)/1000
            ).update();
            $('#dst').attr('src', glfxcanvas.toDataURL('image/png'));
        } catch (e) {
            $('#mb_unsupported_glfx').messageBox('open');
            console.log(e);
        }
    } else {
        var img = $('#src').get(0);
        if (img.width == 0 || img.height == 0) return null;
        var canvas = document.createElement("canvas");
        canvas.width = img.width;
        canvas.height = img.height;
        var ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);
        var imageData = ctx.getImageData(0,0,img.width, img.height);
        var val = parseInt($('#noise_bar input').val(), 10);
        if (val == 0) ctx.putImageData(imageData, 0, 0);
        else ctx.putImageData(noise(imageData, val), 0, 0);
        $('#dst').attr('src', canvas.toDataURL('image/png'));
    }
}

$(function() {
    $('#dialog_noise').Dialog({
        onInit: function() {
            $('#noise_bar').barInput({Min:1, Max:1000, Default:32, Label:'Amount'});
        },
        onOpen: function() {
        },
        onClose: function() {
            $('#noise_bar').barInput('reset');
            $('#noise_monochrome').prop('checked', false);
        },
        onOk: function() {
            makeNoise();
            makeOk("Add Noise");
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            makeNoise();
        },
        onReset: function () {
            $('#noise_bar').barInput('reset');
            $('#noise_monochrome').prop('checked', false);
        }

    });
});
</script>

    <div class="dialog" id="dialog_noise">
        <div class="bar"><div class="caption">Noise</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div id="noise_bar"></div>
                    <div style="margin-top:10px;"><input id="noise_monochrome" type="checkbox"><label for="noise_monochrome" style="display:inline;"> Monochrome</label></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>
    
<script>
function makeBoxBlur() {
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    var val = parseInt($('#boxblur_bar input').val());
    if (val == 0) ctx.putImageData(imageData, 0, 0);
    else ctx.putImageData(boxBlur(imageData, val), 0, 0);
    return canvas.toDataURL('image/png');
}

$(function() {
    $('#dialog_boxblur').Dialog({
        onInit: function() {
            $('#boxblur_bar').barInput({Min:1, Max:250, Default:5, Label:'Radius'});
        },
        onOpen: function() {
        },
        onClose: function() {
            $('#boxblur_bar').barInput('reset');
        },
        onOk: function() {
            $('#dst').attr('src', makeBoxBlur());
            makeOk("Box Blur");
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            $('#dst').attr('src', makeBoxBlur());
        },
        onReset: function () {
            $('#boxblur_bar').barInput('reset');
        }

    });
});
</script>

    <div class="dialog" id="dialog_boxblur">
        <div class="bar"><div class="caption">Box Blur</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div id="boxblur_bar"></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>
<script>
function makeUnsharpMask() {
    var img = $('#src').get(0);
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    ctx.putImageData(unsharpMask(imageData,
        parseFloat($('#unsharpmask_radius_bar input').val()),
        parseFloat($('#unsharpmask_amount_bar input').val()),
        parseInt($('#unsharpmask_threshold_bar input').val())
    ), 0, 0);
    $('#dst').attr('src', canvas.toDataURL('image/png'));
}
$(function() {
    $('#dialog_unsharpmask').Dialog({
        onInit: function() {
            $('#unsharpmask_radius_bar').barInput({Min:0.1, Max:250, Default:15, Float:true, Label:'Radius'});
            $('#unsharpmask_amount_bar').barInput({Min:0, Max:10, Default:0.5, Float:true, Label:'Amount'});
            $('#unsharpmask_threshold_bar').barInput({Min:0, Max:255, Default:0, Float:false, Label:'Threshold'});
        },
        onOpen: function() {
        },
        onClose: function() {
            $('#unsharpmask_radius_bar').barInput('reset');
            $('#unsharpmask_amount_bar').barInput('reset');
            $('#unsharpmask_threshold_bar').barInput('reset');
        },
        onOk: function() {
            $('#dst').attr('src', makeUnsharpMask());
            makeOk("Unsharp Mask");
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            $('#dst').attr('src', makeUnsharpMask());
        },
        onReset: function () {
            $('#unsharpmask_radius_bar').barInput('reset');
            $('#unsharpmask_amount_bar').barInput('reset');
            $('#unsharpmask_threshold_bar').barInput('reset');
        }

    });
});
</script>

    <div class="dialog" id="dialog_unsharpmask">
        <div class="bar"><div class="caption">Unsharp Mask</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div id="unsharpmask_radius_bar"></div>
                    <div id="unsharpmask_amount_bar"></div>
                    <div id="unsharpmask_threshold_bar"></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>
<script>
function makeDiffGauss() {
    var img = $('#src').get(0);
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    ctx.putImageData(diffGauss(imageData,
        parseFloat($('#diffgauss_radius1_bar input').val()),
        parseFloat($('#diffgauss_radius2_bar input').val()),
        $('#diffgauss_normalize').is(':checked'),
        $('#diffgauss_invert').is(':checked')
    ), 0, 0);
    $('#dst').attr('src', canvas.toDataURL('image/png'));
}
$(function() {
    $('#dialog_diffgauss').Dialog({
        onInit: function() {
            $('#diffgauss_radius1_bar').barInput({Min:0, Max:200, Default:3, Float:true, Label:'Inner Radius'});
            $('#diffgauss_radius2_bar').barInput({Min:0, Max:200, Default:1, Float:true, Label:'Outer Radius'});
        },
        onOpen: function() {
        },
        onClose: function() {
            $('#diffgauss_radius1_bar').barInput('reset');
            $('#diffgauss_radius2_bar').barInput('reset');
            $('#diffgauss_normalize').prop('checked', true);
            $('#diffgauss_invert').prop('checked', true);
        },
        onOk: function() {
            $('#dst').attr('src', makeDiffGauss());
            makeOk("Difference of Gaussians");
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            $('#dst').attr('src', makeDiffGauss());
        },
        onReset: function () {
            $('#diffgauss_radius1_bar').barInput('reset');
            $('#diffgauss_radius2_bar').barInput('reset');
            $('#diffgauss_normalize').prop('checked', true);
            $('#diffgauss_invert').prop('checked', true);
        }

    });
});
</script>

    <div class="dialog" id="dialog_diffgauss">
        <div class="bar"><div class="caption">Difference of Gaussians</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div id="diffgauss_radius1_bar"></div>
                    <div id="diffgauss_radius2_bar"></div>
                    <div style="margin-top:10px;"><input id="diffgauss_normalize" type="checkbox" checked><label for="diffgauss_normalize" style="display:inline;"> Normalize</label></div>
                    <div style="margin-top:5px;"><input id="diffgauss_invert" type="checkbox" checked><label for="diffgauss_invert" style="display:inline;"> Invert</label></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>

<script>
$(function() {
    $('#mb_unsupported').messageBox({text:'Only PNG, JPEG, WEBP and GIF are handled.'});
});
</script>
    <div id="mb_unsupported" class="messageBox error"></div>
    
<script>
function colbal_reset() {
    $('#colbal_midtones_cyan-red_bar').barInput('reset');
    $('#colbal_midtones_magenta-green_bar').barInput('reset');
    $('#colbal_midtones_yellow-blue_bar').barInput('reset');
    $('#colbal_shadows_cyan-red_bar').barInput('reset');
    $('#colbal_shadows_magenta-green_bar').barInput('reset');
    $('#colbal_shadows_yellow-blue_bar').barInput('reset');
    $('#colbal_highlights_cyan-red_bar').barInput('reset');
    $('#colbal_highlights_magenta-green_bar').barInput('reset');
    $('#colbal_highlights_yellow-blue_bar').barInput('reset');
    $('#dialog_colbal .colbal_tone').removeClass('top');
    $('#colbal_midtones_tab').addClass('top');
    $('#colbal_tone').val('midtones');
    $('#colbal_preserve').prop('checked', true);
}
function colbal_collect() {
    var params = {midtones:{},shadows:{},highlights:{},preserve_luminosity:false};
    params.midtones.cyan_red = parseInt($('#colbal_midtones_cyan-red_bar input').val(), 10);
    params.midtones.magenta_green = parseInt($('#colbal_midtones_magenta-green_bar input').val(), 10);
    params.midtones.yellow_blue = parseInt($('#colbal_midtones_yellow-blue_bar input').val(), 10);
    params.shadows.cyan_red = parseInt($('#colbal_shadows_cyan-red_bar input').val(), 10);
    params.shadows.magenta_green = parseInt($('#colbal_shadows_magenta-green_bar input').val(), 10);
    params.shadows.yellow_blue = parseInt($('#colbal_shadows_yellow-blue_bar input').val(), 10);
    params.highlights.cyan_red = parseInt($('#colbal_highlights_cyan-red_bar input').val(), 10);
    params.highlights.magenta_green = parseInt($('#colbal_highlights_magenta-green_bar input').val(), 10);
    params.highlights.yellow_blue = parseInt($('#colbal_highlights_yellow-blue_bar input').val(), 10);
    if ($('#colbal_preserve').is(':checked')) params.preserve_luminosity = true;
    return params;
}

function makeColbal() {
    var params = colbal_collect();
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    ctx.putImageData(colorBalance(imageData, params), 0, 0);
    return canvas.toDataURL('image/png');
}

$(function() {
    $('#dialog_colbal').Dialog({
        onInit: function() {
            $('#colbal_midtones_cyan-red_bar').barInput({Min:-100,Max:100,Default:0,HalfScale:true,Label:'<div style="background-color:cyan;" class="minipal"></div> Cyan',Label2:'Red <div style="background-color:red;" class="minipal"></div>',Dragger:{Color:'gray'}});
            $('#colbal_midtones_magenta-green_bar').barInput({Min:-100,Max:100,Default:0,HalfScale:true,Label:'<div style="background-color:magenta;" class="minipal"></div> Magenta',Label2:'Green <div style="background-color:green;" class="minipal"></div>',Dragger:{Color:'gray'}});
            $('#colbal_midtones_yellow-blue_bar').barInput({Min:-100,Max:100,Default:0,HalfScale:true,Label:'<div style="background-color:yellow;" class="minipal"></div> Yellow',Label2:'Blue <div style="background-color:blue;" class="minipal"></div>',Dragger:{Color:'gray'}});
            $('#colbal_shadows_cyan-red_bar').barInput({Min:-100,Max:100,Default:0,HalfScale:true,Label:'<div style="background-color:cyan;" class="minipal"></div> Cyan',Label2:'Red <div style="background-color:red;" class="minipal"></div>',Dragger:{Color:'black'}});
            $('#colbal_shadows_magenta-green_bar').barInput({Min:-100,Max:100,Default:0,HalfScale:true,Label:'<div style="background-color:magenta;" class="minipal"></div> Magenta',Label2:'Green <div style="background-color:green;" class="minipal"></div>',Dragger:{Color:'black'}});
            $('#colbal_shadows_yellow-blue_bar').barInput({Min:-100,Max:100,Default:0,HalfScale:true,Label:'<div style="background-color:yellow;" class="minipal"></div> Yellow',Label2:'Blue <div style="background-color:blue;" class="minipal"></div>',Dragger:{Color:'black'}});
            $('#colbal_highlights_cyan-red_bar').barInput({Min:-100,Max:100,Default:0,HalfScale:true,Label:'<div style="background-color:cyan;" class="minipal"></div> Cyan',Label2:'Red <div style="background-color:red;" class="minipal"></div>'});
            $('#colbal_highlights_magenta-green_bar').barInput({Min:-100,Max:100,Default:0,HalfScale:true,Label:'<div style="background-color:magenta;" class="minipal"></div> Magenta',Label2:'Green <div style="background-color:green;" class="minipal"></div>'});
            $('#colbal_highlights_yellow-blue_bar').barInput({Min:-100,Max:100,Default:0,HalfScale:true,Label:'<div style="background-color:yellow;" class="minipal"></div> Yellow',Label2:'Blue <div style="background-color:blue;" class="minipal"></div>'});
            
            $('#colbal_tone').change(function (e) {
                $('#dialog_colbal .colbal_tone').removeClass('top');
                $('#colbal_'+$(e.target).val()+'_tab').addClass('top');
            });
        },
        onClose: function() {
            colbal_reset();
        },
        onOk: function() {
            $('#dst').attr('src', makeColbal());
            makeOk("Color Balance");
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            $('#dst').attr('src', makeColbal());
        },
        onReset: function () {
            colbal_reset();
        }
    });

});
</script>
    
    <div class="dialog" id="dialog_colbal">
        <div class="bar"><div class="caption">Color Balance</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div style="margin-top:3px;"><label style="display:inline-block;">Tones range:&nbsp;</label><select id="colbal_tone"><option value="shadows">Shadows</option><option value="midtones" selected>Midtones</option><option value="highlights">Highlights</option></select></div>
                    <div class="colbal_tones">
                        <fieldset id="colbal_midtones_tab" class="subfieldset colbal_tone top">
                        <legend>Midtones</legend>
                            <div id="colbal_midtones_cyan-red_bar"></div>
                            <div id="colbal_midtones_magenta-green_bar"></div>
                            <div id="colbal_midtones_yellow-blue_bar"></div>
                        </fieldset>
                        
                        <fieldset id="colbal_shadows_tab" class="subfieldset colbal_tone">
                        <legend>Shadows</legend>
                            <div id="colbal_shadows_cyan-red_bar"></div>
                            <div id="colbal_shadows_magenta-green_bar"></div>
                            <div id="colbal_shadows_yellow-blue_bar"></div>
                        </fieldset>

                        <fieldset id="colbal_highlights_tab" class="subfieldset colbal_tone">
                        <legend>Highlights</legend>
                            <div id="colbal_highlights_cyan-red_bar"></div>
                            <div id="colbal_highlights_magenta-green_bar"></div>
                            <div id="colbal_highlights_yellow-blue_bar"></div>
                        </fieldset>
                    </div>
                    <div style="margin-top:10px;"><input id="colbal_preserve" type="checkbox" checked><label for="colbal_preserve" style="display:inline;"> Preserve luminosity</label></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>
<script>
$(function() {
    $('#mb_unsupported_glfx').messageBox({text:"WebGL is not supported by your browser.<br>This filter is not working."});
});
</script>
    <div id="mb_unsupported_glfx" class="messageBox bomb"></div>
<script>
function showNub(nub1, nub2) {
    var width = $('#src').width();
    var height = $('#src').height();
    window.nub1posx = false;
    window.nub1posy = false;
    window.nub2posx = false;
    window.nub2posy = false;
    window.nubline = false;
    if (typeof nub2 !== 'undefined') {
        window.nub1posx = Math.round(width/4);
        window.nub1posy = Math.round(height/4);
        window.nub2posx = Math.round(width/4*3);
        window.nub2posy = Math.round(height/4*3);
        window.nubviewbox = width+' '+height;
        window.nubline = true;
    }
    $('#containment').append('<div id="nub_containment" style="background-blend-mode:difference;"></div>');
    $('#nub_containment').width(width);
    $('#nub_containment').height(height);
    $('#nub_containment').append('<div id="nub1"></div>');
    $('#nub1').Nub({
        onChange(x, y) {
            $(nub1.xid).val(coordToImage(x));
            $(nub1.yid).val(coordToImage(y));
            if (window.nubline) {
                window.nub1posx = x;
                window.nub1posy = y;
                $('#nub_containment').css('background', 'url(data:image/svg+xml;base64,'
                + btoa('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 '+window.nubviewbox+'"><line x1="'+window.nub1posx+'" y1="'+window.nub1posy+'" x2="'+window.nub2posx+'" y2="'+window.nub2posy+'" stroke="#FFFFFF" stroke-width="1" /></svg>') + ')');
            }
        }, x:window.nub1posx, y:window.nub1posy
    });
    if (typeof nub2 !== 'undefined') {
        $('#nub_containment').append('<div id="nub2"></div>');
        $('#nub2').Nub({
            onChange(x, y) {
                $(nub2.xid).val(coordToImage(x));
                $(nub2.yid).val(coordToImage(y));
                if (window.nubline) {
                    window.nub2posx = x;
                    window.nub2posy = y;
                    $('#nub_containment').css('background', 'url(data:image/svg+xml;base64,'
                    + btoa('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 '+window.nubviewbox+'"><line x1="'+window.nub1posx+'" y1="'+window.nub1posy+'" x2="'+window.nub2posx+'" y2="'+window.nub2posy+'" stroke="#FFFFFF" stroke-width="1" /></svg>') + ')');
                }
            }, x:window.nub2posx, y:window.nub2posy
        });
    }
}
function hideNub(nub1, nub2) {
    window.nub1posx = false;
    window.nub1posy = false;
    window.nub2posx = false;
    window.nub2posy = false;
    window.nubline = false;
    $('#nub_containment').remove();
    $(nub1.xid).val(0);
    $(nub1.yid).val(0);
    if (typeof nub2 !== 'undefined') {
        $(nub2.xid).val(0);
        $(nub2.yid).val(0);
    }
}
function makePinch() {
    try {
        var glfxcanvas = fx.canvas();
        var img = $('#src').get(0);
        var texture = glfxcanvas.texture(img);
        glfxcanvas.draw(texture).bulgePinch(
            parseInt($('#pinch_x').val(), 10),
            parseInt($('#pinch_y').val(), 10),
            parseInt($('#pinch_radius_bar input').val(), 10),
            parseInt($('#pinch_strength_bar input').val(), 10) / 100
        ).update();
        $('#dst').attr('src', glfxcanvas.toDataURL('image/png'));
    } catch (e) {
        $('#mb_unsupported_glfx').messageBox('open');
        console.log(e);
    }    
}
$(function() {
    $('#dialog_pinch').Dialog({
        onInit: function() {
            $('#pinch_strength_bar').barInput({Min:-100, Max:100, Default:50, HalfScale:true, Label:'Strength'});
            $('#pinch_radius_bar').barInput({Min:0, Max:600, Default:200, Label:'Radius'});
        },
        onOpen: function() {
            saveCurrentZoom();
            if (!zoomFitsWorkArea()) zoomFitToWorkArea();
            $('#dst').attr('src', $('#src').attr('src'));
            $('#src').hide();
            showNub({xid:'#pinch_x', yid:'#pinch_y'});
        },
        onClose: function() {
            $('#src').show();
            $('#pinch_strength_bar').barInput('reset');
            $('#pinch_radius_bar').barInput('reset');
            hideNub({xid:'#pinch_x', yid:'#pinch_y'});
            restoreSavedZoom();
        },
        onOk: function() {
            $('#dst').attr('src', makePinch());
            makeOk("Pinch");
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            $('#dst').attr('src', makePinch());
        },
        onReset: function () {
            $('#pinch_strength_bar').barInput('reset');
            $('#pinch_radius_bar').barInput('reset');
            $('#dst').attr('src', $('#src').attr('src'));
            hideNub({xid:'#pinch_x', yid:'#pinch_y'});
            showNub({xid:'#pinch_x', yid:'#pinch_y'});
        }

    });
});
</script>
    <div class="dialog" id="dialog_pinch">
        <div class="bar"><div class="caption">Pinch</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div style="margin-top:3px;margin-left:6px;height:18px;">Center: <div style="float:right;margin-right:6px;"><label for="pinch_x" style="display:inline-block;">X:&nbsp;</label><input readonly id="pinch_x" type="text" value="0" maxlength="4" size="4" style="text-align:right;">&nbsp;<label for="pinch_y" style="display:inline-block;">Y:&nbsp;</label><input readonly id="pinch_y" type="text" value="0" maxlength="4" size="4" style="text-align:right;"></div></div>
                    <div style="margin-top:20px;" id="pinch_strength_bar"></div>
                    <div id="pinch_radius_bar"></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>
<script>
function makeZoom() {
    try {
        var glfxcanvas = fx.canvas();
        var img = $('#src').get(0);
        var texture = glfxcanvas.texture(img);
        glfxcanvas.draw(texture).zoomBlur(
            parseInt($('#zoom_x').val(), 10),
            parseInt($('#zoom_y').val(), 10),
            parseInt($('#zoom_strength_bar input').val(), 10) / 100
        ).update();
        $('#dst').attr('src', glfxcanvas.toDataURL('image/png'));
    } catch (e) {
        $('#mb_unsupported_glfx').messageBox('open');
        console.log(e);
    }    
}
$(function() {
    $('#dialog_zoom').Dialog({
        onInit: function() {
            $('#zoom_strength_bar').barInput({Min:0, Max:100, Default:40, Label:'Strength'});
        },
        onOpen: function() {
            saveCurrentZoom();
            if (!zoomFitsWorkArea()) zoomFitToWorkArea();
            showNub({xid:'#zoom_x', yid:'#zoom_y'});
        },
        onClose: function() {
            $('#zoom_strength_bar').barInput('reset');
            $('#zoom_radius_bar').barInput('reset');
            hideNub({xid:'#zoom_x', yid:'#zoom_y'});
            restoreSavedZoom();
        },
        onOk: function() {
            $('#dst').attr('src', makeZoom());
            makeOk("Zoom Blur");
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            $('#dst').attr('src', makeZoom());
        },
        onReset: function () {
            $('#zoom_strength_bar').barInput('reset');
            $('#zoom_radius_bar').barInput('reset');
            $('#dst').attr('src', $('#src').attr('src'));
            hideNub({xid:'#zoom_x', yid:'#zoom_y'});
            showNub({xid:'#zoom_x', yid:'#zoom_y'});
        }

    });
});
</script>
    <div class="dialog" id="dialog_zoom">
        <div class="bar"><div class="caption">Zoom Blur</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div style="margin-top:3px;margin-left:6px;height:18px;">Center: <div style="float:right;margin-right:6px;"><label for="zoom_x" style="display:inline-block;">X:&nbsp;</label><input readonly id="zoom_x" type="text" value="0" maxlength="4" size="4" style="text-align:right;">&nbsp;<label for="zoom_y" style="display:inline-block;">Y:&nbsp;</label><input readonly id="zoom_y" type="text" value="0" maxlength="4" size="4" style="text-align:right;"></div></div>
                    <div style="margin-top:20px;" id="zoom_strength_bar"></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>
<script>
function makeTwirl() {
    try {
        var glfxcanvas = fx.canvas();
        var img = $('#src').get(0);
        var texture = glfxcanvas.texture(img);
        glfxcanvas.draw(texture).swirl(
            parseInt($('#twirl_x').val(), 10),
            parseInt($('#twirl_y').val(), 10),
            parseInt($('#twirl_radius_bar input').val(), 10),
            parseInt($('#twirl_angle_bar input').val(), 10) / 10
        ).update();
        $('#dst').attr('src', glfxcanvas.toDataURL('image/png'));
    } catch (e) {
        $('#mb_unsupported_glfx').messageBox('open');
        console.log(e);
    }    
}
$(function() {
    $('#dialog_twirl').Dialog({
        onInit: function() {
            $('#twirl_angle_bar').barInput({Min:-250, Max:250, Default:50, HalfScale:true, Label:'Angle'});
            $('#twirl_radius_bar').barInput({Min:0, Max:600, Default:200, Label:'Radius'});
        },
        onOpen: function() {
            saveCurrentZoom();
            if (!zoomFitsWorkArea()) zoomFitToWorkArea();
            $('#dst').attr('src', $('#src').attr('src'));
            $('#src').hide();
            showNub({xid:'#twirl_x', yid:'#twirl_y'});
        },
        onClose: function() {
            $('#src').show();
            $('#twirl_angle_bar').barInput('reset');
            $('#twirl_radius_bar').barInput('reset');
            hideNub({xid:'#twirl_x', yid:'#twirl_y'});
            restoreSavedZoom();
        },
        onOk: function() {
            $('#dst').attr('src', makeTwirl());
            makeOk("Twirl");
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            $('#dst').attr('src', makeTwirl());
        },
        onReset: function () {
            $('#twirl_angle_bar').barInput('reset');
            $('#twirl_radius_bar').barInput('reset');
            $('#dst').attr('src', $('#src').attr('src'));
            hideNub({xid:'#twirl_x', yid:'#twirl_y'});
            showNub({xid:'#twirl_x', yid:'#twirl_y'});
        }

    });
});
</script>
    <div class="dialog" id="dialog_twirl">
        <div class="bar"><div class="caption">Twirl</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div style="margin-top:3px;margin-left:6px;height:18px;">Center: <div style="float:right;margin-right:6px;"><label for="twirl_x" style="display:inline-block;">X:&nbsp;</label><input readonly id="twirl_x" type="text" value="0" maxlength="4" size="4" style="text-align:right;">&nbsp;<label for="twirl_y" style="display:inline-block;">Y:&nbsp;</label><input readonly id="twirl_y" type="text" value="0" maxlength="4" size="4" style="text-align:right;"></div></div>
                    <div style="margin-top:20px;" id="twirl_angle_bar"></div>
                    <div id="twirl_radius_bar"></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>
<script>
function makeHalftone() {
    try {
        var glfxcanvas = fx.canvas();
        var img = $('#src').get(0);
        var texture = glfxcanvas.texture(img);
        if ($('#halftone_bw').is(':checked')) {
            glfxcanvas.draw(texture).dotScreen(
                parseInt($('#halftone_x').val(), 10),
                parseInt($('#halftone_y').val(), 10),
                parseFloat($('#halftone_angle_bar input').val())/180*Math.PI,
                parseFloat($('#halftone_size_bar input').val())
            ).update();
        } else {
            glfxcanvas.draw(texture).colorHalftone(
                parseInt($('#halftone_x').val(), 10),
                parseInt($('#halftone_y').val(), 10),
                parseFloat($('#halftone_angle_bar input').val())/180*Math.PI,
                parseFloat($('#halftone_size_bar input').val())
            ).update();
        }
        $('#dst').attr('src', glfxcanvas.toDataURL('image/png'));
    } catch (e) {
        $('#mb_unsupported_glfx').messageBox('open');
        console.log(e);
    }    
}

$(function() {
    $('#dialog_halftone').Dialog({
        onInit: function() {
            $('#halftone_angle_bar').barInput({Min:0, Max:90, Default:15, Float:true, Label:'Angle'});
            $('#halftone_size_bar').barInput({Min:3, Max:20, Default:4, Float:true, Label:'Size'});
            $('#halftone_bw').click(function() {
                if ($('#halftone_bw').is(':checked')) {
                    $('#halftone_angle_bar').barInput('update', {Value: 75});
                    $('#halftone_size_bar').barInput('update', {Value: 3});
                } else {
                    $('#halftone_angle_bar').barInput('reset');
                    $('#halftone_size_bar').barInput('reset');
                }
            });
        },
        onOpen: function() {
            saveCurrentZoom();
            if (!zoomFitsWorkArea()) zoomFitToWorkArea();
            $('#dst').attr('src', $('#src').attr('src'));
            $('#src').hide();
            showNub({xid:'#halftone_x', yid:'#halftone_y'});
        },
        onClose: function() {
            $('#src').show();
            $('#halftone_angle_bar').barInput('reset');
            $('#halftone_size_bar').barInput('reset');
            $('#halftone_bw').prop('checked', false);
            hideNub({xid:'#halftone_x', yid:'#halftone_y'});
            restoreSavedZoom();
        },
        onOk: function() {
            $('#dst').attr('src', makeHalftone());
            makeOk("Halftone");
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            $('#dst').attr('src', makeHalftone());
        },
        onReset: function () {
            $('#halftone_angle_bar').barInput('reset');
            $('#halftone_size_bar').barInput('reset');
            $('#halftone_bw').prop('checked', false);
            $('#dst').attr('src', $('#src').attr('src'));
            hideNub({xid:'#halftone_x', yid:'#halftone_y'});
            showNub({xid:'#halftone_x', yid:'#halftone_y'});
        }

    });
});
</script>
    <div class="dialog" id="dialog_halftone">
        <div class="bar"><div class="caption">Halftone</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div style="margin-top:3px;margin-left:6px;height:18px;">Center: <div style="float:right;margin-right:6px;"><label for="halftone_x" style="display:inline-block;">X:&nbsp;</label><input readonly id="halftone_x" type="text" value="0" maxlength="4" size="4" style="text-align:right;">&nbsp;<label for="halftone_y" style="display:inline-block;">Y:&nbsp;</label><input readonly id="halftone_y" type="text" value="0" maxlength="4" size="4" style="text-align:right;"></div></div>
                    <div style="margin-top:20px;" id="halftone_angle_bar"></div>
                    <div id="halftone_size_bar"></div>
                    <div style="margin-top:10px;"><input id="halftone_bw" type="checkbox"><label for="halftone_bw" style="display:inline;"> Black and white</label></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>


<script>
function makeLensBlur() {
    try {
        var glfxcanvas = fx.canvas();
        var img = $('#src').get(0);
        var texture = glfxcanvas.texture(img);
        glfxcanvas.draw(texture).lensBlur(
            parseInt($('#lensblur_radius_bar input').val(), 10),
            parseInt($('#lensblur_brightness_bar input').val(), 10)/100,
            parseInt($('#lensblur_angle_bar input').val(), 10)/180*Math.PI
        ).update();
        $('#dst').attr('src', glfxcanvas.toDataURL('image/png'));
    } catch (e) {
        $('#mb_unsupported_glfx').messageBox('open');
        console.log(e);
    }    
}

$(function() {
    $('#dialog_lensblur').Dialog({
        onInit: function() {
            $('#lensblur_radius_bar').barInput({Min:0, Max:50, Default:10, Label:'Radius'});
            $('#lensblur_brightness_bar').barInput({Min:-100, Max:100, Default:75, HalfScale:true, Label:'Brightness'});
            $('#lensblur_angle_bar').barInput({Min:-180, Max:180, Default:0, HalfScale:true, Label:'Angle'});
        },
        onOpen: function() {
            $('#dst').attr('src', $('#src').attr('src'));
            $('#src').hide();
        },
        onClose: function() {
            $('#src').show();
            $('#lensblur_radius_bar').barInput('reset');
            $('#lensblur_brightness_bar').barInput('reset');
            $('#lensblur_angle_bar').barInput('reset');
        },
        onOk: function() {
            $('#dst').attr('src', makeLensBlur());
            makeOk("Lens Blur");
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            $('#dst').attr('src', makeLensBlur());
        },
        onReset: function () {
            $('#lensblur_radius_bar').barInput('reset');
            $('#lensblur_brightness_bar').barInput('reset');
            $('#lensblur_angle_bar').barInput('reset');
            $('#dst').attr('src', $('#src').attr('src'));
        }

    });
});
</script>
    <div class="dialog" id="dialog_lensblur">
        <div class="bar"><div class="caption">Lens Blur</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div id="lensblur_radius_bar"></div>
                    <div id="lensblur_brightness_bar"></div>
                    <div id="lensblur_angle_bar"></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>

<script>
    $(function() {
        $('#dialog_exposure').Dialog({
            onInit: function() {
                $('#exposure_stops').barInput({Min:-20, Max:20, Default:0, Float:true, HalfScale:true, Label:'Exposure'});
                $('#exposure_offset').barInput({Min:-0.5, Max:0.5, Default:0, Float:true, FloatPrecision:2, HalfScale:true, Label:'Offset'});
                $('#exposure_gamma').barInput({Min:0.1, Max:9.9, Default:1, Float:true, FloatPrecision:2, Label:'Gamma'});
            },
            onOpen: function() {
                $('#dst').attr('src', $('#src').attr('src'));
                $('#src').hide();
            },
            onClose: function() {
                $('#src').show();
                $('#exposure_stops').barInput('reset');
                $('#exposure_offset').barInput('reset');
                $('#exposure_gamma').barInput('reset');
            },
            onOk: function() {
                IMExposure($('#src'), parseFloat($('#exposure_stops input').val()), parseFloat($('#exposure_offset input').val()), parseFloat($('#exposure_gamma input').val()), $('#dst'));
                makeOk("Exposure");
            },
            onCancel: function() {
                makeCancel();
            },
            onApply: function () {
                IMExposure($('#src'), parseFloat($('#exposure_stops input').val()), parseFloat($('#exposure_offset input').val()), parseFloat($('#exposure_gamma input').val()), $('#dst'));
            },
            onReset: function () {
                $('#exposure_stops').barInput('reset');
                $('#exposure_offset').barInput('reset');
                $('#exposure_gamma').barInput('reset');
                $('#dst').attr('src', $('#src').attr('src'));
            }
    
        });
    });
</script>
    <div class="dialog" id="dialog_exposure">
        <div class="bar"><div class="caption">Exposure</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div id="exposure_stops"></div>
                    <div id="exposure_offset"></div>
                    <div id="exposure_gamma"></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
                <a href="https://imagemagick.org/" target="_blank"><div class="IM" title="Powered by Image Magick"></div></a>
            </div>
        </div>
        </div>
    </div>

<script>
function makeTriangleBlur() {
    try {
        var glfxcanvas = fx.canvas();
        var img = $('#src').get(0);
        var texture = glfxcanvas.texture(img);
        glfxcanvas.draw(texture).triangleBlur(
            parseInt($('#triangleblur_radius_bar input').val(), 10)
        ).update();
        $('#dst').attr('src', glfxcanvas.toDataURL('image/png'));
    } catch (e) {
        $('#mb_unsupported_glfx').messageBox('open');
        console.log(e);
    }
}

$(function() {
    $('#dialog_triangleblur').Dialog({
        onInit: function() {
            $('#triangleblur_radius_bar').barInput({Min:0, Max:200, Default:50, Label:'Radius'});
        },
        onOpen: function() {
            $('#dst').attr('src', $('#src').attr('src'));
            $('#src').hide();
        },
        onClose: function() {
            $('#src').show();
            $('#triangleblur_radius_bar').barInput('reset');
        },
        onOk: function() {
            $('#dst').attr('src', makeTriangleBlur());
            makeOk("Triangle Blur");
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            $('#dst').attr('src', makeTriangleBlur());
        },
        onReset: function () {
            $('#triangleblur_radius_bar').barInput('reset');
            $('#dst').attr('src', $('#src').attr('src'));
        }

    });
});
</script>
    <div class="dialog" id="dialog_triangleblur">
        <div class="bar"><div class="caption">Triangle Blur</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div id="triangleblur_radius_bar"></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>

<script>
function makeVibrance() {
    try {
        var glfxcanvas = fx.canvas();
        var img = $('#src').get(0);
        var texture = glfxcanvas.texture(img);
        glfxcanvas.draw(texture).vibrance(
            parseInt($('#vibrance_bar input').val(), 10)/100
        ).hueSaturation(0,
            parseInt($('#vibrance_saturation_bar input').val(), 10)/100
        ).update();
        $('#dst').attr('src', glfxcanvas.toDataURL('image/png'));
    } catch (e) {
        $('#mb_unsupported_glfx').messageBox('open');
        console.log(e);
    }
}

$(function() {
    $('#dialog_vibrance').Dialog({
        onInit: function() {
            $('#vibrance_bar').barInput({Min:-100, Max:100, Default:0, HalfScale:true, Label:'Vibrance'});
            $('#vibrance_saturation_bar').barInput({Min:-100, Max:100, Default:0, HalfScale:true, Label:'Saturation'});
        },
        onOpen: function() {
            $('#dst').attr('src', $('#src').attr('src'));
            $('#src').hide();
        },
        onClose: function() {
            $('#src').show();
            $('#vibrance_bar').barInput('reset');
            $('#vibrance_saturation_bar').barInput('reset');
        },
        onOk: function() {
            $('#dst').attr('src', makeVibrance());
            makeOk("Vibrance");
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            $('#dst').attr('src', makeVibrance());
        },
        onReset: function () {
            $('#vibrance_bar').barInput('reset');
            $('#vibrance_saturation_bar').barInput('reset');
            $('#dst').attr('src', $('#src').attr('src'));
        }

    });
});
</script>
    <div class="dialog" id="dialog_vibrance">
        <div class="bar"><div class="caption">Vibrance</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div id="vibrance_bar"></div>
                    <div id="vibrance_saturation_bar"></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>


<script>
function makeSepia() {
    try {
        var glfxcanvas = fx.canvas();
        var img = $('#src').get(0);
        var texture = glfxcanvas.texture(img);
        glfxcanvas.draw(texture).sepia(
            parseInt($('#sepia_bar input').val(), 10)/100
        ).update();
        $('#dst').attr('src', glfxcanvas.toDataURL('image/png'));
    } catch (e) {
        $('#mb_unsupported_glfx').messageBox('open');
        console.log(e);
    }
}

$(function() {
    $('#dialog_sepia').Dialog({
        onInit: function() {
            $('#sepia_bar').barInput({Min:0, Max:100, Default:100, Label:'Amount'});
        },
        onOpen: function() {
            $('#dst').attr('src', $('#src').attr('src'));
            $('#src').hide();
        },
        onClose: function() {
            $('#src').show();
            $('#sepia_bar').barInput('reset');
        },
        onOk: function() {
            $('#dst').attr('src', makeSepia());
            makeOk("Sepia");
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            $('#dst').attr('src', makeSepia());
        },
        onReset: function () {
            $('#sepia_bar').barInput('reset');
            $('#dst').attr('src', $('#src').attr('src'));
        }

    });
});
</script>
    <div class="dialog" id="dialog_sepia">
        <div class="bar"><div class="caption">Sepia</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div id="sepia_bar"></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>


    <script>
        
        $(function() {
            $('#dialog_charcoal').Dialog({
                onInit: function() {
                    $('#charcoal_radius').barInput({Float:true, Min:1, Max:50, Default:2, Label:'Radius'});
                    $('#charcoal_sigma').barInput({Float:true, Min:0, Max:10, Default:0.5, Label:'Sigma'});
                },
                onOpen: function() {
                    $('#dst').attr('src', $('#src').attr('src'));
                    $('#src').hide();
                },
                onClose: function() {
                    $('#src').show();
                    $('#charcoal_radius').barInput('reset');
                    $('#charcoal_sigma').barInput('reset');
                },
                onOk: function() {
                    IMCharcoal($('#src'), $('#charcoal_radius input').val(), $('#charcoal_sigma input').val(), $('#dst'));
                    makeOk("Charcoal");
                },
                onCancel: function() {
                    makeCancel();
                },
                onApply: function () {
                    IMCharcoal($('#src'), $('#charcoal_radius input').val(), $('#charcoal_sigma input').val(), $('#dst'));
                },
                onReset: function () {
                    $('#charcoal_radius').barInput('reset');
                    $('#charcoal_sigma').barInput('reset');
                    $('#dst').attr('src', $('#src').attr('src'));
                }
        
            });
        });
        </script>
            <div class="dialog" id="dialog_charcoal">
                <div class="bar"><div class="caption">Charcoal</div></div>
                <div class="border">
                <div class="zone">
                    <div class="main">
                        <fieldset class="white">
                            <div id="charcoal_radius"></div>
                            <div id="charcoal_sigma"></div>
                        </fieldset>
                    </div>
                    <div class="buttons">
                        <button class="btn_ok main" type="button">Ok</button>
                        <button class="btn_cancel" type="button">Cancel</button>
                        <button class="btn_reset" type="button">Reset</button>
                        <button class="btn_apply" type="button">Preview</button>
                        <a href="https://imagemagick.org/" target="_blank"><div class="IM" title="Powered by Image Magick"></div></a>
                    </div>
                </div>
                </div>
            </div>
        


            <script>
        
                $(function() {
                    $('#dialog_sketch').Dialog({
                        onInit: function() {
                            $('#sketch_radius').barInput({Float:true, Min:1, Max:50, Default:4.4, Label:'Radius'});
                            $('#sketch_sigma').barInput({Float:true, Min:0, Max:10, Default:5, Label:'Sigma'});
                            $('#sketch_angle').barInput({Float:false, Min:-180, Max:180, Default:-45, Label:'Angle',HalfScale:true});
                        },
                        onOpen: function() {
                            $('#dst').attr('src', $('#src').attr('src'));
                            $('#src').hide();
                        },
                        onClose: function() {
                            $('#src').show();
                            $('#sketch_radius').barInput('reset');
                            $('#sketch_sigma').barInput('reset');
                            $('#sketch_angle').barInput('reset');
                        },
                        onOk: function() {
                            IMSketch($('#src'), $('#sketch_radius input').val(), $('#sketch_sigma input').val(), $('#sketch_angle input').val(), $('#dst'));
                            makeOk("Sketch");
                        },
                        onCancel: function() {
                            makeCancel();
                        },
                        onApply: function () {
                            IMSketch($('#src'), $('#sketch_radius input').val(), $('#sketch_sigma input').val(), $('#sketch_angle input').val(), $('#dst'));
                        },
                        onReset: function () {
                            $('#sketch_radius').barInput('reset');
                            $('#sketch_sigma').barInput('reset');
                            $('#sketch_angle').barInput('reset');
                            $('#dst').attr('src', $('#src').attr('src'));
                        }
                
                    });
                });
                </script>
                    <div class="dialog" id="dialog_sketch">
                        <div class="bar"><div class="caption">Sketch</div></div>
                        <div class="border">
                        <div class="zone">
                            <div class="main">
                                <fieldset class="white">
                                    <div id="sketch_radius"></div>
                                    <div id="sketch_sigma"></div>
                                    <div id="sketch_angle"></div>
                                </fieldset>
                            </div>
                            <div class="buttons">
                                <button class="btn_ok main" type="button">Ok</button>
                                <button class="btn_cancel" type="button">Cancel</button>
                                <button class="btn_reset" type="button">Reset</button>
                                <button class="btn_apply" type="button">Preview</button>
                                <a href="https://imagemagick.org/" target="_blank"><div class="IM" title="Powered by Image Magick"></div></a>
                            </div>
                        </div>
                        </div>
                    </div>

<script>
function makeInk() {
    try {
        var glfxcanvas = fx.canvas();
        var img = $('#src').get(0);
        var texture = glfxcanvas.texture(img);
        glfxcanvas.draw(texture).ink(
            parseInt($('#ink_bar input').val(), 10)/100
        ).update();
        $('#dst').attr('src', glfxcanvas.toDataURL('image/png'));
    } catch (e) {
        $('#mb_unsupported_glfx').messageBox('open');
        console.log(e);
    }
}

$(function() {
    $('#dialog_ink').Dialog({
        onInit: function() {
            $('#ink_bar').barInput({Min:0, Max:100, Default:25, Label:'Strength'});
        },
        onOpen: function() {
            $('#dst').attr('src', $('#src').attr('src'));
            $('#src').hide();
        },
        onClose: function() {
            $('#src').show();
            $('#ink_bar').barInput('reset');
        },
        onOk: function() {
            $('#dst').attr('src', makeInk());
            makeOk("Ink");
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            $('#dst').attr('src', makeInk());
        },
        onReset: function () {
            $('#ink_bar').barInput('reset');
            $('#dst').attr('src', $('#src').attr('src'));
        }

    });
});
</script>
    <div class="dialog" id="dialog_ink">
        <div class="bar"><div class="caption">Ink</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div id="ink_bar"></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>

<script>
function makeEdgeWork() {
    try {
        var glfxcanvas = fx.canvas();
        var img = $('#src').get(0);
        var texture = glfxcanvas.texture(img);
        glfxcanvas.draw(texture).edgeWork(
            parseInt($('#edgework_bar input').val(), 10)
        ).update();
        $('#dst').attr('src', glfxcanvas.toDataURL('image/png'));
    } catch (e) {
        $('#mb_unsupported_glfx').messageBox('open');
        console.log(e);
    }
}

$(function() {
    $('#dialog_edgework').Dialog({
        onInit: function() {
            $('#edgework_bar').barInput({Min:0, Max:200, Default:10, Label:'Radius'});
        },
        onOpen: function() {
            $('#dst').attr('src', $('#src').attr('src'));
            $('#src').hide();
        },
        onClose: function() {
            $('#src').show();
            $('#edgework_bar').barInput('reset');
        },
        onOk: function() {
            $('#dst').attr('src', makeEdgeWork());
            makeOk("Edge Work");
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            $('#dst').attr('src', makeEdgeWork());
        },
        onReset: function () {
            $('#edgework_bar').barInput('reset');
            $('#dst').attr('src', $('#src').attr('src'));
        }

    });
});
</script>
    <div class="dialog" id="dialog_edgework">
        <div class="bar"><div class="caption">Edge Work</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div id="edgework_bar"></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>

<script>
function makeDenoise() {
    try {
        var glfxcanvas = fx.canvas();
        var img = $('#src').get(0);
        var texture = glfxcanvas.texture(img);
        glfxcanvas.draw(texture).denoise(
            parseInt($('#denoise_bar input').val(), 10)
        ).update();
        $('#dst').attr('src', glfxcanvas.toDataURL('image/png'));
    } catch (e) {
        $('#mb_unsupported_glfx').messageBox('open');
        console.log(e);
    }
}

$(function() {
    $('#dialog_denoise').Dialog({
        onInit: function() {
            $('#denoise_bar').barInput({Min:0, Max:50, Default:20, Label:'Exponent'});
        },
        onOpen: function() {
            $('#dst').attr('src', $('#src').attr('src'));
            $('#src').hide();
        },
        onClose: function() {
            $('#src').show();
            $('#denoise_bar').barInput('reset');
        },
        onOk: function() {
            $('#dst').attr('src', makeDenoise());
            makeOk("Denoise");
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            $('#dst').attr('src', makeDenoise());
        },
        onReset: function () {
            $('#denoise_bar').barInput('reset');
            $('#dst').attr('src', $('#src').attr('src'));
        }

    });
});
</script>
    <div class="dialog" id="dialog_denoise">
        <div class="bar"><div class="caption">Denoise</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div id="denoise_bar"></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>

<script>
function makeHexagonalPixelate() {
    try {
        var glfxcanvas = fx.canvas();
        var img = $('#src').get(0);
        var texture = glfxcanvas.texture(img);
        glfxcanvas.draw(texture).hexagonalPixelate(
            parseInt($('#hexagonalpixelate_x').val(), 10),
            parseInt($('#hexagonalpixelate_y').val(), 10),
            parseInt($('#hexagonalpixelate_bar input').val(), 10)
        ).update();
        $('#dst').attr('src', glfxcanvas.toDataURL('image/png'));
    } catch (e) {
        $('#mb_unsupported_glfx').messageBox('open');
        console.log(e);
    }
}

$(function() {
    $('#dialog_hexagonalpixelate').Dialog({
        onInit: function() {
            $('#hexagonalpixelate_bar').barInput({Min:5, Max:100, Default:20, Label:'Scale'});
        },
        onOpen: function() {
            saveCurrentZoom();
            if (!zoomFitsWorkArea()) zoomFitToWorkArea();
            $('#dst').attr('src', $('#src').attr('src'));
            $('#src').hide();
            showNub({xid:'#hexagonalpixelate_x', yid:'#hexagonalpixelate_y'});
        },
        onClose: function() {
            $('#src').show();
            $('#hexagonalpixelate_bar').barInput('reset');
            hideNub({xid:'#hexagonalpixelate_x', yid:'#hexagonalpixelate_y'});
            restoreSavedZoom();
        },
        onOk: function() {
            $('#dst').attr('src', makeHexagonalPixelate());
            makeOk("Hexagonal Pixelate");
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            $('#dst').attr('src', makeHexagonalPixelate());
        },
        onReset: function () {
            $('#hexagonalpixelate_bar').barInput('reset');
            $('#dst').attr('src', $('#src').attr('src'));
            hideNub({xid:'#hexagonalpixelate_x', yid:'#hexagonalpixelate_y'});
            showNub({xid:'#hexagonalpixelate_x', yid:'#hexagonalpixelate_y'});
        }

    });
});

</script>
    <div class="dialog" id="dialog_hexagonalpixelate">
        <div class="bar"><div class="caption">Hexagonal Pixelate</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div style="margin-top:3px;margin-left:6px;height:18px;">Center: <div style="float:right;margin-right:6px;"><label for="hexagonalpixelate_x" style="display:inline-block;">X:&nbsp;</label><input readonly id="hexagonalpixelate_x" type="text" value="0" maxlength="4" size="4" style="text-align:right;">&nbsp;<label for="hexagonalpixelate_y" style="display:inline-block;">Y:&nbsp;</label><input readonly id="hexagonalpixelate_y" type="text" value="0" maxlength="4" size="4" style="text-align:right;"></div></div>
                    <div style="margin-top:20px;" id="hexagonalpixelate_bar"></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>

<script>
function makeVignette() {
    try {
        var glfxcanvas = fx.canvas();
        var img = $('#src').get(0);
        var texture = glfxcanvas.texture(img);
        glfxcanvas.draw(texture).vignette(
            parseInt($('#vignette_size_bar input').val(), 10)/100,
            parseInt($('#vignette_amount_bar input').val(), 10)/100
        ).update();
        $('#dst').attr('src', glfxcanvas.toDataURL('image/png'));
    } catch (e) {
        $('#mb_unsupported_glfx').messageBox('open');
        console.log(e);
    }
}

$(function() {
    $('#dialog_vignette').Dialog({
        onInit: function() {
            $('#vignette_size_bar').barInput({Min:0, Max:100, Default:50, Label:'Size'});
            $('#vignette_amount_bar').barInput({Min:0, Max:100, Default:50, Label:'Amount'});
        },
        onOpen: function() {
            $('#dst').attr('src', $('#src').attr('src'));
            $('#src').hide();
        },
        onClose: function() {
            $('#src').show();
            $('#vignette_size_bar').barInput('reset');
            $('#vignette_amount_bar').barInput('reset');
        },
        onOk: function() {
            $('#dst').attr('src', makeVignette());
            makeOk("Vignette");
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            $('#dst').attr('src', makeVignette());
        },
        onReset: function () {
            $('#vignette_size_bar').barInput('reset');
            $('#vignette_amount_bar').barInput('reset');
            $('#dst').attr('src', $('#src').attr('src'));
        }

    });
});
</script>
    <div class="dialog" id="dialog_vignette">
        <div class="bar"><div class="caption">Vignette</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div id="vignette_size_bar"></div>
                    <div id="vignette_amount_bar"></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>

<script>
function makeTiltShift() {
    try {
        var glfxcanvas = fx.canvas();
        var img = $('#src').get(0);
        var texture = glfxcanvas.texture(img);
        glfxcanvas.draw(texture).tiltShift(
            parseInt($('#tiltshift_A_x').val(), 10),
            parseInt($('#tiltshift_A_y').val(), 10),
            parseInt($('#tiltshift_B_x').val(), 10),
            parseInt($('#tiltshift_B_y').val(), 10),
            parseInt($('#tiltshift_blur_bar input').val(), 10),
            parseInt($('#tiltshift_gradiant_bar input').val(), 10)
        ).update();
        $('#dst').attr('src', glfxcanvas.toDataURL('image/png'));
    } catch (e) {
        $('#mb_unsupported_glfx').messageBox('open');
        console.log(e);
    }
}

$(function() {
    $('#dialog_tiltshift').Dialog({
        onInit: function() {
            $('#tiltshift_blur_bar').barInput({Min:0, Max:50, Default:15, Label:'Blur Radius'});
            $('#tiltshift_gradiant_bar').barInput({Min:0, Max:400, Default:200, Label:'Gradient Radius'});
        },
        onOpen: function() {
            saveCurrentZoom();
            if (!zoomFitsWorkArea()) zoomFitToWorkArea();
            $('#dst').attr('src', $('#src').attr('src'));
            $('#src').hide();
            showNub({xid:'#tiltshift_A_x', yid:'#tiltshift_A_y'}, {xid:'#tiltshift_B_x', yid:'#tiltshift_B_y'});
        },
        onClose: function() {
            $('#src').show();
            $('#tiltshift_blur_bar').barInput('reset');
            hideNub({xid:'#tiltshift_A_x', yid:'#tiltshift_A_y'}, {xid:'#tiltshift_B_x', yid:'#tiltshift_B_y'});
            restoreSavedZoom();
        },
        onOk: function() {
            $('#dst').attr('src', makeTiltShift());
            makeOk("Tilt Shift");
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            $('#dst').attr('src', makeTiltShift());
        },
        onReset: function () {
            $('#tiltshift_blur_bar').barInput('reset');
            $('#dst').attr('src', $('#src').attr('src'));
            hideNub({xid:'#tiltshift_A_x', yid:'#tiltshift_A_y'}, {xid:'#tiltshift_B_x', yid:'#tiltshift_B_y'});
            showNub({xid:'#tiltshift_A_x', yid:'#tiltshift_A_y'}, {xid:'#tiltshift_B_x', yid:'#tiltshift_B_y'});
        }

    });
});

</script>
    <div class="dialog" id="dialog_tiltshift">
        <div class="bar"><div class="caption">Tilt Shift</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div style="margin-top:3px;margin-left:6px;height:18px;">Point A: <div style="float:right;margin-right:6px;"><label for="tiltshift_A_x" style="display:inline-block;">X:&nbsp;</label><input readonly id="tiltshift_A_x" type="text" value="0" maxlength="4" size="4" style="text-align:right;">&nbsp;<label for="tiltshift_A_y" style="display:inline-block;">Y:&nbsp;</label><input readonly id="tiltshift_A_y" type="text" value="0" maxlength="4" size="4" style="text-align:right;"></div></div>
                    <div style="margin-top:10px;margin-left:6px;height:18px;">Point B: <div style="float:right;margin-right:6px;"><label for="tiltshift_B_x" style="display:inline-block;">X:&nbsp;</label><input readonly id="tiltshift_B_x" type="text" value="0" maxlength="4" size="4" style="text-align:right;">&nbsp;<label for="tiltshift_B_y" style="display:inline-block;">Y:&nbsp;</label><input readonly id="tiltshift_B_y" type="text" value="0" maxlength="4" size="4" style="text-align:right;"></div></div>
                    <div style="margin-top:20px;" id="tiltshift_blur_bar"></div>
                    <div id="tiltshift_gradiant_bar"></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>

<script>
function makeOil() {
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    ctx.putImageData(ImageFilters.Oil(imageData,
         parseInt($('#oil_range_bar input').val(), 10),
         parseInt($('#oil_levels_bar input').val(), 10)
    ), 0, 0);
    return canvas.toDataURL('image/png');
}

$(function() {
    $('#dialog_oil').Dialog({
        onInit: function() {
            $('#oil_range_bar').barInput({Min:1,Max:20,Default:2,Label:'Range'});
            $('#oil_levels_bar').barInput({Min:1,Max:256,Default:32,Label:'Levels'});
        },
        onClose: function() {
            $('#oil_range_bar').barInput('reset');
            $('#oil_levels_bar').barInput('reset');
        },
        onOk: function() {
            $('#dst').attr('src', makeOil());
            makeOk("Painting");
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            $('#dst').attr('src', makeOil());
        },
        onReset: function () {
            $('#oil_range_bar').barInput('reset');
            $('#oil_levels_bar').barInput('reset');
        }

    });
});
</script>

    <div class="dialog" id="dialog_oil">
        <div class="bar"><div class="caption">Painting</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div id="oil_range_bar"></div>
                    <div id="oil_levels_bar"></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>

    <script>
        
        $(function() {
            let onKernelParamsChange = () => {
                let $morphologyKernel = $('#morphologyKernel');
                let $morphologyKernelParams = $('#morphologyKernelParams');
                let $kernelPreview = $('#kernelPreview');
                $kernelPreview.attr('src', 'images/kern_' + $morphologyKernel.val() + '-' + $morphologyKernelParams.val() + '.gif');
            }
            let onKernelChange = () => {
                let $morphologyKernel = $('#morphologyKernel');
                let $morphologyKernelParams = $('#morphologyKernelParams');
                let k = $morphologyKernel.val();
                $morphologyKernelParams.empty();
                for (const params of IMEnumKernels[k]) {
                    let $opt = $('<option />');
                    $opt.val(params);
                    $opt.text(params);
                    $morphologyKernelParams.append($opt);
                }
                onKernelParamsChange();
            }
            $('#morphologyKernel').on('change', onKernelChange);
            $('#morphologyKernelParams').on('change', onKernelParamsChange);
            $('#dialog_morphology').Dialog({
                onInit: function() {
                    onKernelChange();
                },
                onOpen: function() {
                    $('#dst').attr('src', $('#src').attr('src'));
                    $('#src').hide();
                },
                onClose: function() {
                    $('#src').show();
                },
                onOk: function() {
                    IMMorphology($('#src'), $('#morphologyMethod').val(), $('#morphologyKernel').val() + ':' +  $('#morphologyKernelParams').val(), $('#dst'));
                    makeOk("Morphology");
                },
                onCancel: function() {
                    makeCancel();
                },
                onApply: function () {
                    IMMorphology($('#src'), $('#morphologyMethod').val(), $('#morphologyKernel').val() + ':' +  $('#morphologyKernelParams').val(), $('#dst'));
                },
                onReset: function () {
                    $('#dst').attr('src', $('#src').attr('src'));
                }
        
            });
        });
        </script>
            <div class="dialog" id="dialog_morphology">
                <div class="bar"><div class="caption">Morphology</div></div>
                <div class="border">
                <div class="zone">
                    <div class="main">
                        <fieldset class="white">
                            <div id="morphology_method">
                                <label style="display:inline-block; width: 90px;" for="morphologyMethod">Method</label>
                                <select id="morphologyMethod">
                                    <option value="Correlate">Correlate</option>
                                    <option value="Convolve">Convolve</option>
                                    <option value="Dilate" selected>Dilate</option>
                                    <option value="Erode">Erode</option>
                                    <option value="Close">Close</option>
                                    <option value="Open">Open</option>
                                    <option value="DilateIntensity">Dilate Intensity</option>
                                    <option value="ErodeIntensity">Erode Intensity</option>
                                    <option value="CloseIntensity">Close Intensity</option>
                                    <option value="OpenIntensity">Open Intensity</option>
                                    <option value="DilateI">Dilate I</option>
                                    <option value="ErodeI">Erode I</option>
                                    <option value="CloseI">Close I</option>
                                    <option value="OpenI">Open I</option>
                                    <option value="Smooth">Smooth</option>
                                    <option value="EdgeOut">EdgeOut</option>
                                    <option value="EdgeIn">EdgeIn</option>
                                    <option value="Edge">Edge</option>
                                    <option value="TopHat">TopHat</option>
                                    <option value="BottomHat">BottomHat</option>
                                    <option value="Hmt">Hmt</option>
                                    <option value="HitNMiss">HitNMiss</option>
                                    <option value="HitAndMiss">HitAndMiss</option>
                                    <option value="Thinning">Thinning</option>
                                    <option value="Thicken">Thicken</option>
                                    <option value="Distance">Distance</option>
                                </select>
                            </div>
                            <div id="morphology_kernel" style="margin-top:3px;">
                                <label style="display:inline-block; width: 90px;" for="morphologyKernel">Kernel</label>
                                <select id="morphologyKernel">
                                    <option value="Square">Square</option>
                                    <option value="Diamond">Diamond</option>
                                    <option value="Octagon" selected>Octagon</option>
                                    <option value="Disk">Disk</option>
                                    <option value="Plus">Plus</option>
                                    <option value="Cross">Cross</option>
                                    <option value="Ring">Ring</option>
                                    <option value="Rectangle">Rectangle</option>
                                </select>
                            </div>
                            <div id="morphology_params" style="margin-top:3px;">
                                <label style="display:inline-block; width: 90px;" for="morphologyKernelParams">Size</label>
                                <select id="morphologyKernelParams"></select>
                            </div>
                            <div style="margin-top:10px;"><label>Kernel preview</label></div>
                            <div style="padding-left: 90px;"><span style="border: 1px solid black; display: inline-block;"><img style="vertical-align: middle;" id="kernelPreview" /></span></div>
                        </fieldset>
                    </div>
                    <div class="buttons">
                        <button class="btn_ok main" type="button">Ok</button>
                        <button class="btn_cancel" type="button">Cancel</button>
                        <button class="btn_reset" type="button">Reset</button>
                        <button class="btn_apply" type="button">Preview</button>
                        <a href="https://imagemagick.org/" target="_blank"><div class="IM" title="Powered by Image Magick"></div></a>
                    </div>
                </div>
                </div>
            </div>

<script>
function makeMotionBlur() {
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    var size = parseInt($('#motionblur_size_bar input').val(), 10);
    size *= 2;
    size++;
    ctx.putImageData(applyPhg1024filter(
        imageData,
        new Phg1024Filter.motion(
           size,
           parseInt($('#motionblur_angle_bar input').val(), 10)
        )
    ), 0, 0);
    return canvas.toDataURL('image/png');
}

$(function() {
    $('#dialog_motionblur').Dialog({
        onInit: function() {
            $('#motionblur_size_bar').barInput({Min:1,Max:50,Default:10,Label:'Radius'});
            $('#motionblur_angle_bar').barInput({Min:0,Max:180,Default:0,Label:'Angle'});
        },
        onClose: function() {
            $('#motionblur_size_bar').barInput('reset');
            $('#motionblur_angle_bar').barInput('reset');
        },
        onOk: function() {
            $('#dst').attr('src', makeMotionBlur());
            makeOk("Motion Blur");
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            $('#dst').attr('src', makeMotionBlur());
        },
        onReset: function () {
            $('#motionblur_size_bar').barInput('reset');
            $('#motionblur_angle_bar').barInput('reset');
        }

    });
});
</script>

    <div class="dialog" id="dialog_motionblur">
        <div class="bar"><div class="caption">Motion Blur</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div id="motionblur_size_bar"></div>
                    <div id="motionblur_angle_bar"></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>

<script>
function makeBilateral() {
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    var size = parseInt($('#bilateral_size_bar input').val(), 10);
    size *= 2;
    size++;
    ctx.putImageData(applyPhg1024Bilateral(
        imageData,
        parseInt($('#bilateral_sigma_bar input').val(), 10),
        parseInt($('#bilateral_amount_bar input').val(), 10),
        size
    ), 0, 0);
    return canvas.toDataURL('image/png');
}

$(function() {
    $('#dialog_bilateral').Dialog({
        onInit: function() {
            $('#bilateral_size_bar').barInput({Min:1,Max:50,Default:4,Label:'Radius'});
            $('#bilateral_sigma_bar').barInput({Min:1,Max:12,Default:6,Label:'Sigma'});
            $('#bilateral_amount_bar').barInput({Min:1,Max:100,Default:50,Label:'Amount'});
        },
        onClose: function() {
            $('#bilateral_size_bar').barInput('reset');
            $('#bilateral_sigma_bar').barInput('reset');
            $('#bilateral_amount_bar').barInput('reset');
        },
        onOk: function() {
            $('#dst').attr('src', makeBilateral());
            makeOk("Bilateral");
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            $('#dst').attr('src', makeBilateral());
        },
        onReset: function () {
            $('#bilateral_size_bar').barInput('reset');
            $('#bilateral_sigma_bar').barInput('reset');
            $('#bilateral_amount_bar').barInput('reset');
        }

    });
});
</script>

    <div class="dialog" id="dialog_bilateral">
        <div class="bar"><div class="caption">Bilateral</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div id="bilateral_size_bar"></div>
                    <div id="bilateral_sigma_bar"></div>
                    <div id="bilateral_amount_bar"></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>

<script>
function makeErosion() {
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    var size = parseInt($('#erosion_size_bar input').val(), 10);
    size *= 2;
    size++;
    ctx.putImageData(applyPhg1024filter(
        imageData,
        new Phg1024Filter.erosion(size, $('#erosion_shape').val())
    ), 0, 0);
    return canvas.toDataURL('image/png');
}

$(function() {
    $('#dialog_erosion').Dialog({
        onInit: function() {
            $('#erosion_size_bar').barInput({Min:1,Max:50,Default:4,Label:'Radius'});
        },
        onClose: function() {
            $('#erosion_size_bar').barInput('reset');
            $('#erosion_shape').val('square');
        },
        onOk: function() {
            $('#dst').attr('src', makeErosion());
            makeOk("Erosion");
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            $('#dst').attr('src', makeErosion());
        },
        onReset: function () {
            $('#erosion_size_bar').barInput('reset');
            $('#erosion_shape').val('square');
        }

    });
});
</script>

    <div class="dialog" id="dialog_erosion">
        <div class="bar"><div class="caption">Erosion</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div id="erosion_size_bar"></div>
                    <div style="margin-top:10px;margin-left:6px;"><label for="erosion_shape" style="display:inline-block;">Shape:&nbsp;</label><select id="erosion_shape"><option value="square">Square</option><option value="round">Round</option><option value="star">Star</option><option value="plus">Plus</option></select></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>
    
<script>
function makeDialation() {
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    var size = parseInt($('#dialation_size_bar input').val(), 10);
    size *= 2;
    size++;
    ctx.putImageData(applyPhg1024filter(
        imageData,
        new Phg1024Filter.dialation(size, $('#dialation_shape').val())
    ), 0, 0);
    return canvas.toDataURL('image/png');
}

$(function() {
    $('#dialog_dialation').Dialog({
        onInit: function() {
            $('#dialation_size_bar').barInput({Min:1,Max:50,Default:4,Label:'Radius'});
        },
        onClose: function() {
            $('#dialation_size_bar').barInput('reset');
            $('#dialation_shape').val('square');
        },
        onOk: function() {
            $('#dst').attr('src', makeDialation());
            makeOk("Dialation");
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            $('#dst').attr('src', makeDialation());
        },
        onReset: function () {
            $('#dialation_size_bar').barInput('reset');
            $('#dialation_shape').val('square');
        }

    });
});
</script>

    <div class="dialog" id="dialog_dialation">
        <div class="bar"><div class="caption">Dialation</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div id="dialation_size_bar"></div>
                    <div style="margin-top:10px;margin-left:6px;"><label for="dialation_shape" style="display:inline-block;">Shape:&nbsp;</label><select id="dialation_shape"><option value="square">Square</option><option value="round">Round</option><option value="star">Star</option><option value="plus">Plus</option></select></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>

<script>

function curves(imageData, lut, rgblut) {
    if (lut !== false) {
        for (var i = 0; i < imageData.data.length; i+=4) {
            for (var u = 0; u < 3; u++) {
                imageData.data[i+u] = lut[u][imageData.data[i+u]];
            }
        }
    }
    for (var i = 0; i < imageData.data.length; i+=4) {
        imageData.data[i] = rgblut[imageData.data[i]];
        imageData.data[i+1] = rgblut[imageData.data[i+1]];
        imageData.data[i+2] = rgblut[imageData.data[i+2]];
    }
    return imageData;
}

function makeCurves() {
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    var lut = false;
    if (Context.Depth !== 'Grayscale') {
        lut = [window.curves_R.lut, window.curves_G.lut, window.curves_B.lut];
    }
    ctx.putImageData(curves(imageData, lut, window.curves_RGB.lut), 0, 0);
    return canvas.toDataURL('image/png');
}


function curves_rgb_histogram(hist255, names, colors, rgbname, type) {
    
    var clear = function (ctx) {
        ctx.beginPath();
        ctx.lineWidth = 0;
        ctx.fillStyle = 'rgba(255,255,255,0)';
        ctx.rect(0, 0, 171, 171);
        ctx.fill();
    };
    
    var setcontext = function (ctx, color) {
        ctx.mozImageSmoothingEnabled = false;
        ctx.webkitImageSmoothingEnabled = false;
        ctx.msImageSmoothingEnabled = false;
        ctx.imageSmoothingEnabled = false;
        ctx.lineWidth = 1;
        ctx.strokeStyle = color;
        ctx.setLineDash([]);
    }

    var drawgrid = function (ctx) {
        ctx.beginPath();
        ctx.mozImageSmoothingEnabled = false;
        ctx.webkitImageSmoothingEnabled = false;
        ctx.msImageSmoothingEnabled = false;
        ctx.imageSmoothingEnabled = false;
        ctx.lineWidth = 1;
        ctx.strokeStyle = 'black';
        ctx.setLineDash([1,1]);
        ctx.moveTo(1, 43.5);
        ctx.lineTo(170, 43.5);
        ctx.stroke();
        ctx.moveTo(1, 85.5);
        ctx.lineTo(170, 85.5);
        ctx.stroke();
        ctx.moveTo(1, 127.5);
        ctx.lineTo(170, 127.5);
        ctx.stroke();
        ctx.moveTo(43.5, 1);
        ctx.lineTo(43.5, 170);
        ctx.stroke();
        ctx.moveTo(85.5, 1);
        ctx.lineTo(85.5, 170);
        ctx.stroke();
        ctx.moveTo(127.5, 1);
        ctx.lineTo(127.5, 170);
        ctx.stroke();
    };
    var rgb = newImageData(171, 171);
    var _rgb = [
        newImageData(171, 171),
        newImageData(171, 171),
        newImageData(171, 171)
    ];



    if (type > 0) {
        // Resize histogram from 255 to 171
        var hist = [];
        for (var i = 0; i < hist255.length; i++) {
            hist[i] = [];
            for (var j = 0; j < hist255[i].length; j++) {
                var n = Math.round(j*2/3);
                if (typeof hist[i][n] === 'undefined') hist[i][n] = [];
                hist[i][n].push(hist255[i][j]);
            }
        }
        for (var i = 0; i < hist.length; i++) {
            for (var j = 0; j < hist[i].length; j++) {
                var t = 0;
                var s = hist[i][j].length;
                for (var k = 0; k < s; k++) {
                    t += hist[i][j][k];
                }
                hist[i][j] = Math.round(t / s);
            }
        }
        
        var _max = 0;
        var lhist = [];
        for (var k = 0; k < hist.length; k++) {
            lhist[k] = [];
            for (var i = 0; i < 171; i++) {
                if (type === '2') lhist[k][i] = Math.log(hist[k][i]);
                else lhist[k][i] = hist[k][i];
                _max = Math.max(_max, lhist[k][i]);
            }
        }
        
        clear(rgb.context);
        setcontext(rgb.context, '#cccccc');
        for (var k = 0; k < hist.length; k++) {
            clear(_rgb[k].context);
            setcontext(_rgb[k].context, colors[k]);
            var __max = 0;
            for (var i = 0; i < lhist[k].length; i++) {
                __max = Math.max(__max, lhist[k][i]);
            }
            for (var i = 0; i < lhist[k].length; i++) {
                _rgb[k].context.beginPath();
                _rgb[k].context.moveTo(i+0.5, 171);
                _rgb[k].context.lineTo(i+0.5, 171 - Math.round(lhist[k][i]/__max*171));
                _rgb[k].context.stroke();
                rgb.context.beginPath();
                rgb.context.moveTo(i+0.5, 171);
                rgb.context.lineTo(i+0.5, 171 - Math.round(lhist[k][i]/_max*171));
                rgb.context.stroke();
            }
            
            drawgrid(_rgb[k].context);
            $(names[k]).css('background-image', 'url('+_rgb[k].canvas.toDataURL('image/png')+')');
        }
    
        drawgrid(rgb.context);
        $(rgbname).css('background-image', 'url('+rgb.canvas.toDataURL('image/png')+')');
        
    } else {
        clear(rgb.context);
        drawgrid(rgb.context);
        $(rgbname).css('background-image', 'url('+rgb.canvas.toDataURL('image/png')+')');
        for (var k = 0; k < hist255.length; k++) {
            clear(_rgb[k].context);
            drawgrid(_rgb[k].context);
            $(names[k]).css('background-image', 'url('+_rgb[k].canvas.toDataURL('image/png')+')');
        }
    }
}


function curvesUpdateHistograms() {
    var img = $('#src').get(0);
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    var hist = histogram_array(imageData, [0,1,2]);
    curves_rgb_histogram(hist, ['#curves_R_tool', '#curves_G_tool', '#curves_B_tool'], ['#ffcccc', '#cce6cc', '#ccccff'], '#curves_RGB_tool', $('#dialog_curves input[name=curves_hist]:checked').val());
}

$(function() {
    $('#dialog_curves').Dialog({
        onInit: function() {
            window.curves_RGB = new curvestool('#curves_RGB_panel', 'curves_RGB_tool', null);
            window.curves_R = new curvestool('#curves_R_panel', 'curves_R_tool', null);
            window.curves_G = new curvestool('#curves_G_panel', 'curves_G_tool', null);
            window.curves_B = new curvestool('#curves_B_panel', 'curves_B_tool', null);
            $('#curves_channel').change(function (e) {
                var val = $(e.delegateTarget).val();
                $('.curves_channel').removeClass('top');
                $('#curves_layer_'+val).addClass('top');
                $('#curves_'+val+'_panel svg').focus();
            });
            $('#dialog_curves input[name=curves_hist]').on('change', function() {
                curvesUpdateHistograms();
                //console.log($('#dialog_curves input[name=curves_hist]:checked').val()); 
            });
        },
        onOpen: function() {
            curvesUpdateHistograms();
            $('#curves_RGB_panel svg').focus();
            if (Context.Depth == 'Grayscale') {
                $('#curves_channel').hide();
                $('#curves_label_black').show();
                $('#curves_label_black').css('display:inline-block;');
            } else {
                $('#curves_channel').show();
                $('#curves_label_black').hide();
                $('#curves_channel').css('display:inline-block;');
            }
        },
        onClose: function() {
            $('#dialog_curves input[name=curves_hist]').prop('checked', false);
            $('#curves_hist_linear').prop('checked', true);
            window.curves_RGB.reset();
            window.curves_R.reset();
            window.curves_G.reset();
            window.curves_B.reset();
            $('#curves_channel').val('RGB');
            $('#curves_channel').change();
        },
        onOk: function() {
            $('#dst').attr('src', makeCurves());
            makeOk("Curves");
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            $('#dst').attr('src', makeCurves());
        },
        onReset: function () {
            $('#dialog_curves input[name=curves_hist]').prop('checked', false);
            $('#curves_hist_linear').prop('checked', true);
            window.curves_RGB.reset();
            window.curves_R.reset();
            window.curves_G.reset();
            window.curves_B.reset();
            $('#curves_channel').val('RGB');
            $('#curves_channel').change();
            $('#curves_RGB_panel svg').focus();
            curvesUpdateHistograms();
        }

    });
});
</script>

    <div class="dialog" id="dialog_curves">
        <div class="bar"><div class="caption">Curves</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset>
                    <legend><label style="display:inline-block;" for="curves_channel">Channel:&nbsp;<span id="curves_label_black" style="display:none;">Gray</span></label><select tabindex="-1" id="curves_channel"><option value="RGB">RGB</option><option value="R">Red</option><option value="G">Green</option><option value="B">Blue</option></select></legend>
                    <div class="curves_channels">
                        <div id="curves_layer_RGB" class="curves_channel top">
                            <div class="curvesbg"><div id="curves_RGB_panel" class="curves"></div></div>
                        </div>
                        <div id="curves_layer_R" class="curves_channel">
                            <div class="curvesbg red"><div id="curves_R_panel" class="curves"></div></div>
                        </div>
                        <div id="curves_layer_G" class="curves_channel">
                            <div class="curvesbg green"><div id="curves_G_panel" class="curves"></div></div>
                        </div>
                        <div id="curves_layer_B" class="curves_channel">
                            <div class="curvesbg blue"><div id="curves_B_panel" class="curves"></div></div>
                        </div>
                    </div>
                    <div style="margin:5px 0 0 4px;"><input id="curves_hist_none" type="radio" name="curves_hist" value="0"><label for="curves_hist_none" style="display:inline;">No histogram</label></div>
                    <div style="margin:0 0 0 4px;"><input id="curves_hist_linear" type="radio" name="curves_hist" value="1" checked><label for="curves_hist_linear" style="display:inline;">Linear histogram</label></div>
                    <div style="margin:0 0 0 4px;"><input id="curves_hist_logarithmic" type="radio" name="curves_hist" value="2"><label for="curves_hist_logarithmic" style="display:inline;">Logarithmic histogram</label></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>



<script>
function makePhotoFilter() {
    var img = $('#src').get(0);
    if (img.width == 0 || img.height == 0) return null;
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var imageData = ctx.getImageData(0,0,img.width, img.height);
    ctx.putImageData(photofilter(imageData, parseInt($('#photofilter_density input').val()), hextocol($('#photofilter_color').val()), $('#photofilter_lumi').is(':checked'), $('#photofilter_mode').val()), 0, 0);
    $('#dst').attr('src', canvas.toDataURL('image/png'));
}

function addPhotoFilters() {
    const filters = [["1A", "skylight (pale pink)", "reduce haze in landscape photography", [245, 236, 240]],
                    ["2A", "pale yellow", "absorb UV radiation", [244, 243, 233]],
                    ["2B", "pale yellow", "absorb UV radiation (slightly less than 2A)", [244, 245, 230]],
                    ["2E", "pale yellow", "absorb UV radiation (slightly more than 2A)", [242, 254, 139]],
                    ["3", "light yellow", "absorb excessive sky blue, make sky darker in black/white photos", [255, 250, 110]],
                    ["6", "light yellow", "absorb excessive sky blue, emphasizing clouds", [253, 247, 3]],
                    ["8", "yellow", "high blue absorption; correction for sky, cloud, and foliage", [247, 241, 0]],
                    ["9", "deep yellow", "moderate contrast in black/white outdoor photography", [255, 228, 0]],
                    ["11", "yellow-green", "correction for tungsten light", [75, 175, 65]],
                    ["12", "deep yellow", "minus blue; reduce haze in aerial photos", [255, 220, 0]],
                    ["15", "deep yellow", "darken sky in black/white outdoor photography", [240, 160, 50]],
                    ["16", "yellow-orange", "stronger version of 15", [237, 140, 20]],
                    ["21", "orange", "contrast filter for blue and blue-green absorption", [245, 100, 50]],
                    ["22", "deep orange", "stronger version of 21", [247, 84, 33]],
                    ["23A", "light red", "contrast effects, darken sky and water", [255, 117, 106]],
                    ["24", "red", "red for two-color photography (daylight or tungsten)", [240, 0, 0]],
                    ["25", "red", "tricolor red; contrast effects in outdoor scenes", [220, 0, 60]],
                    ["26", "red", "stereo red; cuts haze, useful for storm or moonlight settings", [210, 0, 0]],
                    ["29", "deep red", "color separation; extreme sky darkening in black/white photos", [115, 10, 25]],
                    ["32", "magenta", "green absorption", [240, 0, 255]],
                    ["33", "strong green absorption", "variant on 32", [154, 0, 78]],
                    ["34A", "violet", "minus-green and plus-blue separation", [124, 40, 240]],
                    ["38A", "blue", "red absorption; useful for contrast in microscopy", [1, 156, 210]],
                    ["44", "light blue-green", "minus-red, two-color general viewing", [0, 136, 152]],
                    ["44A", "light blue-green", "minus-red, variant on 44", [0, 175, 190]],
                    ["47", "blue tricolor", "direct color separation; contrast effects in commercial photography", [43, 75, 220]],
                    ["47A", "light blue", "enhance blue and purple objects; useful for fluorescent dyes", [0, 15, 150]],
                    ["47B", "deep blue tricolor", "color separation; calibration using SMPTE color bars", [0, 0, 120]],
                    ["56", "very light green", "darkens sky, improves flesh tones", [132, 206, 35]],
                    ["58", "green tricolor", "used for color separation; improves definition of foliage", [40, 110, 5]],
                    ["61", "deep green tricolor", "used for color separation, tungsten tricolor projection", [40, 70, 10]],
                    ["70", "dark red", "infrared photography longpass filter blocking", [62, 0, 0]],
                    ["80A", "blue", "cooling filter, 3200K to 5500K; converts indoor lighting to sunlight", [50, 100, 230]],
                    ["80B", "blue", "variant of 80A, 3400K to 5500K", [70, 120, 230]],
                    ["80C", "blue", "variant of 80A, 3800K to 5500K", [90, 140, 235]],
                    ["80D", "blue", "variant of 80A, 4200K to 5500K", [110, 160, 240]],
                    ["81A", "pale orange", "warming filter (lowers color temperature), 3400 K to 3200 K", [247, 240, 220]],
                    ["81B", "pale orange", "warming filter; slightly stronger than 81A", [242, 232, 205]],
                    ["81C", "pale orange", "warming filter; slightly stronger than 81B", [230, 220, 200]],
                    ["81D", "pale orange", "warming filter; slightly stronger than 81C", [235, 220, 190]],
                    ["81EF", "pale orange", "warming filter; slightly stronger than 81D", [215, 185, 150]],
                    ["82", "blue", "cooling filter; raises color temperature 100K", [150, 205, 240]],
                    ["82A", "pale blue", "cooling filter; opposite of 81A", [205, 225, 235]],
                    ["82B", "pale blue", "cooling filter; opposite of 81B", [155, 190, 220]],
                    ["82C", "pale blue", "cooling filter; opposite of 81C", [120, 155, 190]],
                    ["85", "amber", "warming filter, 5500K to 3400K; converts sunlight to incandescent", [250, 155, 115]],
                    ["85B", "amber", "warming filter, 5500K to 3200K; opposite of 80A", [250, 125, 95]],
                    ["85C", "amber", "warming filter, 5500K to 3800K; opposite of 80C", [250, 155, 115]],
                    ["90", "dark gray amber", "remove color before photographing; rarely used for actual photos", [100, 85, 20]],
                    ["96", "neutral gray", "neutral density filter; equally blocks all light frequencies", [100, 100, 100]]];
    var selected = ' selected';
    for(var i = 0; i < filters.length; i++) {
        var f = filters[i];
        if (i == 1) selected = '';
        $('#photofilter_filters').append('<div id="wratten_'+f[0]+'" class="filter_line'+selected+'"><div title="rgb('+f[3][0]+','+f[3][1]+','+f[3][2]+')" class="filter_pal" style="background-color:rgb('+f[3][0]+','+f[3][1]+','+f[3][2]+');"></div><div class="filter_label"><div class="title">'+f[0]+' '+f[1]+'</div><div class="desc">'+f[2]+'</div></div></div>');
        $('#wratten_'+f[0]).data('color', f[3]);
    }
}

function coltohex(col) {
    var r = col[0].toString(16);
    var g = col[1].toString(16);
    var b = col[2].toString(16);
    if (r.length < 2) r = '0'+r;
    if (g.length < 2) g = '0'+g;
    if (b.length < 2) b = '0'+b; 
    return '#'+r+g+b;
}

function hextocol(hex) {
    var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? [
        parseInt(result[1], 16),
        parseInt(result[2], 16),
        parseInt(result[3], 16)
    ] : null;
}

$(function() {
    $('#dialog_photofilter').Dialog({
        onInit: function() {
            addPhotoFilters();
            $('.filter_line').click(function(e) {
                $('.filter_line.selected').removeClass('selected');
                $(e.delegateTarget).addClass('selected');
                $('#photofilter_color').val(coltohex($('.filter_line.selected').data('color')));
                $('#photofilter_source_wratten').prop('checked', true);
            });
            $('#photofilter_color').click(function(e) {
                $('#photofilter_source_color').prop('checked', true);
            });
            $('#photofilter_source_wratten').click(function () {
                $('#photofilter_color').val(coltohex($('.filter_line.selected').data('color')));
            });
            $('#wratten_1A').click();
            $('#photofilter_density').barInput({Min:1,Max:100,Default:25,Label:'Density'});
        },
        onOpen: function () {
            $('#wratten_1A').click();
            $('#photofilter_filters').scrollTop(0);
        },
        onClose: function() {
            $('#photofilter_lumi').prop('checked', true);
            $('#photofilter_density').barInput('reset');
            $('#wratten_1A').click();
            $('#photofilter_filters').scrollTop(0);
            $('#photofilter_mode').val('overlay');
        },
        onOk: function() {
            makePhotoFilter();
            makeOk("Photo Filter");
        },
        onCancel: function() {
            makeCancel();
        },
        onApply: function () {
            makePhotoFilter();
        },
        onReset: function () {
            $('#photofilter_lumi').prop('checked', true);
            $('#photofilter_density').barInput('reset');
            $('#wratten_1A').click();
            $('#photofilter_filters').scrollTop(0);
            $('#photofilter_mode').val('overlay');
        }
    });
    

});

</script>

    <div class="dialog" id="dialog_photofilter">
        <div class="bar"><div class="caption">Photo Filter</div></div>
        <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div><input type="radio" name="photofilter_source" id="photofilter_source_wratten" value="wratten" checked><label for="photofilter_source_wratten" style="display:inline-block;">&nbsp;Wratten Filter:</label></div>
                    <div id="photofilter_filters" style="margin-left:27px;"></div>
                    <div style="margin-top:10px;"><input type="radio" name="photofilter_source" id="photofilter_source_color" value="color"><label for="photofilter_source_color" style="display:inline-block;">&nbsp;Custom Color:</label></div>
                    <div><input id="photofilter_color" type="color" style="margin-left:27px;" value="#ffffff"></div>
                    <div style="margin-left:27px;" id="photofilter_density"></div>
                    <div style="margin-top:10px;margin-left:27px;"><label for="photofilter_mode" style="display:inline-block;">Blend mode:&nbsp;</label><select id="photofilter_mode"><option value="normal">Normal</option><option value="screen">Screen</option><option value="multiply">Multiply</option><option value="overlay" selected>Overlay</option></select></div>
                    <div style="margin-top:5px;margin-left:27px;"><input type="checkbox" checked id="photofilter_lumi"><label style="display:inline-block;" for="photofilter_lumi">&nbsp;Preserve luminance</label></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
            </div>
        </div>
        </div>
    </div>

    <script>
        $(function() {
            $('#dialog_glow').Dialog({
                onInit: function() {
                    $('#glow_amount').barInput({"Label":"Amount","Min":1,"Max":2,"Default":1.5,"Float":true,"HalfScale":false,"FloatPrecision":2});
                    $('#glow_softening').barInput({"Label":"Softening","Min":0,"Max":150,"Default":0,"Float":false,"HalfScale":false});
                },
                onOpen: function() {
                    $('#dst').attr('src', $('#src').attr('src'));
                    $('#src').hide();
                },
                onClose: function() {
                    $('#src').show();
                    $('#glow_amount').barInput('reset');
                    $('#glow_softening').barInput('reset');
                },
                onOk: function() {
                    IMGlow($('#src'), parseFloat($('#glow_amount input').val()), parseInt($('#glow_softening input').val()), $('#dst'));
                    makeOk('Glow');
                },
                onCancel: function() {
                    makeCancel();
                },
                onApply: function () {
                    IMGlow($('#src'), parseFloat($('#glow_amount input').val()), parseInt($('#glow_softening input').val()), $('#dst'));
                },
                onReset: function () {
                    $('#glow_amount').barInput('reset');
                    $('#glow_softening').barInput('reset');
                    $('#dst').attr('src', $('#src').attr('src'));
                }
            });
        });
    </script>

    <div class="dialog" id="dialog_glow">
        <div class="bar"><div class="caption">Glow</div></div>
        <div class="border">
            <div class="zone">
                <div class="main">
                    <fieldset class="white">
                        <div id="glow_amount"></div>
                        <div id="glow_softening"></div>
                    </fieldset>
                </div>
                <div class="buttons">
                    <button class="btn_ok main" type="button">Ok</button>
                    <button class="btn_cancel" type="button">Cancel</button>
                    <button class="btn_reset" type="button">Reset</button>
                    <button class="btn_apply" type="button">Preview</button>
                    <a href="https://imagemagick.org/" target="_blank"><div class="IM" title="Powered by Image Magick"></div></a>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(function() {
            $('#dialog_watercolor').Dialog({
                onInit: function() {
                    $('#watercolor_edge').barInput({"Label":"Edge","Min":1,"Max":20,"Default":5,"Float":true,"HalfScale":false,"FloatPrecision":2});
                    $('#watercolor_mixing').barInput({"Label":"Mixing","Min":0,"Max":100,"Default":33,"Float":false,"HalfScale":true});
                    $('#watercolor_smoothing').barInput({"Label":"Smoothing","Min":0,"Max":20,"Default":0,"Float":false,"HalfScale":false});
                    $('#watercolor_contrast').barInput({"Label":"Contrast","Min":0,"Max":30,"Default":0,"Float":true,"HalfScale":false,"FloatPrecision":2});
                },
                onOpen: function() {
                    $('#dst').attr('src', $('#src').attr('src'));
                    $('#src').hide();
                },
                onClose: function() {
                    $('#src').show();
                    $('#watercolor_edge').barInput('reset');
                    $('#watercolor_mixing').barInput('reset');
                    $('#watercolor_smoothing').barInput('reset');
                    $('#watercolor_contrast').barInput('reset');
                },
                onOk: function() {
                    IMWatercolor($('#src'), parseInt($('#watercolor_smoothing input').val()), parseFloat($('#watercolor_edge input').val()), parseInt($('#watercolor_mixing input').val()), parseFloat($('#watercolor_contrast input').val()), $('#dst'));
                    makeOk('Watercolor');
                },
                onCancel: function() {
                    makeCancel();
                },
                onApply: function () {
                    IMWatercolor($('#src'), parseInt($('#watercolor_smoothing input').val()), parseFloat($('#watercolor_edge input').val()), parseInt($('#watercolor_mixing input').val()), parseFloat($('#watercolor_contrast input').val()), $('#dst'));
                },
                onReset: function () {
                    $('#watercolor_edge').barInput('reset');
                    $('#watercolor_mixing').barInput('reset');
                    $('#watercolor_smoothing').barInput('reset');
                    $('#watercolor_contrast').barInput('reset');
                    $('#dst').attr('src', $('#src').attr('src'));
                }
            });
        });
    </script>

<script>
    $(function() {
        $('#dialog_disperse').Dialog({
            onInit: function() {
                $('#disperse_spread').barInput({"Label":"Spread","Min":0,"Max":50,"Default":5,"Float":false,"HalfScale":false});
                $('#disperse_density').barInput({"Label":"Density","Min":0,"Max":50,"Default":5,"Float":false,"HalfScale":false});
                $('#disperse_curviness').barInput({"Label":"Curviness","Min":0,"Max":50,"Default":5,"Float":false,"HalfScale":false});
                $('#disperse_seed').barInput({"Label":"Random Seed","Min":0,"Max":200,"Default":0,"Float":false,"HalfScale":false});
            },
            onOpen: function() {
                $('#dst').attr('src', $('#src').attr('src'));
                $('#src').hide();
            },
            onClose: function() {
                $('#src').show();
                $('#disperse_spread').barInput('reset');
                $('#disperse_density').barInput('reset');
                $('#disperse_curviness').barInput('reset');
                $('#disperse_seed').barInput('reset');
            },
            onOk: function() {
                IMDisperse($('#src'), parseInt($('#disperse_spread input').val()), parseInt($('#disperse_density input').val()), parseInt($('#disperse_curviness input').val()), parseInt($('#disperse_seed input').val()), $('#dst'));
                makeOk('Disperse');
            },
            onCancel: function() {
                makeCancel();
            },
            onApply: function () {
                IMDisperse($('#src'), parseInt($('#disperse_spread input').val()), parseInt($('#disperse_density input').val()), parseInt($('#disperse_curviness input').val()), parseInt($('#disperse_seed input').val()), $('#dst'));
            },
            onReset: function () {
                $('#disperse_spread').barInput('reset');
                $('#disperse_density').barInput('reset');
                $('#disperse_curviness').barInput('reset');
                $('#disperse_seed').barInput('reset');
                $('#dst').attr('src', $('#src').attr('src'));
            }
        });
    });
</script>

<div class="dialog" id="dialog_disperse">
    <div class="bar"><div class="caption">Disperse</div></div>
    <div class="border">
        <div class="zone">
            <div class="main">
                <fieldset class="white">
                    <div id="disperse_spread"></div>
                    <div id="disperse_density"></div>
                    <div id="disperse_curviness"></div>
                    <div id="disperse_seed"></div>
                </fieldset>
            </div>
            <div class="buttons">
                <button class="btn_ok main" type="button">Ok</button>
                <button class="btn_cancel" type="button">Cancel</button>
                <button class="btn_reset" type="button">Reset</button>
                <button class="btn_apply" type="button">Preview</button>
                <a href="https://imagemagick.org/" target="_blank"><div class="IM" title="Powered by Image Magick"></div></a>
            </div>
        </div>
    </div>
</div>



    <div class="dialog" id="dialog_watercolor">
        <div class="bar"><div class="caption">Watercolor</div></div>
        <div class="border">
            <div class="zone">
                <div class="main">
                    <fieldset class="white">
                        <div id="watercolor_edge"></div>
                        <div id="watercolor_mixing"></div>
                        <div id="watercolor_smoothing"></div>
                        <div id="watercolor_contrast"></div>
                    </fieldset>
                </div>
                <div class="buttons">
                    <button class="btn_ok main" type="button">Ok</button>
                    <button class="btn_cancel" type="button">Cancel</button>
                    <button class="btn_reset" type="button">Reset</button>
                    <button class="btn_apply" type="button">Preview</button>
                    <a href="https://imagemagick.org/" target="_blank"><div class="IM" title="Powered by Image Magick"></div></a>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(function() {
            $('#dialog_crystallize').Dialog({
                onInit: function() {
                    $('#crystallize_number').barInput({"Label":"Number","Min":25,"Max":5000,"Default":500,"Float":false,"HalfScale":false});
                    $('#crystallize_seed').barInput({"Label":"Seed","Min":0,"Max":200,"Default":0,"Float":false,"HalfScale":false});
                },
                onOpen: function() {
                    $('#dst').attr('src', $('#src').attr('src'));
                    $('#src').hide();
                },
                onClose: function() {
                    $('#src').show();
                    $('#crystallize_number').barInput('reset');
                    $('#crystallize_seed').barInput('reset');
                },
                onOk: function() {
                    IMCrystallize($('#src'), parseInt($('#crystallize_number input').val()), parseInt($('#crystallize_seed input').val()), $('#dst'));
                    makeOk('Crystallize');
                },
                onCancel: function() {
                    makeCancel();
                },
                onApply: function () {
                    IMCrystallize($('#src'), parseInt($('#crystallize_number input').val()), parseInt($('#crystallize_seed input').val()), $('#dst'));
                },
                onReset: function () {
                    $('#crystallize_number').barInput('reset');
                    $('#crystallize_seed').barInput('reset');
                    $('#dst').attr('src', $('#src').attr('src'));
                }
            });
        });
    </script>

    <div class="dialog" id="dialog_crystallize">
        <div class="bar"><div class="caption">Crystallize</div></div>
        <div class="border">
            <div class="zone">
                <div class="main">
                    <fieldset class="white">
                        <div id="crystallize_number"></div>
                        <div id="crystallize_seed"></div>
                    </fieldset>
                </div>
                <div class="buttons">
                    <button class="btn_ok main" type="button">Ok</button>
                    <button class="btn_cancel" type="button">Cancel</button>
                    <button class="btn_reset" type="button">Reset</button>
                    <button class="btn_apply" type="button">Preview</button>
                    <a href="https://imagemagick.org/" target="_blank"><div class="IM" title="Powered by Image Magick"></div></a>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(function() {
            $('#dialog_softlight').Dialog({
                onInit: function() {
                    $('#softlight_intensity').barInput({"Label":"Intensity","Min":0,"Max":200,"Default":80,"Float":false,"HalfScale":false});
                    $('#softlight_smooth').barInput({"Label":"Smooth","Min":0,"Max":500,"Default":50,"Float":false,"HalfScale":false});
                    $('#softlight_percent').barInput({"Label":"Percent","Min":0,"Max":100,"Default":5,"Float":false,"HalfScale":false});
                    $('#softlight_color').val('#ffffff');
                },
                onOpen: function() {
                    $('#dst').attr('src', $('#src').attr('src'));
                    $('#src').hide();
                },
                onClose: function() {
                    $('#src').show();
                    $('#softlight_intensity').barInput('reset');
                    $('#softlight_smooth').barInput('reset');
                    $('#softlight_percent').barInput('reset');
                    $('#softlight_color').val('#ffffff');
                },
                onOk: function() {
                    IMSoftLight($('#src'), parseInt($('#softlight_intensity input').val()), parseInt($('#softlight_smooth input').val()), parseInt($('#softlight_percent input').val()), $('#softlight_color').val(), $('#dst'));
                    makeOk('Soft light');
                },
                onCancel: function() {
                    makeCancel();
                },
                onApply: function () {
                    IMSoftLight($('#src'), parseInt($('#softlight_intensity input').val()), parseInt($('#softlight_smooth input').val()), parseInt($('#softlight_percent input').val()), $('#softlight_color').val(), $('#dst'));
                },
                onReset: function () {
                    $('#softlight_intensity').barInput('reset');
                    $('#softlight_smooth').barInput('reset');
                    $('#softlight_percent').barInput('reset');
                    $('#softlight_color').val('#ffffff');
                    $('#dst').attr('src', $('#src').attr('src'));
                }
            });
        });
    </script>

    <div class="dialog" id="dialog_softlight">
        <div class="bar"><div class="caption">Soft light</div></div>
        <div class="border">
            <div class="zone">
                <div class="main">
                    <fieldset class="white">
                        <div id="softlight_intensity"></div>
                        <div id="softlight_smooth"></div>
                        <div id="softlight_percent"></div>
                        <div style="margin-top:5px;"><label for="softlight_color" style="display:inline-block;margin-right:7px;">Color</label><input id="softlight_color" type="color" /></div>
                    </fieldset>
                </div>
                <div class="buttons">
                    <button class="btn_ok main" type="button">Ok</button>
                    <button class="btn_cancel" type="button">Cancel</button>
                    <button class="btn_reset" type="button">Reset</button>
                    <button class="btn_apply" type="button">Preview</button>
                    <a href="https://imagemagick.org/" target="_blank"><div class="IM" title="Powered by Image Magick"></div></a>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(function() {
            $('#dialog_DaveHillEffect').Dialog({
                onInit: function() {
                    $('#DaveHillEffect_brightness').barInput({"Label":"Brightness","Min":0,"Max":2,"Default":1,"Float":true,"HalfScale":false,"FloatPrecision":2});
                    $('#DaveHillEffect_contrast').barInput({"Label":"Contrast","Min":-10,"Max":10,"Default":0,"Float":true,"HalfScale":true,"FloatPrecision":2});
                    $('#DaveHillEffect_gain').barInput({"Label":"Gain","Min":0,"Max":100,"Default":40,"Float":false,"HalfScale":false});
                },
                onOpen: function() {
                    $('#dst').attr('src', $('#src').attr('src'));
                    $('#src').hide();
                },
                onClose: function() {
                    $('#src').show();
                    $('#DaveHillEffect_brightness').barInput('reset');
                    $('#DaveHillEffect_contrast').barInput('reset');
                    $('#DaveHillEffect_gain').barInput('reset');
                },
                onOk: function() {
                    IMDaveHillEffect($('#src'), parseFloat($('#DaveHillEffect_brightness input').val()), parseFloat($('#DaveHillEffect_contrast input').val()), parseInt($('#DaveHillEffect_gain input').val()), $('#dst'));
                    makeOk('Dave Hill Effect');
                },
                onCancel: function() {
                    makeCancel();
                },
                onApply: function () {
                    IMDaveHillEffect($('#src'), parseFloat($('#DaveHillEffect_brightness input').val()), parseFloat($('#DaveHillEffect_contrast input').val()), parseInt($('#DaveHillEffect_gain input').val()), $('#dst'));
                },
                onReset: function () {
                    $('#DaveHillEffect_brightness').barInput('reset');
                    $('#DaveHillEffect_contrast').barInput('reset');
                    $('#DaveHillEffect_gain').barInput('reset');
                    $('#dst').attr('src', $('#src').attr('src'));
                }
            });
        });
    </script>

    <div class="dialog" id="dialog_DaveHillEffect">
        <div class="bar"><div class="caption">Dave Hill Effect</div></div>
        <div class="border">
            <div class="zone">
                <div class="main">
                    <fieldset class="white">
                        <div id="DaveHillEffect_brightness"></div>
                        <div id="DaveHillEffect_contrast"></div>
                        <div id="DaveHillEffect_gain"></div>
                    </fieldset>
                </div>
                <div class="buttons">
                    <button class="btn_ok main" type="button">Ok</button>
                    <button class="btn_cancel" type="button">Cancel</button>
                    <button class="btn_reset" type="button">Reset</button>
                    <button class="btn_apply" type="button">Preview</button>
                    <a href="https://imagemagick.org/" target="_blank"><div class="IM" title="Powered by Image Magick"></div></a>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(function() {
            $('#dialog_frosted').Dialog({
                onInit: function() {
                    $('#frosted_spread').barInput({"Label":"Spread","Min":0,"Max":50,"Default":5,"Float":false,"HalfScale":false});
                    $('#frosted_blur').barInput({"Label":"Blur","Min":0,"Max":50,"Default":5,"Float":false,"HalfScale":false});
                    $('#frosted_seed').barInput({"Label":"Seed","Min":0,"Max":200,"Default":0,"Float":false,"HalfScale":false});
                },
                onOpen: function() {
                    $('#dst').attr('src', $('#src').attr('src'));
                    $('#src').hide();
                },
                onClose: function() {
                    $('#src').show();
                    $('#frosted_spread').barInput('reset');
                    $('#frosted_blur').barInput('reset');
                    $('#frosted_seed').barInput('reset');
                },
                onOk: function() {
                    IMFrosted($('#src'), parseInt($('#frosted_spread input').val()), parseInt($('#frosted_blur input').val()), parseInt($('#frosted_seed input').val()), $('#dst'));
                    makeOk('Frosted');
                },
                onCancel: function() {
                    makeCancel();
                },
                onApply: function () {
                    IMFrosted($('#src'), parseInt($('#frosted_spread input').val()), parseInt($('#frosted_blur input').val()), parseInt($('#frosted_seed input').val()), $('#dst'));
                },
                onReset: function () {
                    $('#frosted_spread').barInput('reset');
                    $('#frosted_blur').barInput('reset');
                    $('#frosted_seed').barInput('reset');
                    $('#dst').attr('src', $('#src').attr('src'));
                }
            });
        });
    </script>

    <div class="dialog" id="dialog_frosted">
        <div class="bar"><div class="caption">Frosted</div></div>
        <div class="border">
            <div class="zone">
                <div class="main">
                    <fieldset class="white">
                        <div id="frosted_spread"></div>
                        <div id="frosted_blur"></div>
                        <div id="frosted_seed"></div>
                    </fieldset>
                </div>
                <div class="buttons">
                    <button class="btn_ok main" type="button">Ok</button>
                    <button class="btn_cancel" type="button">Cancel</button>
                    <button class="btn_reset" type="button">Reset</button>
                    <button class="btn_apply" type="button">Preview</button>
                    <a href="https://imagemagick.org/" target="_blank"><div class="IM" title="Powered by Image Magick"></div></a>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(function() {
            $('#dialog_LucisArtEffect').Dialog({
                onInit: function() {
                    $('#LucisArtEffect_gain').barInput({"Label":"Gain","Min":0,"Max":2,"Default":0.3,"Float":true,"HalfScale":false,"FloatPrecision":2});
                    $('#LucisArtEffect_saturation').barInput({"Label":"Saturation","Min":0,"Max":200,"Default":60,"Float":false,"HalfScale":false});
                },
                onOpen: function() {
                    $('#dst').attr('src', $('#src').attr('src'));
                    $('#src').hide();
                },
                onClose: function() {
                    $('#src').show();
                    $('#LucisArtEffect_gain').barInput('reset');
                    $('#LucisArtEffect_saturation').barInput('reset');
                },
                onOk: function() {
                    IMLucisArtEffect($('#src'), parseFloat($('#LucisArtEffect_gain input').val()), parseInt($('#LucisArtEffect_saturation input').val()), $('#dst'));
                    makeOk('Lucis Art Effect');
                },
                onCancel: function() {
                    makeCancel();
                },
                onApply: function () {
                    IMLucisArtEffect($('#src'), parseFloat($('#LucisArtEffect_gain input').val()), parseInt($('#LucisArtEffect_saturation input').val()), $('#dst'));
                },
                onReset: function () {
                    $('#LucisArtEffect_gain').barInput('reset');
                    $('#LucisArtEffect_saturation').barInput('reset');
                    $('#dst').attr('src', $('#src').attr('src'));
                }
            });
        });
    </script>

    <div class="dialog" id="dialog_LucisArtEffect">
        <div class="bar"><div class="caption">Lucis Art Effect</div></div>
        <div class="border">
            <div class="zone">
                <div class="main">
                    <fieldset class="white">
                        <div id="LucisArtEffect_gain"></div>
                        <div id="LucisArtEffect_saturation"></div>
                    </fieldset>
                </div>
                <div class="buttons">
                    <button class="btn_ok main" type="button">Ok</button>
                    <button class="btn_cancel" type="button">Cancel</button>
                    <button class="btn_reset" type="button">Reset</button>
                    <button class="btn_apply" type="button">Preview</button>
                    <a href="https://imagemagick.org/" target="_blank"><div class="IM" title="Powered by Image Magick"></div></a>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(function() {
            $('#dialog_ShadowHighlight').Dialog({
                onInit: function() {
                    $('#ShadowHighlight_samount').barInput({"Label":"Shadow amount","Min":0,"Max":100,"Default":50,"Float":false,"HalfScale":false});
                    $('#ShadowHighlight_swidth').barInput({"Label":"Shadow width","Min":0,"Max":100,"Default":50,"Float":false,"HalfScale":false});
                    $('#ShadowHighlight_sradius').barInput({"Label":"Shadow radius","Min":0,"Max":100,"Default":30,"Float":false,"HalfScale":false});
                    $('#ShadowHighlight_hamount').barInput({"Label":"Highlight amount","Min":0,"Max":100,"Default":0,"Float":false,"HalfScale":false});
                    $('#ShadowHighlight_hwidth').barInput({"Label":"Highlight width","Min":0,"Max":100,"Default":50,"Float":false,"HalfScale":false});
                    $('#ShadowHighlight_hradius').barInput({"Label":"Highlight radius","Min":0,"Max":100,"Default":30,"Float":false,"HalfScale":false});
                    $('#ShadowHighlight_mamount').barInput({"Label":"Midtone amount","Min":-100,"Max":100,"Default":0,"Float":false,"HalfScale":true});
                    $('#ShadowHighlight_ccamount').barInput({"Label":"Color correction","Min":-100,"Max":100,"Default":0,"Float":false,"HalfScale":true});
                    $('#ShadowHighlight_bclip').barInput({"Label":"Black clip","Min":0,"Max":100,"Default":0.01,"Float":true,"HalfScale":false,"FloatPrecision":2});
                    $('#ShadowHighlight_wclip').barInput({"Label":"White clip","Min":0,"Max":100,"Default":0.01,"Float":true,"HalfScale":false,"FloatPrecision":2});
                },
                onOpen: function() {
                    $('#dst').attr('src', $('#src').attr('src'));
                    $('#src').hide();
                },
                onClose: function() {
                    $('#src').show();
                    $('#ShadowHighlight_samount').barInput('reset');
                    $('#ShadowHighlight_swidth').barInput('reset');
                    $('#ShadowHighlight_sradius').barInput('reset');
                    $('#ShadowHighlight_hamount').barInput('reset');
                    $('#ShadowHighlight_hwidth').barInput('reset');
                    $('#ShadowHighlight_hradius').barInput('reset');
                    $('#ShadowHighlight_mamount').barInput('reset');
                    $('#ShadowHighlight_ccamount').barInput('reset');
                    $('#ShadowHighlight_bclip').barInput('reset');
                    $('#ShadowHighlight_wclip').barInput('reset');
                },
                onOk: function() {
                    IMShadowHighlight($('#src'), parseInt($('#ShadowHighlight_samount input').val()), parseInt($('#ShadowHighlight_swidth input').val()), parseInt($('#ShadowHighlight_sradius input').val()), parseInt($('#ShadowHighlight_hamount input').val()), parseInt($('#ShadowHighlight_hwidth input').val()), parseInt($('#ShadowHighlight_hradius input').val()), parseInt($('#ShadowHighlight_mamount input').val()), parseInt($('#ShadowHighlight_ccamount input').val()), parseFloat($('#ShadowHighlight_bclip input').val()), parseFloat($('#ShadowHighlight_wclip input').val()), $('#dst'));
                    makeOk('Shadow and highlight');
                },
                onCancel: function() {
                    makeCancel();
                },
                onApply: function () {
                    IMShadowHighlight($('#src'), parseInt($('#ShadowHighlight_samount input').val()), parseInt($('#ShadowHighlight_swidth input').val()), parseInt($('#ShadowHighlight_sradius input').val()), parseInt($('#ShadowHighlight_hamount input').val()), parseInt($('#ShadowHighlight_hwidth input').val()), parseInt($('#ShadowHighlight_hradius input').val()), parseInt($('#ShadowHighlight_mamount input').val()), parseInt($('#ShadowHighlight_ccamount input').val()), parseFloat($('#ShadowHighlight_bclip input').val()), parseFloat($('#ShadowHighlight_wclip input').val()), $('#dst'));
                },
                onReset: function () {
                    $('#ShadowHighlight_samount').barInput('reset');
                    $('#ShadowHighlight_swidth').barInput('reset');
                    $('#ShadowHighlight_sradius').barInput('reset');
                    $('#ShadowHighlight_hamount').barInput('reset');
                    $('#ShadowHighlight_hwidth').barInput('reset');
                    $('#ShadowHighlight_hradius').barInput('reset');
                    $('#ShadowHighlight_mamount').barInput('reset');
                    $('#ShadowHighlight_ccamount').barInput('reset');
                    $('#ShadowHighlight_bclip').barInput('reset');
                    $('#ShadowHighlight_wclip').barInput('reset');
                    $('#dst').attr('src', $('#src').attr('src'));
                }
            });
        });
    </script>

    <div class="dialog" id="dialog_ShadowHighlight">
        <div class="bar"><div class="caption">Shadow and highlight</div></div>
        <div class="border">
            <div class="zone">
                <div class="main">
                    <fieldset class="white">
                        <div id="ShadowHighlight_samount"></div>
                        <div id="ShadowHighlight_swidth"></div>
                        <div id="ShadowHighlight_sradius"></div>
                        <div id="ShadowHighlight_hamount"></div>
                        <div id="ShadowHighlight_hwidth"></div>
                        <div id="ShadowHighlight_hradius"></div>
                        <div id="ShadowHighlight_mamount"></div>
                        <div id="ShadowHighlight_ccamount"></div>
                        <div id="ShadowHighlight_bclip"></div>
                        <div id="ShadowHighlight_wclip"></div>
                    </fieldset>
                </div>
                <div class="buttons">
                    <button class="btn_ok main" type="button">Ok</button>
                    <button class="btn_cancel" type="button">Cancel</button>
                    <button class="btn_reset" type="button">Reset</button>
                    <button class="btn_apply" type="button">Preview</button>
                    <a href="https://imagemagick.org/" target="_blank"><div class="IM" title="Powered by Image Magick"></div></a>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(function() {
            $('#dialog_ExportToJpeg').Dialog({
                onInit: function() {
                    $('#ExportToJpeg_quality').barInput({"Label":"Quality","Min":0,"Max":100,"Default":80,"Float":false,"HalfScale":false});
                },
                onClose: function() {
                    $('#src').show();
                    $('#ExportToJpeg_name').val('exported');
                    $('#ExportToJpeg_quality').barInput('reset');
                },
                onOk: function() {
                    exportToJpeg();
                },
                onCancel: function() {

                },
                onReset: function () {
                    $('#ExportToJpeg_name').val('exported');
                    $('#ExportToJpeg_quality').barInput('reset');
                }
            });
        });
    </script>

    <div class="dialog" id="dialog_ExportToJpeg">
        <div class="bar"><div class="caption">Export to browser native JPEG</div></div>
        <div class="border">
            <div class="zone">
                <div class="main">
                    <fieldset class="white">
                        <div><label for="ExportToJpeg_name" style="display:inline-block;margin-right:7px;">File name</label><input id="ExportToJpeg_name" type="text" style="outline:none;margin-right: 3px;" value="exported">.jpg</div>
                        <div id="ExportToJpeg_quality"></div>
                    </fieldset>
                </div>
                <div class="buttons">
                    <button class="btn_ok main" type="button">Export</button>
                    <button class="btn_cancel" type="button">Cancel</button>
                    <button class="btn_reset" type="button">Reset</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(function() {
            $('#dialog_ExportToWebp').Dialog({
                onInit: function() {
                    $('#ExportToWebp_quality').barInput({"Label":"Quality","Min":0,"Max":100,"Default":80,"Float":false,"HalfScale":false});
                },
                onClose: function() {
                    $('#src').show();
                    $('#ExportToWebp_name').val('exported');
                    $('#ExportToWebp_quality').barInput('reset');
                },
                onOk: function() {
                    exportToWebp();
                },
                onCancel: function() {

                },
                onReset: function () {
                    $('#ExportToWebp_name').val('exported');
                    $('#ExportToWebp_quality').barInput('reset');
                }
            });
        });
    </script>

    <div class="dialog" id="dialog_ExportToWebp">
        <div class="bar"><div class="caption">Export to browser native WEBP</div></div>
        <div class="border">
            <div class="zone">
                <div class="main">
                    <fieldset class="white">
                        <div><label for="ExportToWebp_name" style="display:inline-block;margin-right:7px;">File name</label><input id="ExportToWebp_name" type="text" style="outline:none;margin-right: 3px;" value="exported">.webp</div>
                        <div id="ExportToWebp_quality"></div>
                    </fieldset>
                </div>
                <div class="buttons">
                    <button class="btn_ok main" type="button">Export</button>
                    <button class="btn_cancel" type="button">Cancel</button>
                    <button class="btn_reset" type="button">Reset</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(function() {
            $('#dialog_ExportToPng').Dialog({
                onInit: function() {
                },
                onClose: function() {
                    $('#src').show();
                    $('#ExportToPng_name').val('exported');
                },
                onOk: function() {
                    exportToPng();
                },
                onCancel: function() {

                },
                onReset: function () {
                    $('#ExportToPng_name').val('exported');
                }
            });
        });
    </script>

    <div class="dialog" id="dialog_ExportToPng">
        <div class="bar"><div class="caption">Export to browser native PNG</div></div>
        <div class="border">
            <div class="zone">
                <div class="main">
                    <fieldset class="white">
                        <div><label for="ExportToPng_name" style="display:inline-block;margin-right:7px;">File name</label><input id="ExportToPng_name" type="text" style="outline:none;margin-right: 3px;" value="exported">.png</div>
                    </fieldset>
                </div>
                <div class="buttons">
                    <button class="btn_ok main" type="button">Export</button>
                    <button class="btn_cancel" type="button">Cancel</button>
                    <button class="btn_reset" type="button">Reset</button>
                </div>
            </div>
        </div>
    </div>

    <div id="containment"><img id="src"><img id="dst"><div id="grid" class="disabled"></div></div>
</div>
<div id="statusbar"><span class="zoomtools" style="display:none;">Zoom: <select id="zoom"></select><button id="fitButton" type="button">Fit</button><button id="zoom100Button" type="button">100%</button></span><span class="dimensions"></span></div>
</body>
</html>
